<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Scripts Training - Power Choosers CRM</title>
    <link rel="stylesheet" href="styles/training-tool-animations.css">
    <style>
        :root {
            --orange-primary: #ff6b35;
            --orange-subtle: rgba(255, 107, 53, 0.1);
            --bg-container: #1a1a1a;
            --bg-card: #252525;
            --bg-item: #2d2d2d;
            --bg-secondary: #353535;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --text-muted: #808080;
            --text-inverse: #ffffff;
            --grey-400: #b3b3b3;
            --border-light: #404040;
            --border-radius: 8px;
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-base: 12px;
            --transition-fast: 0.2s ease;
            --elevation-card: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        html {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-container);
            color: var(--text-primary);
            line-height: 1.5;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        .training-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            padding: var(--spacing-lg);
            padding-bottom: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            width: 100%;
        }

        .page-header {
            margin-bottom: var(--spacing-md);
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: var(--spacing-md);
        }

        /* Custom Scrollbar Styling - Desktop Only */
        @media (min-width: 768px) {
            /* Webkit browsers (Chrome, Safari, Edge) */
            .script-display::-webkit-scrollbar,
            .tips-panel::-webkit-scrollbar,
            .main-content::-webkit-scrollbar {
                width: 8px;
            }
            
            .script-display::-webkit-scrollbar-track,
            .tips-panel::-webkit-scrollbar-track,
            .main-content::-webkit-scrollbar-track {
                background: var(--bg-container);
                border-radius: 4px;
            }
            
            .script-display::-webkit-scrollbar-thumb,
            .tips-panel::-webkit-scrollbar-thumb,
            .main-content::-webkit-scrollbar-thumb {
                background: #3a3a3a;
                border-radius: 4px;
                border: 1px solid var(--bg-container);
            }
            
            .script-display::-webkit-scrollbar-thumb:hover,
            .tips-panel::-webkit-scrollbar-thumb:hover,
            .main-content::-webkit-scrollbar-thumb:hover {
                background: #4a4a4a;
            }
            
            /* Firefox */
            .script-display,
            .tips-panel,
            .main-content {
                scrollbar-width: thin;
                scrollbar-color: #3a3a3a var(--bg-container);
            }
        }

        .script-display {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            flex: 1 1 auto;
            overflow-y: auto;
            line-height: 1.6;
            color: var(--text-primary);
            font-size: 1.15rem;
            margin-bottom: var(--spacing-md);
            transition: height 0.3s ease;
            min-height: 0;
        }

        .script-display .script-highlight {
            color: var(--orange-primary);
            font-weight: 500;
            display: block;
            margin-top: var(--spacing-sm);
        }

        .name-badge {
            display: inline-block;
            background: var(--orange-subtle);
            color: var(--orange-primary);
            border: 1px solid var(--orange-primary);
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 0.9em;
            font-weight: 600;
            margin: 0 2px;
            vertical-align: baseline;
        }

        .badge.contact {
            display: inline-block;
            background: var(--orange-subtle);
            color: var(--orange-primary);
            border: 1px solid var(--orange-primary);
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 0.9em;
            font-weight: 600;
            margin: 0 2px;
            vertical-align: baseline;
        }

        .badge.company {
            display: inline-block;
            background: var(--orange-subtle);
            color: var(--orange-primary);
            border: 1px solid var(--orange-primary);
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 0.9em;
            font-weight: 600;
            margin: 0 2px;
            vertical-align: baseline;
        }

        .tone-marker {
            display: inline-block;
            padding: 3px 8px;
            font-size: 0.85em;
            font-weight: 600;
            margin: 0 4px;
            border-radius: 4px;
            border: 1px solid;
            vertical-align: baseline;
        }

        /* Color-coded tone badges */
        .tone-marker.curious {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
            border-color: #3b82f6;
        }

        .tone-marker.concerned {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border-color: #ef4444;
        }

        .tone-marker.confident {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            border-color: #10b981;
        }

        .tone-marker.serious {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
            border-color: #8b5cf6;
        }

        .tone-marker.understanding {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
            border-color: #fbbf24;
        }

        .tone-marker.hopeful {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
            border-color: #22c55e;
        }

        .tone-marker.professional {
            background: rgba(107, 114, 128, 0.15);
            color: #6b7280;
            border-color: #6b7280;
        }

        .tone-marker.friendly {
            background: rgba(249, 115, 22, 0.15);
            color: #f97316;
            border-color: #f97316;
        }

        /* Tone badge for guide */
        .tone-badge {
            display: inline-block;
            padding: 3px 8px;
            font-size: 0.85em;
            font-weight: 600;
            margin: 0 4px 4px 0;
            border-radius: 4px;
            border: 1px solid;
        }

        .tone-badge.curious {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
            border-color: #3b82f6;
        }

        .tone-badge.concerned {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border-color: #ef4444;
        }

        .tone-badge.confident {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            border-color: #10b981;
        }

        .tone-badge.serious {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
            border-color: #8b5cf6;
        }

        .tone-badge.understanding {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
            border-color: #fbbf24;
        }

        .tone-badge.professional {
            background: rgba(107, 114, 128, 0.15);
            color: #6b7280;
            border-color: #6b7280;
        }

        .tone-badge.friendly {
            background: rgba(249, 115, 22, 0.15);
            color: #f97316;
            border-color: #f97316;
        }

        .pause-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: var(--orange-primary);
            border-radius: 50%;
            margin: 0 4px;
            opacity: 0.6;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .response-buttons-container {
            position: sticky;
            bottom: 0;
            background: var(--bg-container);
            border-top: 1px solid var(--border-light);
            padding: var(--spacing-md) var(--spacing-lg);
            margin-top: auto;
            margin-left: calc(-1 * var(--spacing-lg));
            margin-right: calc(-1 * var(--spacing-lg));
            padding-left: var(--spacing-lg);
            padding-right: var(--spacing-lg);
            flex-shrink: 0;
        }

        .response-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: 0;
        }

        .response-buttons.full-width {
            display: block;
        }

        .dial-btn,
        .response-btn {
            background: var(--orange-primary);
            color: var(--text-primary);
            border: none;
            border-radius: var(--border-radius);
            padding: 12px 20px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
            flex: 1;
            min-width: 150px;
        }

        .response-buttons.full-width .dial-btn,
        .response-buttons.full-width .response-btn {
            width: 100%;
        }

        .dial-btn:hover,
        .response-btn:hover {
            background: #e55a2a;
            transform: translateY(-1px);
        }

        /* Click animation removed - keeping only hover effects */

        .toolbar {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: 0;
        }

        .action-btn {
            background: var(--bg-item);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: 8px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .action-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--orange-primary);
            color: var(--text-inverse);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .phase-navigation {
            display: flex;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
            flex-wrap: nowrap;
            padding: var(--spacing-sm);
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            cursor: default;
            position: relative;
            overflow: hidden;
            min-height: 54px;
            height: 54px;
            align-items: center;
            box-sizing: border-box;
        }
        
        /* Desktop: Gradient overlay on navigation bar behind active button */
        @media (min-width: 768px) {
            .phase-navigation::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(
                    90deg,
                    transparent 0%,
                    rgba(255, 107, 53, 0.08) 15%,
                    rgba(255, 107, 53, 0.12) 30%,
                    rgba(255, 107, 53, 0.15) 50%,
                    rgba(255, 107, 53, 0.12) 70%,
                    rgba(255, 107, 53, 0.08) 85%,
                    transparent 100%
                );
                pointer-events: none;
                z-index: 0;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            
            .phase-navigation:has(.phase-btn.active)::before {
                opacity: 1;
            }
            
            /* Ensure buttons are above gradient */
            .phase-btn {
                position: relative;
                z-index: 1;
            }
        }

        .phase-btn {
            flex: 1;
            padding: 8px 14px;
            border: 1px solid var(--border-light);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: var(--border-radius);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
            white-space: nowrap;
            min-width: 0;
            min-height: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }

        .phase-btn:hover {
            background: var(--bg-card);
            color: var(--text-primary);
            border-color: var(--orange-primary);
        }

        .phase-btn.active {
            background: var(--orange-primary);
            color: var(--text-inverse);
            border-color: var(--orange-primary);
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        .phase-btn.completed {
            background: var(--orange-subtle);
            color: var(--orange-primary);
            border-color: var(--orange-primary);
        }

        .phase-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .opener-selector {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
            justify-content: flex-end;
        }

        .opener-buttons-container {
            display: flex;
            flex-direction: row;
            gap: var(--spacing-sm);
            align-items: center;
        }

        .opener-label {
            font-size: 0.9rem;
            color: var(--text-primary);
            font-weight: 500;
            margin-right: var(--spacing-sm);
            padding-right: var(--spacing-sm);
            border-right: 1px solid var(--border-light);
            white-space: nowrap;
        }

        .opener-btn {
            background: var(--bg-item);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
            text-align: center;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .opener-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--orange-primary);
            color: var(--text-inverse);
        }

        .opener-btn.active {
            background: var(--orange-primary);
            border-color: var(--orange-primary);
            color: var(--text-primary);
            font-weight: 600;
        }

        .toolbar-with-openers {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            gap: var(--spacing-md);
        }

        /* Tips Panel */
        .tips-panel {
            width: 320px;
            background: var(--bg-card);
            border-left: 1px solid var(--border-light);
            padding: var(--spacing-md);
            overflow-y: auto;
            height: 100vh;
            flex-shrink: 0;
        }

        .tips-header {
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-light);
        }

        .tips-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .tips-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .tip-card {
            background: var(--bg-item);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            border-left: 3px solid var(--orange-primary);
            transition: var(--transition-fast);
        }

        .tip-card:hover {
            background: var(--bg-secondary);
            border-left-color: var(--orange-primary);
            transform: translateX(2px);
        }

        .tip-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-xs);
        }

        .tip-icon {
            width: 20px;
            height: 20px;
            color: var(--orange-primary);
            flex-shrink: 0;
        }

        .tip-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .tip-content {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-top: var(--spacing-xs);
        }

        /* Tonality Guide Specific Styles */
        .tonality-guide {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .tone-item {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            min-width: 0;
        }

        .tone-item .tone-badge {
            flex-shrink: 0;
            margin: 0;
        }

        .tone-desc {
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .tip-category {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--orange-primary);
            margin-top: var(--spacing-xs);
            padding: 2px 6px;
            background: var(--orange-subtle);
            border-radius: 4px;
        }

        .brand-header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-light);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            border-radius: var(--border-radius);
        }

        .brand-logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--orange-primary);
            margin-bottom: var(--spacing-xs);
        }

        .brand-tagline {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Mobile Tips Toggle Button */
        .mobile-tips-toggle {
            display: none;
            width: 100%;
            padding: 16px;
            background: var(--orange-primary);
            color: var(--text-primary);
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            text-align: center;
            margin-top: 12px;
            border-radius: var(--border-radius);
            transition: var(--transition-fast);
            -webkit-tap-highlight-color: rgba(255, 107, 53, 0.2);
        }

        .mobile-tips-toggle:active {
            background: #e55a2a;
            transform: scale(0.98);
        }

        /* Desktop Layout (Default) */
        @media (min-width: 1024px) {
            .training-container {
                display: flex;
                flex-direction: row;
                height: 100vh;
                width: 100vw;
                overflow: hidden;
                gap: 0;
            }
            
            .main-content {
                flex: 1;
                max-width: none;
                height: 100vh;
                padding: var(--spacing-lg);
                padding-bottom: 0;
                overflow-y: auto;
            }
            
            .tips-panel {
                width: 320px;
                display: block;
                height: 100vh;
                border-left: 1px solid var(--border-light);
                border-top: none;
                flex-shrink: 0;
                overflow-y: auto;
                margin-left: 0;
            }
            
            .training-container {
                margin: 0;
                padding: 0;
            }
        }

        /* Tablet Layout */
        @media (min-width: 768px) and (max-width: 1023px) {
            .training-container {
                flex-direction: row;
            }
            
            .main-content {
                flex: 1;
                padding: 24px;
            }
            
            .tips-panel {
                width: 280px;
                display: block;
                padding: 16px;
            }
        }

        /* Mobile Layout - Vertical Stack */
        @media (max-width: 767px) {
            body {
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
            }

            .training-container {
                display: flex;
                flex-direction: column;
                min-height: 100vh;
                overflow-x: hidden;
            }
            
            .main-content {
                flex: 1;
                padding: 20px 16px;
                max-width: 100%;
                order: 1;
                height: auto;
                min-height: calc(100vh - 60px);
                overflow-y: auto;
            }
            
            .training-container {
                height: 100vh;
                overflow: hidden;
            }
            
            .tips-panel {
                width: 100%;
                border-left: none;
                border-top: 2px solid var(--border-light);
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.4s ease;
                order: 2;
                padding: 0;
                position: relative;
                background: var(--bg-card);
            }
            
            .tips-panel.expanded {
                max-height: 600px;
                overflow-y: auto;
                padding: 20px 16px;
            }

            .mobile-tips-toggle {
                display: block;
            }

            /* Mobile Header */
            .brand-header {
                padding: 16px;
                margin-bottom: 16px;
            }

            .brand-logo {
                font-size: 1.25rem;
            }

            .page-header {
                margin-bottom: 20px;
                text-align: center;
            }

            .page-title {
                font-size: 1.5rem;
                margin-bottom: 8px;
            }

            .page-subtitle {
                font-size: 0.9rem;
                margin-bottom: 16px;
            }

            /* Mobile Toolbar */
            .toolbar-with-openers {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .toolbar {
                display: flex;
                gap: 8px;
            }

            .opener-selector {
                width: 100%;
                flex-direction: column;
                align-items: stretch;
            }

            .opener-label {
                border-right: none;
                border-bottom: 1px solid var(--border-light);
                padding-bottom: 8px;
                margin-bottom: 8px;
                margin-right: 0;
            }

            .opener-buttons-container {
                flex-direction: column;
                gap: 8px;
            }

            .opener-btn {
                width: 100%;
                padding: 12px 16px;
            }

            /* Stage Indicator */
            .stage-indicator {
                position: sticky;
                top: 0;
                z-index: 50;
                margin-bottom: 16px;
                font-size: 0.85rem;
                padding: 10px 12px;
            }

            /* Script Display */
            .script-display {
                font-size: 1rem;
                padding: 20px;
                min-height: 200px;
                line-height: 1.8;
                word-spacing: 0.1em;
                letter-spacing: 0.5px;
            }

            .script-text {
                line-height: 1.8;
                word-spacing: 0.1em;
            }

            /* Pause Indicators */
            .pause-indicator {
                width: 6px;
                height: 6px;
                margin: 2px 4px;
            }

            /* Badges */
            .badge, .name-badge {
                padding: 3px 8px;
                font-size: 0.8em;
                margin: 2px 1px;
                word-break: break-word;
            }

            /* Tone Markers */
            .tone-marker {
                font-size: 0.85em;
                margin: 1px 2px;
                padding: 2px 6px;
            }
            
            .tone-badge {
                font-size: 0.8em;
                padding: 2px 6px;
                margin: 0 3px 3px 0;
            }

            /* Buttons - Touch Friendly */
            .response-buttons-container {
                position: sticky;
                bottom: 0;
                margin-left: calc(-1 * 16px);
                margin-right: calc(-1 * 16px);
                padding-left: 16px;
                padding-right: 16px;
            }

            .response-buttons {
                display: grid;
                grid-template-columns: 1fr;
                gap: 10px;
                margin-bottom: 0;
            }

            .response-btn, .dial-btn {
                width: 100%;
                min-height: 50px;
                padding: 16px 20px;
                font-size: 1rem;
                margin-bottom: 0;
                -webkit-tap-highlight-color: rgba(255, 107, 53, 0.2);
            }

            .action-btn {
                flex: 1;
                min-height: 44px;
                padding: 12px 16px;
            }

            /* Mobile Phase Carousel */
            .phase-navigation {
                display: flex;
                overflow-x: auto;
                overflow-y: hidden;
                -webkit-overflow-scrolling: touch;
                scroll-snap-type: x mandatory;
                scroll-padding: 0 100px;
                padding: 20px 100px 20px 100px;
                margin-bottom: 16px;
                margin-left: -16px;
                margin-right: -16px;
                width: calc(100% + 32px);
                gap: 0;
                position: relative;
                scroll-behavior: smooth;
                align-items: center;
                justify-content: flex-start;
            }
            
            /* Gradient shadows for 3D effect - removed black gradient issue */
            .phase-navigation::before,
            .phase-navigation::after {
                content: '';
                position: absolute;
                top: 0;
                bottom: 0;
                width: 60px;
                z-index: 10;
                pointer-events: none;
            }
            
            .phase-navigation::before {
                left: 0;
                background: linear-gradient(to right, var(--bg-container) 0%, transparent 100%);
            }
            
            .phase-navigation::after {
                right: 0;
                background: linear-gradient(to left, var(--bg-container) 0%, transparent 100%);
            }
            
            /* Remove any black gradient blocks inside phase buttons */
            .phase-btn::before,
            .phase-btn::after {
                display: none !important;
            }

            .phase-btn {
                flex: 0 0 auto;
                min-width: 200px;
                width: 200px;
                padding: 12px 20px;
                font-size: 0.85rem;
                white-space: nowrap;
                scroll-snap-align: center;
                position: relative;
                transform: scale(1);
                opacity: 1;
                transition: transform 0.3s ease, opacity 0.3s ease, box-shadow 0.3s ease;
                z-index: 1;
                box-sizing: border-box;
                display: flex;
                align-items: center;
                justify-content: center;
                height: auto;
            }
            
            /* Current phase - prominent and centered, fully visible */
            .phase-btn.active {
                transform: scale(1.08);
                z-index: 3;
                box-shadow: 0 6px 20px rgba(255, 107, 53, 0.5);
                min-width: 200px;
                width: 200px;
                background: var(--orange-primary);
                /* Remove any gradient from button itself on mobile */
                background-image: none;
            }
            
            /* Mobile: Remove gradient effect entirely to avoid issues */
            .phase-navigation::after {
                display: none;
            }
            
            /* Previous phase - visible on left */
            .phase-btn.prev-phase {
                transform: scale(0.85) translateX(-10px);
                opacity: 0.5;
                z-index: 2;
            }
            
            /* Next phase - visible on right */
            .phase-btn.next-phase {
                transform: scale(0.85) translateX(10px);
                opacity: 0.5;
                z-index: 2;
            }
            
            /* All other phases - hidden but still scrollable */
            .phase-btn:not(.active):not(.prev-phase):not(.next-phase) {
                opacity: 0.2;
            }

            /* Tips Panel Mobile */
            .tips-header {
                margin-bottom: 16px;
            }

            .tips-title {
                font-size: 1.1rem;
            }

            .tip-card {
                padding: 12px;
                margin-bottom: 12px;
            }

            .tip-content {
                font-size: 0.9rem;
            }
        }

        /* Small Mobile (< 480px) */
        @media (max-width: 479px) {
            .main-content {
                padding: 16px 12px;
            }
            
            .page-title {
                font-size: 1.25rem;
            }

            .script-display {
                font-size: 0.95rem;
                padding: 16px;
                min-height: 180px;
            }

            .response-btn {
                font-size: 0.9rem;
                padding: 14px 16px;
                min-height: 48px;
            }

            .action-btn {
                font-size: 0.85rem;
                padding: 10px 12px;
            }
        }

        /* Prevent body scroll when drawer is open */
        body.drawer-open {
            overflow-y: hidden;
        }
    </style>
</head>
<body>
    <div class="training-container">
        <!-- Main Content -->
        <div class="main-content">
            <div class="brand-header">
                <div class="brand-logo">Power Choosers CRM</div>
                <div class="brand-tagline">Call Scripts Training Mode</div>
            </div>

            <div class="page-header">
                <h1 class="page-title">Call Scripts Practice</h1>
                <p class="page-subtitle">Practice your cold calling responses and navigate through different scenarios</p>
            </div>

            <div class="toolbar-with-openers">
                <div class="toolbar">
                    <button class="action-btn" id="back-btn" disabled>Back</button>
                    <button class="action-btn" id="restart-btn">Restart</button>
                </div>
                
                <div class="opener-selector" id="opener-selector">
                    <div class="opener-label">Select your opening:</div>
                    <div class="opener-buttons-container">
                        <!-- Opener buttons will be dynamically generated -->
                    </div>
                </div>
            </div>

            <div class="phase-navigation" id="phase-navigation">
                <!-- Phase buttons will be dynamically generated -->
            </div>

            <div class="script-display" id="script-display">
                Click 'Dial' to begin the call.
            </div>

            <div class="response-buttons-container">
                <div class="response-buttons" id="response-buttons"></div>
            </div>

            <!-- Mobile Tips Toggle Button -->
            <button class="mobile-tips-toggle" id="tipsToggle">
                Tips & Resources ▼
            </button>
        </div>

        <!-- Tips Panel -->
        <div class="tips-panel" id="tipsPanel">
            <div class="tips-header">
                <h2 class="tips-title">Call Notes & Tips</h2>
                <p class="tips-subtitle">Electricity sales best practices</p>
            </div>

            <!-- Market Facts Section -->
            <div class="tip-card">
                <div class="tip-header">
                    <svg class="tip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                    <div class="tip-title">Market Facts</div>
                </div>
                <div class="tip-content">
                    <strong>ERCOT prices:</strong> 2.5x higher than 4 years ago<br>
                    <strong>Commercial rates:</strong> 23% increase since 2020<br>
                    <strong>Data center impact:</strong> 50% rate increase (2023-2024)<br>
                    <strong>Demand growth:</strong> 42% expected by 2035
                </div>
                <span class="tip-category">Market Data</span>
            </div>

            <!-- Pattern Interrupt Opening -->
            <div class="tip-card">
                <div class="tip-header">
                    <svg class="tip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                    <div class="tip-title">Pattern Interrupt Opening</div>
                </div>
                <div class="tip-content">
                    Use: "I'll be direct — electricity costs are something most business leaders have NO strategy around, and it's costing them thousands. Do you feel like you have a solid handle on your electricity costs?"
                    <br><br>
                    <strong>Why it works:</strong> Bold, honest, creates pattern interrupt. Most businesses have zero strategy.
                </div>
                <span class="tip-category">Opening</span>
            </div>

            <!-- 4-Stage Discovery Process -->
            <div class="tip-card">
                <div class="tip-header">
                    <svg class="tip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <div class="tip-title">Discovery Flow</div>
                </div>
                <div class="tip-content">
                    <strong>Stage 1 - Situation:</strong> "Walk me through your current setup"<br>
                    <strong>Stage 2 - Problem:</strong> "What's most frustrating?"<br>
                    <strong>Stage 3 - Consequence:</strong> "What's this costing you?"<br>
                    <strong>Stage 4 - Solution:</strong> "What would be ideal?"
                </div>
                <span class="tip-category">Discovery</span>
            </div>

            <!-- Key Discovery Questions -->
            <div class="tip-card">
                <div class="tip-header">
                    <svg class="tip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    <div class="tip-title">Key Discovery Questions</div>
                </div>
                <div class="tip-content">
                    • When does your contract expire?<br>
                    • Who is your current supplier?<br>
                    • How much do you spend monthly?<br>
                    • Are you locked in or variable?<br>
                    • Have you shopped in the last 12 months?
                </div>
                <span class="tip-category">Discovery</span>
            </div>

            <!-- Objection Handling -->
            <div class="tip-card">
                <div class="tip-header">
                    <svg class="tip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                    </svg>
                    <div class="tip-title">Objection: "Happy with Supplier"</div>
                </div>
                <div class="tip-content">
                    <strong>Don't rebut — ask:</strong><br>
                    "That's fair. Have you shopped the market in the last 12 months to make sure you're getting the best rate available?"
                    <br><br>
                    <strong>If they haven't:</strong> Market has moved significantly — use data center boom talking point.
                </div>
                <span class="tip-category">Objections</span>
            </div>

            <!-- Market Talking Points -->
            <div class="tip-card">
                <div class="tip-header">
                    <svg class="tip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                    <div class="tip-title">Data Center Talking Point</div>
                </div>
                <div class="tip-content">
                    "Between 2023-2024, electricity rates went up 50% because data centers and AI are consuming massive power. When you renew, that's the market you're shopping into. The question isn't 'should I shop?' — it's 'when should I lock in before prices go higher?'"
                </div>
                <span class="tip-category">Market Context</span>
            </div>

            <!-- Tonality Guide -->
            <div class="tip-card">
                <div class="tip-header">
                    <svg class="tip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    </svg>
                    <div class="tip-title">Tonality Guide</div>
                </div>
                <div class="tip-content tonality-guide">
                    <div class="tone-item"><span class="tone-badge curious">curious</span><span class="tone-desc">Higher pitch, genuine</span></div>
                    <div class="tone-item"><span class="tone-badge concerned">concerned</span><span class="tone-desc">Lower pitch, empathetic</span></div>
                    <div class="tone-item"><span class="tone-badge confident">confident</span><span class="tone-desc">Steady, authoritative</span></div>
                    <div class="tone-item"><span class="tone-badge serious">serious</span><span class="tone-desc">Lower, slower pace</span></div>
                    <div class="tone-item"><span class="tone-badge understanding">understanding</span><span class="tone-desc">Empathetic, patient</span></div>
                    <div class="tone-item"><span class="tone-badge professional">professional</span><span class="tone-desc">Formal, respectful</span></div>
                    <div class="tone-item"><span class="tone-badge friendly">friendly</span><span class="tone-desc">Warm, approachable</span></div>
                    <div style="margin-top: 12px;"><strong>Pause indicators:</strong> Use pauses for authority & emphasis</div>
                </div>
                <span class="tip-category">Delivery</span>
            </div>

            <!-- Closing Framework -->
            <div class="tip-card">
                <div class="tip-header">
                    <svg class="tip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    <div class="tip-title">Closing Framework</div>
                </div>
                <div class="tip-content">
                    <strong>Step 1:</strong> Trial close (summarize their goal)<br>
                    <strong>Step 2:</strong> Confirm pain point (why it matters)<br>
                    <strong>Step 3:</strong> Suggest next step (15-min analysis)<br>
                    <strong>Step 4:</strong> Binary choice (Tuesday or Wednesday?)
                </div>
                <span class="tip-category">Closing</span>
            </div>

            <!-- Renewal Risk -->
            <div class="tip-card">
                <div class="tip-header">
                    <svg class="tip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    <div class="tip-title">Renewal Risk</div>
                </div>
                <div class="tip-content">
                    If contract expires without renewal:<br>
                    • Variable rates spike 50-100% higher<br>
                    • Some suppliers auto-renew at unfavorable rates<br>
                    • Missing deadline = catastrophic cost increase<br>
                    <br>
                    <strong>Key insight:</strong> Start planning 6 months before expiry.
                </div>
                <span class="tip-category">Risk</span>
            </div>

            <!-- Discovery Checklist -->
            <div class="tip-card">
                <div class="tip-header">
                    <svg class="tip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                    <div class="tip-title">Discovery Checklist</div>
                </div>
                <div class="tip-content">
                    <strong>Must learn:</strong><br>
                    ☐ Contract expiration date<br>
                    ☐ Current supplier name<br>
                    ☐ Monthly spend (roughly)<br>
                    ☐ Fixed vs variable rate<br>
                    ☐ Who makes the decision
                </div>
                <span class="tip-category">Checklist</span>
            </div>
        </div>
    </div>

    <script>
        'use strict';

        // Escape HTML helper
        function escapeHtml(str) {
            if (str == null) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // Day part helper
        function dayPart() {
            try {
                const h = new Date().getHours();
                if (h < 12) return 'morning';
                if (h < 17) return 'afternoon';
                return 'evening';
            } catch(_) { return 'day'; }
        }

        // Mock data for training (simplified)
        function getLiveData() {
            return {
                ctx: { name: '', company: '', number: '', isActive: false },
                contact: { firstName: '', lastName: '', fullName: '', phone: '', email: '', company: '' },
                account: { name: '', industry: '', city: '', state: '', website: '', supplier: '', contractEnd: '' }
            };
        }

        // Render template with mock data
        function renderTemplate(str, mode) {
            if (!str) return '';
            const dp = dayPart();
            const data = getLiveData();
            
            // Define replacements with badges
            const replacements = {
                'day.part': dp,
                'contact.first_name': '<span class="badge contact">(contact name)</span>',
                'contact.last_name': '<span class="badge contact">(contact name)</span>',
                'contact.full_name': '<span class="badge contact">(contact name)</span>',
                'contact.phone': '(phone number)',
                'contact.mobile': '(mobile number)',
                'contact.email': '(email address)',
                'contact.title': '(job title)',
                'account.name': '<span class="badge company">(company name)</span>',
                'account.industry': '<span class="badge company">(industry)</span>',
                'account.city': '<span class="badge company">(city)</span>',
                'account.state': '(state)',
                'account.website': '(website)',
                'account.supplier': '(supplier)',
                'account.contract_end': '(contract end date)'
            };
            
            let result = String(str);
            for (const [key, value] of Object.entries(replacements)) {
                const pattern = new RegExp(`\\{\\{\\s*${key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\s*\\}\\}`, 'gi');
                result = result.replace(pattern, value);
            }
            return result;
        }

        // Improved Call Flow (Based on 2025 Best Practices + Gap Analysis)
        const FLOW = {
            start: {
                stage: 'Ready',
                text: "Click 'Dial' to begin the call.",
                responses: []
            },
            pre_call_qualification: {
                stage: 'Pre-Call Prep',
                text: "<strong>Before we dial... let's qualify this prospect.</strong><br><br><em>Think through these questions:</em><br><br>• Who are you calling? (Decision maker / Gatekeeper / Unknown)<br>• What's their industry?<br>• What research do you have on their situation?<br>• What's your FIRST OBJECTIVE? (Get meeting / Understand situation / Reserve price before rates rise / Build relationship)<br><br><strong>Key Insight:</strong> We work with ALL suppliers. Our value is reserving competitive rates BEFORE market prices increase, and running competitive events across 100+ suppliers.",
                responses: [
                    { label: 'Ready - I have answers', next: 'dialing' },
                    { label: 'I need more time', next: 'start' }
                ]
            },
            dialing: {
                stage: 'Connecting',
                text: 'Dialing... Ringing...',
                responses: [
                    { label: 'Call connected', next: 'hook' },
                    { label: 'Voicemail', next: 'voicemail' },
                    { label: 'No answer', next: 'no_answer' }
                ]
            },
            hook: {
                stage: 'Opening',
                text: 'Good {{day.part}}, is this <span class="badge contact">(contact name)</span>?',
                responses: [
                    { label: 'Yes, speaking', next: null }, // Will be set dynamically to currentOpener
                    { label: "Who's calling?", next: null }, // Will be set dynamically to currentOpener
                    { label: 'Not the right person', next: 'gatekeeper_intro' }
                ]
            },
            pattern_interrupt_opening: {
                stage: 'Opening',
                text: "Hi {{contact.first_name}}, <span class=\"name-badge\">(your name)</span> from Power Choosers. <span class=\"pause-indicator\"></span> I'll be direct <span class=\"pause-indicator\"></span> electricity costs are something most business leaders I talk to have NO strategy around, and it's costing them thousands. <span class=\"pause-indicator\"></span> Do you feel like you have a solid handle on your electricity costs?",
                responses: [
                    { label: 'Yes, I handle it well', next: 'situation_discovery' },
                    { label: "Not really / I'm not sure", next: 'situation_discovery' },
                    { label: "I don't handle that", next: 'gatekeeper_intro' },
                    { label: 'Not interested', next: 'objection_not_interested' }
                ]
            },
            opener_direct_question: {
                stage: 'Opening',
                text: "Hi {{contact.first_name}}, <span class=\"name-badge\">(your name)</span> from Power Choosers. <span class=\"pause-indicator\"></span> Quick question before I pitch anything <span class=\"pause-indicator\"></span> can I ask how {{account.name}} is currently handling your electricity agreement?",
                responses: [
                    { label: 'Have a supplier we use', next: 'situation_discovery' },
                    { label: 'We shop around when needed', next: 'situation_discovery' },
                    { label: "Don't really manage it", next: 'situation_discovery' },
                    { label: 'Not interested', next: 'objection_not_interested' }
                ]
            },
            opener_transparent: {
                stage: 'Opening',
                text: "Hi {{contact.first_name}}, <span class=\"name-badge\">(your name)</span> from Power Choosers. <span class=\"pause-indicator\"></span> For full transparency <span class=\"pause-indicator\"></span> this is a sales call about electricity costs. I know I've called completely out of the blue. <span class=\"pause-indicator\"></span> Is now actually a bad time for a quick chat?",
                responses: [
                    { label: 'Now is fine / I\'ve got a minute', next: 'opener_transparent_followup' },
                    { label: 'What is this about?', next: 'opener_transparent_followup' },
                    { label: 'Actually, now is bad', next: 'opener_transparent_bad_time' },
                    { label: 'Not interested', next: 'objection_not_interested' }
                ]
            },
            opener_transparent_followup: {
                stage: 'Opening',
                text: "<span class=\"pause-indicator\"></span> Perfect. <span class=\"pause-indicator\"></span> I'll be direct <span class=\"pause-indicator\"></span> most companies I talk to have NO strategy around electricity costs, and it's costing them thousands. <span class=\"pause-indicator\"></span> Do you feel like you have a solid handle on your electricity costs?",
                responses: [
                    { label: 'Yes, I handle it well', next: 'situation_discovery' },
                    { label: "Not really / I'm not sure", next: 'situation_discovery' },
                    { label: "I don't handle that", next: 'gatekeeper_intro' }
                ]
            },
            opener_transparent_bad_time: {
                stage: 'Opening',
                text: "<span class=\"tone-marker understanding\">understanding tone</span> Totally get it. <span class=\"pause-indicator\"></span> When would be a better time to chat? <span class=\"pause-indicator\"></span> Or would you prefer I just send you some information first?",
                responses: [
                    { label: 'Send me information', next: 'email_first' },
                    { label: 'Try later today', next: 'schedule_followup' },
                    { label: 'Just forget it', next: 'respect_decision' }
                ]
            },
            opener_social_proof: {
                stage: 'Opening',
                text: "Hi {{contact.first_name}}, <span class=\"name-badge\">(your name)</span> from Power Choosers. <span class=\"pause-indicator\"></span> I've been working with several {{account.industry}} companies in {{account.city}} who were dealing with rising electricity costs. <span class=\"pause-indicator\"></span> That's why I'm calling <span class=\"pause-indicator\"></span> wanted to see if you're experiencing something similar?",
                responses: [
                    { label: 'Yes, costs have been going up', next: 'situation_discovery' },
                    { label: "Not really an issue", next: 'opener_social_proof_skeptical' },
                    { label: 'Tell me more', next: 'situation_discovery' },
                    { label: 'Not interested', next: 'objection_not_interested' }
                ]
            },
            opener_social_proof_skeptical: {
                stage: 'Opening',
                text: "<span class=\"tone-marker curious\">curious tone</span> I totally understand. <span class=\"pause-indicator\"></span> Can I ask <span class=\"pause-indicator\"></span> are you aware of how much electricity rates have gone up in the last 4 years? <span class=\"pause-indicator\"></span> The market has moved significantly.",
                responses: [
                    { label: 'I\'ve heard about rate increases', next: 'market_context' },
                    { label: 'Not really aware', next: 'market_context' },
                    { label: 'Still not interested', next: 'objection_not_interested' }
                ]
            },
            situation_discovery: {
                stage: 'Discovery - Situation',
                text: "<span class=\"tone-marker curious\">curious tone</span> <span class=\"pause-indicator\"></span> Got it. <span class=\"pause-indicator\"></span> So... walk me through your current setup real quick. <span class=\"pause-indicator\"></span> Roughly how much are you spending monthly on electricity?",
                responses: [
                    { label: 'Spending $1K - $5K monthly', next: 'situation_monthly_spend' },
                    { label: 'Spending $5K - $20K monthly', next: 'situation_monthly_spend' },
                    { label: 'Spending $20K+ monthly', next: 'situation_monthly_spend' },
                    { label: "Don't know offhand", next: 'situation_monthly_spend' }
                ]
            },
            situation_monthly_spend: {
                stage: 'Discovery - Situation',
                text: "<span class=\"tone-marker curious\">curious tone</span> <span class=\"pause-indicator\"></span> Okay, so that gives me context. <span class=\"pause-indicator\"></span> And do you know roughly what rate you're paying per kWh right now?",
                responses: [
                    { label: 'Know the rate (X.X cents/kWh)', next: 'situation_supplier_name' },
                    { label: "Don't know it", next: 'situation_supplier_name' }
                ]
            },
            situation_supplier_name: {
                stage: 'Discovery - Situation',
                text: "<span class=\"tone-marker curious\">curious tone</span> <span class=\"pause-indicator\"></span> Got it. <span class=\"pause-indicator\"></span> And who is your current electricity supplier?",
                responses: [
                    { label: 'Named a supplier', next: 'situation_contract_expiry' },
                    { label: "Not sure / Don't remember", next: 'situation_contract_expiry' }
                ]
            },
            situation_contract_expiry: {
                stage: 'Discovery - Situation',
                text: "<span class=\"tone-marker curious\">curious tone</span> And do you happen to know when your current contract expires? <span class=\"pause-indicator\"></span> This helps us understand the timing for reserving competitive rates.",
                responses: [
                    { label: 'Within 3 months - HOT', next: 'situation_decision_process_urgent' },
                    { label: '3-6 months out', next: 'situation_decision_process' },
                    { label: '6-12 months out', next: 'situation_decision_process' },
                    { label: 'Not sure / Don\'t know', next: 'situation_decision_process' },
                    { label: 'Just renewed recently', next: 'situation_decision_process' }
                ]
            },
            situation_decision_process: {
                stage: 'Discovery - Situation',
                text: "<span class=\"tone-marker curious\">curious tone</span> One more thing... <span class=\"pause-indicator\"></span> walk me through how your company typically makes decisions about energy suppliers or contracts. <span class=\"pause-indicator\"></span> Is it just you, or does it involve others like CFO or finance?",
                responses: [
                    { label: 'Just me / I decide', next: 'problem_discovery' },
                    { label: 'Involves CFO / Finance', next: 'problem_discovery' },
                    { label: 'Multiple stakeholders', next: 'problem_discovery' },
                    { label: "Not sure yet", next: 'problem_discovery' }
                ]
            },
            situation_decision_process_urgent: {
                stage: 'Discovery - Situation',
                text: "<span class=\"tone-marker concerned\">concerned tone</span> That's really tight timing. <span class=\"pause-indicator\"></span> That's actually perfect because we can help you lock in competitive rates NOW before the market moves. <span class=\"pause-indicator\"></span><br><br>Who else needs to be involved in the decision besides you?",
                responses: [
                    { label: 'Just me / I decide', next: 'problem_discovery' },
                    { label: 'Involves CFO / Finance', next: 'problem_discovery' },
                    { label: 'Multiple stakeholders', next: 'problem_discovery' }
                ]
            },
            market_context: {
                stage: 'Discovery - Problem',
                text: "<span class=\"tone-marker concerned\">concerned tone</span> That's perfect timing actually. <span class=\"pause-indicator\"></span> Here's something most people don't know: <span class=\"pause-indicator\"></span> electricity prices have doubled in the last 4 years because of data centers and AI. <span class=\"pause-indicator\"></span><br><br>When you renew, you're shopping into that market. <span class=\"pause-indicator\"></span> What would it cost {{account.name}} if your rates go up another 15-20%?",
                responses: [
                    { label: 'That would hurt our budget', next: 'consequence_discovery' },
                    { label: "Not sure about the impact", next: 'consequence_discovery' },
                    { label: "We're fine with current setup", next: 'objection_happy_supplier' }
                ]
            },
            problem_discovery: {
                stage: 'Discovery - Problem',
                text: "<span class=\"tone-marker curious\">curious tone</span> <span class=\"pause-indicator\"></span> Okay, so that context helps. <span class=\"pause-indicator\"></span> Now here's what I want to understand... <span class=\"pause-indicator\"></span> what's been the most frustrating part about managing your electricity costs for {{account.name}}?",
                responses: [
                    { label: 'Costs are too high', next: 'probe_problem_costs' },
                    { label: 'Complexity / too many options', next: 'probe_problem_complexity' },
                    { label: 'Budget uncertainty', next: 'probe_problem_budget' },
                    { label: 'Tell me more...', next: 'probe_problem_generic' }
                ]
            },
            probe_problem_costs: {
                stage: 'Discovery - Problem',
                text: "<span class=\"tone-marker curious\">curious tone</span> <span class=\"pause-indicator\"></span> Tell me more about that... <span class=\"pause-indicator\"></span> When did you first notice the costs going up?",
                responses: [
                    { label: 'Last year', next: 'probe_cost_impact' },
                    { label: 'This quarter / Recently', next: 'probe_cost_impact' },
                    { label: 'Ongoing issue for a while', next: 'probe_cost_impact' }
                ]
            },
            probe_cost_impact: {
                stage: 'Discovery - Problem',
                text: "<span class=\"tone-marker curious\">curious tone</span> <span class=\"pause-indicator\"></span> And how has that impacted your ability to plan your budget? <span class=\"pause-indicator\"></span> Has leadership noticed this too?",
                responses: [
                    { label: 'Significant budget impact', next: 'consequence_discovery' },
                    { label: 'Some impact on planning', next: 'consequence_discovery' },
                    { label: 'Leadership is aware', next: 'consequence_discovery' }
                ]
            },
            probe_problem_complexity: {
                stage: 'Discovery - Problem',
                text: "<span class=\"tone-marker curious\">curious tone</span> <span class=\"pause-indicator\"></span> I hear that a lot. <span class=\"pause-indicator\"></span> What specifically makes it complex? <span class=\"pause-indicator\"></span> Is it comparing all the options, or understanding the contracts?",
                responses: [
                    { label: 'Too many options to compare', next: 'consequence_discovery' },
                    { label: 'Contracts are confusing', next: 'consequence_discovery' },
                    { label: 'Don\'t have time to research', next: 'consequence_discovery' }
                ]
            },
            probe_problem_budget: {
                stage: 'Discovery - Problem',
                text: "<span class=\"tone-marker curious\">curious tone</span> <span class=\"pause-indicator\"></span> Budget uncertainty is a real pain point. <span class=\"pause-indicator\"></span> How long has that been an issue? <span class=\"pause-indicator\"></span> What impact does that have on your planning?",
                responses: [
                    { label: 'Makes planning difficult', next: 'consequence_discovery' },
                    { label: 'Can\'t predict costs', next: 'consequence_discovery' },
                    { label: 'Leadership wants more certainty', next: 'consequence_discovery' }
                ]
            },
            probe_problem_generic: {
                stage: 'Discovery - Problem',
                text: "<span class=\"tone-marker curious\">curious tone</span> <span class=\"pause-indicator\"></span> Tell me more about what's challenging for you... <span class=\"pause-indicator\"></span> Is it the cost, the complexity, or something else?",
                responses: [
                    { label: 'Cost is the issue', next: 'probe_problem_costs' },
                    { label: 'Complexity is the issue', next: 'probe_problem_complexity' },
                    { label: 'Budget uncertainty', next: 'probe_problem_budget' }
                ]
            },
            consequence_discovery: {
                stage: 'Discovery - Consequence',
                text: "<span class=\"tone-marker serious\">serious tone</span> <span class=\"pause-indicator\"></span> I hear that from most companies right now. <span class=\"pause-indicator\"></span> So here's what I want you to think about... <span class=\"pause-indicator\"></span> if nothing changes over the next 12 months <span class=\"pause-indicator\"></span> and this stays the way it is <span class=\"pause-indicator\"></span> what does that actually cost {{account.name}}?",
                responses: [
                    { label: 'That would be significant', next: 'consequence_urgency' },
                    { label: "Haven't calculated it", next: 'consequence_urgency' },
                    { label: 'We\'d manage', next: 'consequence_renewal_risk' }
                ]
            },
            consequence_urgency: {
                stage: 'Discovery - Consequence',
                text: "<span class=\"tone-marker serious\">serious tone</span> And here's the thing about electricity markets right now... <span class=\"pause-indicator\"></span> Between 2023-2024, rates went up 50% because data centers and AI are consuming massive power. <span class=\"pause-indicator\"></span><br><br>If your contract renewal deadline comes and you miss it <span class=\"pause-indicator\"></span> you could get auto-enrolled at variable rates 50-100% higher than what's available today. <span class=\"pause-indicator\"></span><br><br>What does that look like financially for {{account.name}} if that happens?",
                responses: [
                    { label: 'That would be catastrophic', next: 'solution_discovery' },
                    { label: 'We need to avoid that', next: 'solution_discovery' },
                    { label: "That's a real risk", next: 'solution_discovery' }
                ]
            },
            consequence_renewal_risk: {
                stage: 'Discovery - Consequence',
                text: "<span class=\"tone-marker serious\">serious tone</span> I get it. <span class=\"pause-indicator\"></span> But here's what most people don't realize... <span class=\"pause-indicator\"></span> if your contract expires without renewal, some suppliers auto-renew you at variable rates that can spike 50-100% higher than market rates. <span class=\"pause-indicator\"></span><br><br>That's why we help companies RESERVE competitive rates BEFORE the renewal deadline, so you're not caught off-guard. <span class=\"pause-indicator\"></span> Does that risk concern you?",
                responses: [
                    { label: 'Yes, that concerns me', next: 'solution_discovery' },
                    { label: "We'll handle it", next: 'objection_not_priority' },
                    { label: 'Not really', next: 'objection_not_priority' }
                ]
            },
            solution_discovery: {
                stage: 'Discovery - Solution',
                text: "<span class=\"tone-marker hopeful\">hopeful tone</span> <span class=\"pause-indicator\"></span> That's significant. <span class=\"pause-indicator\"></span> So... if we could actually fix this and get that money back into your budget <span class=\"pause-indicator\"></span> what would matter most to you in a solution? <span class=\"pause-indicator\"></span><br><br>Is it getting access to competitive rates from 100+ suppliers so you're not stuck with one option? <span class=\"pause-indicator\"></span> Having budget certainty by reserving rates before market moves? <span class=\"pause-indicator\"></span> Having someone handle the complexity so you don't have to? <span class=\"pause-indicator\"></span> Or all of the above?",
                responses: [
                    { label: 'Access to competitive rates', next: 'trial_close_1' },
                    { label: 'Budget certainty', next: 'trial_close_1' },
                    { label: 'Handle the complexity', next: 'trial_close_1' },
                    { label: 'All of the above', next: 'trial_close_1' }
                ]
            },
            trial_close_1: {
                stage: 'Closing - Trial Close',
                text: "<span class=\"tone-marker confident\">confident tone</span> <span class=\"pause-indicator\"></span> Perfect. <span class=\"pause-indicator\"></span> So if I'm hearing you right, the real issue is [reference their specific pain - high costs / complexity / budget uncertainty]. <span class=\"pause-indicator\"></span> And if there was a way to solve that by locking in competitive rates BEFORE market prices go up <span class=\"pause-indicator\"></span> that would be worth exploring, right?",
                responses: [
                    { label: 'Yes, that would be worth exploring', next: 'trial_close_2' },
                    { label: 'Maybe / I need to think', next: 'trial_close_hesitation' },
                    { label: "Not really", next: 'objection_not_priority' }
                ]
            },
            trial_close_2: {
                stage: 'Closing - Confirm Value',
                text: "<span class=\"tone-marker confident\">confident tone</span> <span class=\"pause-indicator\"></span> Great. <span class=\"pause-indicator\"></span> And the reason that matters is because if we don't act soon <span class=\"pause-indicator\"></span> [reference consequence they mentioned - rate increases / renewal risk / budget impact]. <span class=\"pause-indicator\"></span> Correct?",
                responses: [
                    { label: 'Yes, that\'s correct', next: 'close_meeting' },
                    { label: 'Partially / Sort of', next: 'close_meeting' },
                    { label: "Not sure", next: 'close_meeting' }
                ]
            },
            trial_close_hesitation: {
                stage: 'Closing - Handle Hesitation',
                text: "<span class=\"tone-marker understanding\">understanding tone</span> <span class=\"pause-indicator\"></span> Totally fair. <span class=\"pause-indicator\"></span> What would you want me to have prepared so you can make a good decision? <span class=\"pause-indicator\"></span> Is it market rate comparison? <span class=\"pause-indicator\"></span> How our process works? <span class=\"pause-indicator\"></span> Or understanding what rates are available right now before market moves?",
                responses: [
                    { label: 'Market rate comparison', next: 'email_first' },
                    { label: 'How your process works', next: 'email_first' },
                    { label: 'See what rates are available now', next: 'close_meeting' }
                ]
            },
            close_meeting: {
                stage: 'Closing',
                text: "<span class=\"tone-marker confident\">confident tone</span> <span class=\"pause-indicator\"></span> Perfect. So what you're really looking for is [REFLECT THEIR ANSWER - competitive rates / budget certainty / handling complexity]. <span class=\"pause-indicator\"></span> Here's what that means... <span class=\"pause-indicator\"></span> we need to schedule a quick 15-minute analysis where I show you exactly what's available in the market right now versus what you're paying. <span class=\"pause-indicator\"></span> This helps you RESERVE competitive rates before market prices move. <span class=\"pause-indicator\"></span> No obligation <span class=\"pause-indicator\"></span> just so you have all the information to make the best decision. <span class=\"pause-indicator\"></span><br><br>Would Tuesday or Wednesday work better for you?",
                responses: [
                    { label: 'Tuesday works', next: 'meeting_scheduled' },
                    { label: 'Wednesday works', next: 'meeting_scheduled' },
                    { label: 'Send me something first', next: 'email_first' },
                    { label: 'What would you prepare?', next: 'close_prep_question' }
                ]
            },
            close_prep_question: {
                stage: 'Closing',
                text: "<span class=\"tone-marker confident\">confident tone</span> Great question. <span class=\"pause-indicator\"></span> I'd pull competitive rates from 100+ suppliers in your market, compare them to your current rate, and show you what you could save by reserving those rates before market moves. <span class=\"pause-indicator\"></span><br><br>Plus I'd explain how our process works - we handle everything, you just approve the best option. <span class=\"pause-indicator\"></span> Sound good? <span class=\"pause-indicator\"></span> Tuesday or Wednesday?",
                responses: [
                    { label: 'Tuesday works', next: 'meeting_scheduled' },
                    { label: 'Wednesday works', next: 'meeting_scheduled' },
                    { label: 'Send email first', next: 'email_first' }
                ]
            },
            meeting_scheduled: {
                stage: 'Success',
                text: '✅ <strong>Meeting Scheduled!</strong><br><br>Great job! You successfully:<br>• Opened with pattern interrupt<br>• Led them through discovery<br>• Built emotional connection around consequences<br>• Closed for a meeting<br><br>Key wins: You stayed curious, asked follow-ups, and let THEM discover the pain.',
                responses: [
                    { label: 'Start New Call', next: 'start' }
                ]
            },
            email_first: {
                stage: 'Objection Handling',
                text: "<span class=\"tone-marker understanding\">understanding tone</span> Happy to. <span class=\"pause-indicator\"></span> Before I do though <span class=\"pause-indicator\"></span> just so I send something actually relevant to you... <span class=\"pause-indicator\"></span> What would you want me to include?",
                responses: [
                    { label: 'Market rate comparison', next: 'email_follow_up' },
                    { label: 'How your process works', next: 'email_follow_up' },
                    { label: 'Case study / ROI info', next: 'email_follow_up' },
                    { label: 'All of the above', next: 'email_follow_up' }
                ]
            },
            email_follow_up: {
                stage: 'Objection Handling',
                text: "<span class=\"tone-marker confident\">confident tone</span> Perfect. <span class=\"pause-indicator\"></span> And when you get that... <span class=\"pause-indicator\"></span> when should I follow up with you? <span class=\"pause-indicator\"></span> End of this week? <span class=\"pause-indicator\"></span> Next week?",
                responses: [
                    { label: 'End of this week', next: 'email_scheduled' },
                    { label: 'Next week', next: 'email_scheduled' },
                    { label: 'Don\'t follow up', next: 'respect_decision' }
                ]
            },
            email_scheduled: {
                stage: 'Follow-up Scheduled',
                text: '✅ <strong>Email Follow-up Scheduled!</strong><br><br>Excellent! You:<br>• Identified what they wanted to see<br>• Got commitment on follow-up timing<br>• Left door open for next conversation<br><br>This creates accountability and keeps the conversation moving forward.',
                responses: [
                    { label: 'Start New Call', next: 'start' }
                ]
            },
            objection_not_interested: {
                stage: 'Objection Handling',
                text: "<span class=\"tone-marker understanding\">understanding tone</span> I totally understand. <span class=\"pause-indicator\"></span> Can I ask though <span class=\"pause-indicator\"></span> is it because you've already got a solution that's working great <span class=\"pause-indicator\"></span> or is it more that this just isn't a priority right now?",
                responses: [
                    { label: 'Already have solution', next: 'objection_happy_supplier' },
                    { label: 'Not a priority', next: 'objection_not_priority' },
                    { label: 'Just not interested', next: 'respect_decision' }
                ]
            },
            objection_happy_supplier: {
                stage: 'Objection Handling',
                text: "<span class=\"tone-marker confident\">confident tone</span> That's fair. <span class=\"pause-indicator\"></span> And just so you know, we work with ALL suppliers - we're not trying to switch you. <span class=\"pause-indicator\"></span><br><br>What we do is run competitive events across 100+ suppliers so you can RESERVE the best rate available BEFORE market prices move. <span class=\"pause-indicator\"></span><br><br>Quick question though: <span class=\"pause-indicator\"></span> have you shopped the market in the last 12 months to make sure you're getting the best rate available?",
                responses: [
                    { label: 'Yes, recently shopped', next: 'probe_deeper' },
                    { label: 'Not recently', next: 'objection_market_moved' },
                    { label: "No, we haven't", next: 'objection_market_moved' }
                ]
            },
            objection_market_moved: {
                stage: 'Objection Handling',
                text: "<span class=\"tone-marker concerned\">concerned tone</span> Here's something important... <span class=\"pause-indicator\"></span> the market has moved significantly in the last 12-24 months. <span class=\"pause-indicator\"></span><br><br>Between 2023-2024, electricity rates went up 50% because data centers and AI are consuming massive power. <span class=\"pause-indicator\"></span><br><br>When your contract renews, that's the market you're shopping into. <span class=\"pause-indicator\"></span> The question isn't 'should we shop?' - it's 'when should we lock in competitive rates BEFORE prices go higher?' <span class=\"pause-indicator\"></span><br><br>Does that make sense?",
                responses: [
                    { label: 'Yes, that makes sense', next: 'close_meeting' },
                    { label: 'We\'ll handle it ourselves', next: 'objection_not_priority' },
                    { label: "Still not interested", next: 'respect_decision' }
                ]
            },
            probe_deeper: {
                stage: 'Discovery',
                text: "<span class=\"tone-marker curious\">curious tone</span> Interesting. <span class=\"pause-indicator\"></span> And were the rates you're paying now better or worse than what's available in the market right now?",
                responses: [
                    { label: "We're competitive", next: 'respect_decision' },
                    { label: 'Rates went up', next: 'close_meeting' }
                ]
            },
            objection_not_priority: {
                stage: 'Objection Handling',
                text: "<span class=\"tone-marker understanding\">understanding tone</span> I get it. <span class=\"pause-indicator\"></span> Here's what I'd suggest: <span class=\"pause-indicator\"></span> when your contract comes up for renewal in the next 6-12 months, that's when we should talk. <span class=\"pause-indicator\"></span><br><br>Do you know roughly when that is?",
                responses: [
                    { label: 'Yes, I know the date', next: 'schedule_followup' },
                    { label: 'Not sure', next: 'respect_decision' }
                ]
            },
            schedule_followup: {
                stage: 'Follow-up',
                text: "Perfect. <span class=\"pause-indicator\"></span> Let me put that on my calendar and I'll reach out 60 days before. <span class=\"pause-indicator\"></span> Sound good?",
                responses: [
                    { label: 'Yes, that works', next: 'followup_scheduled' },
                    { label: 'Just forget it', next: 'respect_decision' }
                ]
            },
            followup_scheduled: {
                stage: 'Success',
                text: '✅ <strong>Follow-up Scheduled!</strong><br><br>Excellent! You:<br>• Respected their timeline<br>• Got specific renewal date<br>• Positioned for future outreach<br>• Left door open (not pushy)<br><br>This is often how deals close!',
                responses: [
                    { label: 'Start New Call', next: 'start' }
                ]
            },
            respect_decision: {
                stage: 'Closing',
                text: "<span class=\"tone-marker professional\">professional tone</span> Fair enough. <span class=\"pause-indicator\"></span> I appreciate the time. <span class=\"pause-indicator\"></span> If anything changes or you want to explore options <span class=\"pause-indicator\"></span> you know how to reach me. <span class=\"pause-indicator\"></span> Have a great day!",
                responses: [
                    { label: 'End Call', next: 'call_success' }
                ]
            },
            gatekeeper_intro: {
                stage: 'Gatekeeper',
                text: "<span class=\"tone-marker friendly\">friendly tone</span> No problem. <span class=\"pause-indicator\"></span> Who would be the right person handling electricity decisions at {{account.name}}?",
                responses: [
                    { label: 'They gave name', next: 'asked_to_speak' },
                    { label: "Not sure / won't say", next: 'voicemail' },
                    { label: 'Can I just leave a message', next: 'voicemail' }
                ]
            },
            asked_to_speak: {
                stage: 'Transfer',
                text: "Great! Can I tell them who's calling and what it's about?<br><br><em>HOLD FOR TRANSFER...</em>",
                responses: [
                    { label: 'They transferred me', next: 'hook' },
                    { label: "They said no thanks", next: 'respect_decision' }
                ]
            },
            voicemail: {
                stage: 'Voicemail',
                text: "<span class=\"tone-marker professional\">professional tone</span> Voicemail detected. What would you say?<br><br><em>Tip: Keep it brief (20 seconds), mention specific reason for call, and give them permission to not call back.</em>",
                responses: [
                    { label: 'Generic voicemail', next: 'vm_feedback1' },
                    { label: 'Specific value voicemail', next: 'vm_feedback2' },
                    { label: 'Start over', next: 'start' }
                ]
            },
            vm_feedback1: {
                stage: 'Feedback',
                text: "⚠️ <strong>That voicemail was too generic.</strong><br><br>It didn't include:<br>• Why you called specifically<br>• What you help with<br>• Permission for them to ignore it<br><br>Better approach: Be specific about their situation or market opportunity.",
                responses: [
                    { label: 'Try again', next: 'voicemail' },
                    { label: 'Next scenario', next: 'start' }
                ]
            },
            vm_feedback2: {
                stage: 'Feedback',
                text: "✅ <strong>Good voicemail!</strong><br><br>You mentioned:<br>• Specific reason for call<br>• Relevant market context<br>• Permission for them to not call back<br><br>That increases callback rate by 30%+",
                responses: [
                    { label: 'Next scenario', next: 'start' },
                    { label: 'Review call flow', next: 'start' }
                ]
            },
            no_answer: {
                stage: 'No Answer',
                text: "No one answered. What's your next move?",
                responses: [
                    { label: 'Leave voicemail', next: 'voicemail' },
                    { label: 'Hang up & call back later', next: 'start' },
                    { label: 'Try different number', next: 'dialing' }
                ]
            },
            call_success: {
                stage: 'Complete',
                text: '📞 <strong>Call Ended</strong><br><br>Call Summary:<br>• Duration: ~4-6 minutes<br>• Outcome: Professional close<br>• Key Learning: Not every call closes, but professional respect opens doors for future opportunities.<br><br>Ready for the next prospect?',
                responses: [
                    { label: 'Start New Call', next: 'start' }
                ]
            }
        };

        // State management
        let state = {
            current: 'start',
            history: []
        };

        // DOM elements
        const display = document.getElementById('script-display');
        const responses = document.getElementById('response-buttons');
        const backBtn = document.getElementById('back-btn');
        const restartBtn = document.getElementById('restart-btn');

        // Phase definitions with entry points
        const PHASES = [
            { name: 'Pre-Call', stagePattern: 'Pre-Call Prep', entryPoint: 'pre_call_qualification' },
            { name: 'Opening', stagePattern: 'Opening', entryPoint: 'hook' },
            { name: 'Situation', stagePattern: 'Discovery - Situation', entryPoint: 'situation_discovery' },
            { name: 'Problem', stagePattern: 'Discovery - Problem', entryPoint: 'problem_discovery' },
            { name: 'Consequence', stagePattern: 'Discovery - Consequence', entryPoint: 'consequence_discovery' },
            { name: 'Solution', stagePattern: 'Discovery - Solution', entryPoint: 'solution_discovery' },
            { name: 'Closing', stagePattern: 'Closing', entryPoint: 'trial_close_1' },
            { name: 'Objections', stagePattern: 'Objection Handling', entryPoint: 'objection_not_interested' },
            { name: 'Success', stagePattern: 'Success', entryPoint: 'meeting_scheduled' }
        ];

        // Track completed phases
        let completedPhases = new Set();

        // Opener management
        const OPENER_CONFIGS = {
            default: {
                key: 'pattern_interrupt_opening',
                label: 'Bold Direct (Default)',
                state: 'pattern_interrupt_opening'
            },
            direct_question: {
                key: 'opener_direct_question',
                label: 'Direct Question',
                state: 'opener_direct_question'
            },
            transparent: {
                key: 'opener_transparent',
                label: 'Transparent',
                state: 'opener_transparent'
            },
            social_proof: {
                key: 'opener_social_proof',
                label: 'Social Proof',
                state: 'opener_social_proof'
            }
        };

        let currentOpener = OPENER_CONFIGS.default;
        let availableOpeners = [
            OPENER_CONFIGS.direct_question,
            OPENER_CONFIGS.transparent,
            OPENER_CONFIGS.social_proof
        ];

        // Build opener selector buttons
        function buildOpenerSelector() {
            const container = document.querySelector('.opener-buttons-container');
            if (!container) return;

            // Check if buttons already exist to prevent re-animation
            const existingButtons = container.querySelectorAll('.opener-btn');
            const hadButtons = existingButtons.length > 0;

            // Clear existing buttons
            container.innerHTML = '';

            // Create array with all openers (current + available)
            const allOpeners = [currentOpener, ...availableOpeners];

            // Create buttons for all openers
            allOpeners.forEach(opener => {
                const btn = document.createElement('button');
                btn.className = hadButtons ? 'opener-btn animated' : 'opener-btn';
                btn.textContent = opener.label;
                btn.dataset.openerKey = opener.key;
                btn.dataset.openerState = opener.state;
                
                // Highlight if this is the current active opener
                if (currentOpener.key === opener.key) {
                    btn.classList.add('active');
                }

                btn.addEventListener('click', () => {
                    // Only swap if clicking a different opener
                    if (currentOpener.key !== opener.key) {
                        // Swap: move current opener to available list, make selected the default
                        const oldDefault = currentOpener;
                        currentOpener = opener;
                        availableOpeners = availableOpeners.filter(o => o.key !== opener.key);
                        availableOpeners.push(oldDefault);

                        // Hook will be updated automatically via updateHookOpener()

                        // Rebuild buttons
                        buildOpenerSelector();

                        // If we're at the opening phase, jump to the new opener
                        if (state.current === 'hook' || state.current === 'pattern_interrupt_opening' || 
                            state.current.startsWith('opener_')) {
                            state.history.push(state.current);
                            state.current = opener.state;
                            render();
                        }
                    }
                });

                container.appendChild(btn);
            });
        }

        // Determine which phase a stage belongs to
        function getCurrentPhase() {
            const currentStage = FLOW[state.current]?.stage || 'Ready';
            const currentStateKey = state.current;

            // Direct state matches
            if (currentStateKey === 'start') return null;
            if (currentStateKey === 'pre_call_qualification') return 'Pre-Call';
            if (currentStateKey === 'dialing' || currentStateKey === 'hook' || currentStateKey === 'pattern_interrupt_opening') return 'Opening';

            // Stage pattern matching
            for (const phase of PHASES) {
                if (currentStage === phase.stagePattern || 
                    (phase.stagePattern === 'Closing' && currentStage.includes('Closing')) ||
                    (phase.stagePattern === 'Opening' && (currentStage === 'Opening' || currentStage === 'Connecting'))) {
                    return phase.name;
                }
            }

            // Fallback: check stage patterns more flexibly
            if (currentStage.includes('Situation')) return 'Situation';
            if (currentStage.includes('Problem')) return 'Problem';
            if (currentStage.includes('Consequence')) return 'Consequence';
            if (currentStage.includes('Solution')) return 'Solution';
            if (currentStage.includes('Closing')) return 'Closing';
            if (currentStage.includes('Objection')) return 'Objections';
            if (currentStage === 'Success' || currentStage === 'Complete') return 'Success';

            return null;
        }

        // Track phase progression
        let lastPhase = null;

        // Build phase navigation
        function buildPhaseNavigation() {
            const navEl = document.getElementById('phase-navigation');
            if (!navEl) return;

            // PRESERVE SCROLL POSITION before clearing (prevents jump to beginning)
            const currentScroll = navEl.scrollLeft;
            const isMobile = window.innerWidth <= 767;
            
            // Mark that we're rebuilding to prevent MutationObserver from interfering
            navEl.dataset.isRebuilding = 'true';

            navEl.innerHTML = '';
            const currentPhase = getCurrentPhase();
            
            // If we've moved to a new phase, mark previous as completed
            if (lastPhase && currentPhase && lastPhase !== currentPhase) {
                const lastIndex = PHASES.findIndex(p => p.name === lastPhase);
                const currentIndex = PHASES.findIndex(p => p.name === currentPhase);
                
                // Mark all phases before current as completed
                if (currentIndex > lastIndex) {
                    for (let i = 0; i < currentIndex; i++) {
                        completedPhases.add(PHASES[i].name);
                    }
                }
            }
            
            if (currentPhase) {
                lastPhase = currentPhase;
            }
            
            // Find current phase index for mobile carousel
            const currentIndex = currentPhase ? PHASES.findIndex(p => p.name === currentPhase) : -1;
            
            PHASES.forEach((phase, index) => {
                const btn = document.createElement('button');
                btn.className = 'phase-btn';
                btn.textContent = phase.name;
                btn.dataset.phase = phase.name;
                btn.dataset.entryPoint = phase.entryPoint;

                // Check if this phase is active
                if (currentPhase === phase.name) {
                    btn.classList.add('active');
                }
                
                // For mobile carousel: mark previous and next phases
                if (isMobile && currentIndex >= 0) {
                    if (index === currentIndex - 1) {
                        btn.classList.add('prev-phase');
                    } else if (index === currentIndex + 1) {
                        btn.classList.add('next-phase');
                    }
                }

                // Check if this phase is completed
                if (completedPhases.has(phase.name) && currentPhase !== phase.name) {
                    btn.classList.add('completed');
                }

                // Check if entry point exists in FLOW
                if (!FLOW[phase.entryPoint]) {
                    btn.disabled = true;
                }

                // Add click handler - allow clicking on any available phase (including future phases)
                btn.addEventListener('click', () => {
                    if (FLOW[phase.entryPoint] && !btn.disabled) {
                        // If jumping to a future phase, clear completed phases after it
                        const clickedIndex = PHASES.findIndex(p => p.name === phase.name);
                        const currentIndex = PHASES.findIndex(p => p.name === currentPhase);
                        
                        if (clickedIndex > currentIndex || currentPhase === null) {
                            // Jumping ahead - clear completion status for phases after
                            for (let i = clickedIndex; i < PHASES.length; i++) {
                                completedPhases.delete(PHASES[i].name);
                            }
                        }
                        
                        state.history.push(state.current);
                        state.current = phase.entryPoint;
                        render();
                    }
                });

                navEl.appendChild(btn);
            });
            
            // RESTORE SCROLL POSITION immediately after rebuilding (prevents jump to beginning)
            if (isMobile && currentScroll > 0) {
                // Restore scroll position synchronously to prevent visible jump
                navEl.scrollLeft = currentScroll;
            }
            
            // Clear the rebuilding flag after layout completes to allow MutationObserver to work
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    navEl.dataset.isRebuilding = 'false';
                    // Center active phase after rebuild completes
                    if (isMobile) {
                        setTimeout(() => {
                            centerActivePhase();
                        }, 50);
                    }
                });
            });
        }
        
        // Function to center active phase in mobile carousel
        function centerActivePhase() {
            const phaseNav = document.getElementById('phase-navigation');
            if (!phaseNav || window.innerWidth > 767) return;
            
            // Wait for layout to complete
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    const activeBtn = phaseNav.querySelector('.phase-btn.active');
                    if (!activeBtn) return;
                    
                    const containerWidth = phaseNav.offsetWidth;
                    const buttonWidth = activeBtn.offsetWidth;
                    const buttonLeft = activeBtn.offsetLeft;
                    const targetScroll = buttonLeft - (containerWidth / 2) + (buttonWidth / 2);
                    
                    // Check if already close to target
                    const currentScroll = phaseNav.scrollLeft;
                    const scrollDiff = Math.abs(targetScroll - currentScroll);
                    
                    // Only scroll if we're not already close (within 5px for more precision)
                    if (scrollDiff > 5) {
                        phaseNav.scrollTo({
                            left: targetScroll,
                            behavior: 'smooth'
                        });
                    }
                });
            });
        }

        // Mobile phase carousel swipe support
        function initPhaseCarousel() {
            const phaseNav = document.getElementById('phase-navigation');
            if (!phaseNav) return;
            
            // Only enable on mobile
            if (window.innerWidth > 767) return;
            
            let startX = 0;
            let scrollLeft = 0;
            let isDown = false;
            
            phaseNav.addEventListener('mousedown', (e) => {
                isDown = true;
                startX = e.pageX - phaseNav.offsetLeft;
                scrollLeft = phaseNav.scrollLeft;
                phaseNav.style.cursor = 'grabbing';
            });
            
            phaseNav.addEventListener('mouseleave', () => {
                isDown = false;
                phaseNav.style.cursor = 'grab';
            });
            
            phaseNav.addEventListener('mouseup', () => {
                isDown = false;
                phaseNav.style.cursor = 'grab';
            });
            
            phaseNav.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - phaseNav.offsetLeft;
                const walk = (x - startX) * 2;
                phaseNav.scrollLeft = scrollLeft - walk;
            });
            
            // Touch events for mobile swipe
            let touchStartX = 0;
            let touchScrollLeft = 0;
            
            phaseNav.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].pageX - phaseNav.offsetLeft;
                touchScrollLeft = phaseNav.scrollLeft;
            }, { passive: true });
            
            phaseNav.addEventListener('touchmove', (e) => {
                if (!touchStartX) return;
                const x = e.touches[0].pageX - phaseNav.offsetLeft;
                const walk = (x - touchStartX) * 1.5;
                phaseNav.scrollLeft = touchScrollLeft - walk;
            }, { passive: true });
            
            // Track previous active phase to avoid unnecessary scrolling
            let previousActivePhase = null;
            let isScrolling = false;
            
            // Auto-scroll to active phase when it changes - robust approach (backup to direct call)
            const observer = new MutationObserver(() => {
                // Don't scroll if we're currently rebuilding (prevents duplicate scroll handlers)
                if (phaseNav.dataset.isRebuilding === 'true') {
                    return;
                }
                
                // Use the centralized centering function
                if (window.innerWidth <= 767) {
                    // Small delay to ensure layout is complete
                    setTimeout(() => {
                        centerActivePhase();
                    }, 100);
                }
            });
            
            observer.observe(phaseNav, { 
                childList: true, 
                subtree: true, 
                attributes: true, 
                attributeFilter: ['class'] 
            });
        }

        // Update hook to point to current opener
        function updateHookOpener() {
            if (FLOW.hook && FLOW.hook.responses) {
                FLOW.hook.responses.forEach(response => {
                    if (response.label === 'Yes, speaking' || response.label === "Who's calling?") {
                        response.next = currentOpener.state;
                    }
                });
            }
        }

        // Render function
        function render() {
            const node = FLOW[state.current] || FLOW.start;
            
            // Track previous stage to prevent re-animation on same stage
            const previousStage = display && display.dataset.currentStage ? display.dataset.currentStage : null;
            const currentStage = node.stage || state.current;
            const isSameStage = previousStage === currentStage;

            // Update hook to use current opener
            updateHookOpener();

            // Update phase navigation
            buildPhaseNavigation();
            
            // Center active phase on mobile after navigation is built
            if (window.innerWidth <= 767) {
                centerActivePhase();
            }

            // Update opener selector (only show when in opening phase or about to be)
            updateOpenerSelectorVisibility();

            // Build opener buttons
            buildOpenerSelector();

            if (display) {
                // Check if this is initial load or update
                const isInitialLoad = !display.classList.contains('has-content');
                display.classList.add('has-content');
                
                // Store current stage for next comparison
                display.dataset.currentStage = currentStage;
                
                // Only animate on content updates if stage actually changed
                if (!isInitialLoad && !isSameStage) {
                    display.classList.add('updating');
                    
                    // Remove update animation class after it completes
                    setTimeout(() => {
                        display.classList.remove('updating');
                    }, 300);
                }
                
                // Render content
                const html = renderTemplate(node.text || '', 'text');
                display.innerHTML = html;
                
                // Smooth scroll to top of script display (only if stage changed)
                if (!isSameStage) {
                    requestAnimationFrame(() => {
                        display.scrollTop = 0;
                    });
                }
            }

            if (responses) {
                // Track if buttons already exist and if we're on the same stage
                const existingButtons = responses.querySelectorAll('.response-btn, .dial-btn');
                const hadButtons = existingButtons.length > 0;
                const previousResponses = responses.dataset.responseLabels || '';
                const currentResponseLabels = (node.responses || []).map(r => r.label).join(',');
                const sameResponses = previousResponses === currentResponseLabels && hadButtons;
                
                // Store current response labels for next comparison
                responses.dataset.responseLabels = currentResponseLabels;
                
                responses.innerHTML = '';
                responses.classList.remove('full-width');

                if (state.current === 'start') {
                    const btn = document.createElement('button');
                    btn.className = (hadButtons || sameResponses) ? 'dial-btn animated' : 'dial-btn';
                    btn.type = 'button';
                    btn.textContent = 'Dial';
                    btn.addEventListener('click', () => go('pre_call_qualification'));
                    responses.appendChild(btn);
                    responses.classList.add('full-width');
                } else {
                    (node.responses || []).forEach(r => {
                        const b = document.createElement('button');
                        b.className = (hadButtons || sameResponses) ? 'response-btn animated' : 'response-btn';
                        b.type = 'button';
                        b.textContent = r.label;
                        b.addEventListener('click', () => go(r.next));
                        responses.appendChild(b);
                    });
                    if ((node.responses || []).length === 1) responses.classList.add('full-width');
                }
            }

            if (backBtn) {
                backBtn.disabled = state.history.length === 0;
            }
        }

        // Navigation functions
        function go(next) {
            if (!next || !FLOW[next]) return;
            state.history.push(state.current);
            state.current = next;
            render();
        }

        function back() {
            if (state.history.length === 0) return;
            state.current = state.history.pop();
            render();
        }

        function restart() {
            state.current = 'start';
            state.history = [];
            completedPhases.clear();
            lastPhase = null;
            // Reset opener to default
            currentOpener = OPENER_CONFIGS.default;
            availableOpeners = [
                OPENER_CONFIGS.direct_question,
                OPENER_CONFIGS.transparent,
                OPENER_CONFIGS.social_proof
            ];
            
            // Reset phase navigation scroll tracking for mobile
            const phaseNav = document.getElementById('phase-navigation');
            if (phaseNav) {
                phaseNav.dataset.hasScrolled = '';
            }
            
            // Hook will be updated automatically via updateHookOpener() in render()
            render();
        }

        // Show/hide opener selector based on current state
        function updateOpenerSelectorVisibility() {
            const selector = document.getElementById('opener-selector');
            const toolbarContainer = selector?.closest('.toolbar-with-openers');
            const mainContent = selector?.closest('.main-content');
            if (!selector) return;

            const isMobile = window.innerWidth <= 767;
            const currentPhase = getCurrentPhase();
            
            // On mobile: hide if we're past the Opening stage with animation
            if (isMobile) {
                // Show if we're at start, Pre-Call, or Opening stage
                // Hide if we're past Opening (Situation, Problem, etc.)
                const shouldShow = currentPhase === null || 
                    currentPhase === 'Pre-Call' || 
                    currentPhase === 'Opening' ||
                    state.current === 'start' ||
                    state.current === 'pre_call_qualification' ||
                    state.current === 'dialing' ||
                    state.current === 'hook' ||
                    state.current === 'pattern_interrupt_opening' ||
                    state.current.startsWith('opener_');
                
                if (shouldShow) {
                    // Show opener selector - remove exit classes and reset display
                    selector.classList.remove('exiting', 'exited');
                    selector.style.display = 'flex';
                    if (toolbarContainer) toolbarContainer.classList.remove('has-exiting-opener');
                    if (mainContent) {
                        mainContent.classList.remove('has-exiting-opener');
                        // Reset margin-top on content when showing opener again
                        const phaseNav = document.getElementById('phase-navigation');
                        const scriptDisplay = document.getElementById('script-display');
                        const responseContainer = document.querySelector('.response-buttons-container');
                        if (phaseNav) phaseNav.style.marginTop = '';
                        if (scriptDisplay) scriptDisplay.style.marginTop = '';
                        if (responseContainer) responseContainer.style.marginTop = '';
                    }
                } else {
                    // Check if already hidden/exiting to avoid re-triggering animation
                    if (!selector.classList.contains('exiting') && !selector.classList.contains('exited')) {
                        // Calculate exact space that will be freed when opener collapses
                        // Get the full height including padding, margin, border
                        const selectorRect = selector.getBoundingClientRect();
                        const selectorHeight = selectorRect.height;
                        
                        // On mobile, toolbar-with-openers uses flexbox column with 12px gap
                        const computedStyle = window.getComputedStyle(toolbarContainer);
                        const gap = parseFloat(computedStyle.gap) || 12;
                        
                        // Total space to free = opener height + gap between toolbar and opener
                        const totalHeight = selectorHeight + gap;
                        
                        // Store height as CSS variable for animation
                        if (mainContent) {
                            mainContent.style.setProperty('--opener-height', `${totalHeight}px`);
                        }
                        
                        // Start exit animation
                        selector.classList.add('exiting');
                        if (toolbarContainer) toolbarContainer.classList.add('has-exiting-opener');
                        if (mainContent) mainContent.classList.add('has-exiting-opener');
                        
                        // After animation completes, hide it
                        setTimeout(() => {
                            selector.classList.remove('exiting');
                            selector.classList.add('exited');
                        }, 400); // Match animation duration
                    }
                }
            } else {
                // Desktop: always show
                selector.classList.remove('exiting', 'exited');
                selector.style.display = 'flex';
                if (toolbarContainer) toolbarContainer.classList.remove('has-exiting-opener');
                if (mainContent) mainContent.classList.remove('has-exiting-opener');
            }
        }

        // Event listeners
        backBtn.addEventListener('click', back);
        restartBtn.addEventListener('click', restart);

        // ============================================
        // MOBILE DEVICE DETECTION & DRAWER TOGGLE
        // ============================================
        
        // Detect device type
        function detectDevice() {
            const isMobile = window.matchMedia("(max-width: 767px)").matches;
            const isSmallMobile = window.matchMedia("(max-width: 479px)").matches;
            const isTablet = window.matchMedia("(min-width: 768px) and (max-width: 1023px)").matches;
            
            // Store for later use
            window.deviceConfig = {
                isMobile,
                isSmallMobile,
                isTablet,
                width: window.innerWidth,
                height: window.innerHeight
            };
            
            // Apply mobile class to body
            if (isMobile) {
                document.body.classList.add('mobile-mode');
            } else {
                document.body.classList.remove('mobile-mode');
            }
            
            if (isSmallMobile) {
                document.body.classList.add('small-mobile');
            } else {
                document.body.classList.remove('small-mobile');
            }
            
            return { isMobile, isSmallMobile, isTablet };
        }
        
        // Initialize device detection
        detectDevice();
        
        // Re-detect on window resize
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                detectDevice();
            }, 250);
        });
        
        // Mobile drawer toggle functionality
        const tipsToggle = document.getElementById('tipsToggle');
        const tipsPanel = document.getElementById('tipsPanel');
        
        if (tipsToggle && tipsPanel) {
            tipsToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                const isExpanded = tipsPanel.classList.contains('expanded');
                
                if (isExpanded) {
                    tipsPanel.classList.remove('expanded');
                    tipsToggle.textContent = 'Tips & Resources ▼';
                    document.body.classList.remove('drawer-open');
                } else {
                    tipsPanel.classList.add('expanded');
                    tipsToggle.textContent = 'Hide Tips ▲';
                    document.body.classList.add('drawer-open');
                }
            });
            
            // Close drawer when clicking outside (on mobile only)
            document.addEventListener('click', function(event) {
                if (window.deviceConfig && window.deviceConfig.isMobile) {
                    if (!tipsPanel.contains(event.target) && !tipsToggle.contains(event.target)) {
                        if (tipsPanel.classList.contains('expanded')) {
                            tipsPanel.classList.remove('expanded');
                            tipsToggle.textContent = 'Tips & Resources ▼';
                            document.body.classList.remove('drawer-open');
                        }
                    }
                }
            });
            
            // Prevent drawer from closing when clicking inside it
            tipsPanel.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
        
        // Update toggle button visibility on resize
        function updateMobileUI() {
            if (tipsToggle) {
                const isMobile = window.matchMedia("(max-width: 767px)").matches;
                if (!isMobile && tipsPanel) {
                    // Ensure drawer is closed on desktop
                    tipsPanel.classList.remove('expanded');
                    document.body.classList.remove('drawer-open');
                }
            }
        }
        
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                updateMobileUI();
            }, 250);
        });

        // Initial render
        render();
        
        // Build opener selector on load
        buildOpenerSelector();
        
        // Initialize mobile phase carousel
        initPhaseCarousel();
        
        // Re-initialize carousel on resize
        let carouselResizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(carouselResizeTimeout);
            carouselResizeTimeout = setTimeout(function() {
                initPhaseCarousel();
                // Rebuild navigation if switching between mobile/desktop
                buildPhaseNavigation();
            }, 250);
        });
    </script>
</body>
</html>
