<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Choosers CRM Cold Calling Hub</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        /* All CSS is consolidated here for a single-file experience */
        
        /* CSS Variables based on the CRM's dark theme */
        :root {
            --primary-blue: #1e3a8a;
            --secondary-blue: #1e40af;
            --dark-blue: #0f1419;
            --darker-blue: #020617;
            --header-blue: #1e293b;
            --professional-blue: #1e40af;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent-orange: #f59e0b;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --border-color: #475569;
        }

        /* Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--darker-blue) 0%, var(--dark-blue) 100%);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            margin-top: 7px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #334155; }
        ::-webkit-scrollbar-thumb { background: #64748b; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--header-blue) 0%, var(--dark-blue) 100%);
            height: 70px;
            display: flex;
            align-items: center;
            padding: 0 30px;
            position: fixed;
            top: 7px;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border-bottom: 2px solid var(--professional-blue);
        }

        .header-logo {
            width: 45px;
            height: 45px;
            margin-right: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .header-logo img { width: 100%; height: 100%; object-fit: cover; }

        .header-title {
            color: white;
            font-weight: 700;
            font-size: 24px;
            margin-right: 30px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .header-title::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--professional-blue), transparent);
            border-radius: 1px;
        }

        .header-search {
            flex: 1;
            max-width: 500px;
            position: relative;
            margin-right: 30px;
        }

        .header-search input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            color: white;
            font-size: 16px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .header-search input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--professional-blue);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.4), 0 0 20px rgba(30, 64, 175, 0.3);
        }

        .search-clear-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            display: none;
            transition: all 0.3s ease;
        }

        .search-clear-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .search-clear-btn.show {
            display: block;
        }

        .header-search input::placeholder { color: rgba(255, 255, 255, 0.7); }

        .header-search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: auto;
        }

        /* Notification & Profile */
        .notification-bell, .profile-avatar {
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notification-bell:hover, .profile-avatar:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .profile-avatar {
            background: linear-gradient(135deg, var(--professional-blue), var(--secondary-blue));
            border: 2px solid rgba(255, 255, 255, 0.2);
            font-weight: bold;
        }

        .profile-avatar:hover { border-color: var(--professional-blue); }
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Main Layout */
        .main-container {
            display: flex;
            margin-top: 77px;
            height: calc(100vh - 77px);
        }

        .sidebar {
            width: 70px; /* Collapsed width */
            background: linear-gradient(180deg, var(--dark-blue) 0%, var(--darker-blue) 100%);
            color: white;
            padding: 16px 0;
            height: calc(100vh - 70px);
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: width 0.3s ease;
            position: relative;
            overflow-x: hidden;
            z-index: 100;
            border-right: 1px solid #1e293b;
        }

        .sidebar:hover {
            width: 250px; /* Expanded width */
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.5);
        }
        
        .sidebar-menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
            flex-grow: 1;
        }

        .sidebar-menu a.nav-item {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 12px 16px;
            text-decoration: none;
            color: #94a3b8;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
            border-radius: 0 12px 12px 0;
            margin-bottom: 4px;
        }

        .sidebar-menu a.nav-item:hover, .sidebar-menu a.nav-item.active {
            background: linear-gradient(135deg, var(--professional-blue) 0%, var(--primary-blue) 100%);
            border-left-color: white;
            color: white;
            box-shadow: 0 4px 15px rgba(30, 64, 175, 0.3);
        }
        
        .sidebar-menu a.nav-item svg {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            margin-right: 16px;
            transition: margin-right 0.3s ease;
        }
        
        .sidebar:not(:hover) .sidebar-menu a.nav-item svg {
            margin-right: 0;
        }
        
        .sidebar-menu a.nav-item span {
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-weight: 500;
        }
        
        .sidebar:hover .sidebar-menu a.nav-item span {
            opacity: 1;
        }

        .nav-badge {
            position: absolute;
            right: 12px;
            background: #ef4444;
            color: white;
            border-radius: 10px;
            padding: 2px 7px;
            font-size: 10px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
            margin-left: auto;
        }

        .sidebar:hover .nav-badge {
            opacity: 1;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin: 20px 0 15px 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar:hover .nav-section-title {
            opacity: 1;
        }

        .content-area { 
            flex: 1; 
            display: flex; 
            overflow: hidden; 
            margin-top: 0; 
            height: 100%;
        }

        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .right-sidebar {
            width: 350px;
            background: linear-gradient(180deg, var(--dark-blue) 0%, var(--darker-blue) 100%);
            border-left: 1px solid #334155;
            overflow-y: auto;
            padding: 30px 20px;
            flex-shrink: 0;
        }

        .calls-hub-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            height: 100%;
            padding: 24px;
        }
        
        /* Cold Calling Hub styles */
        .calls-hub-main {
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: linear-gradient(135deg, var(--dark-blue) 0%, #1e293b 100%);
            border: 1px solid #334155;
            border-radius: 15px;
            padding: 30px;
            position: relative;
            overflow-y: hidden;
            flex: 1;
        }
        .calls-hub-main-inner {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        .script-display {
            background: #0f1419;
            padding: 20px 30px;
            border-radius: 12px;
            font-size: 1.25rem;
            line-height: 1.6;
            min-height: 250px;
            text-align: left;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            flex-grow: 1;
            overflow-y: auto;
            white-space: normal;
            color: #e2e8f0;
        }
        .script-display.start {
            text-align: center;
        }
        .script-display.ringing {
            animation: ring-pulse 1.5s infinite;
        }
        @keyframes ring-pulse {
            0% { box-shadow: 0 0 0 0 var(--professional-blue); }
            100% { box-shadow: 0 0 0 20px rgba(30, 64, 175, 0); }
        }
        .emphasis { font-weight: bold; }
        .highlight-yellow { background-color: #f59e0b; color: black; padding: 2px 5px; border-radius: 4px; font-weight: bold; display: inline-block;}
        .pause { font-style: italic; opacity: 0.7; }
        .response-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 25px;
            margin-bottom: 20px;
        }
        .response-buttons.full-width {
            grid-template-columns: 1fr;
        }
        .response-btn, .dial-button {
            padding: 14px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .response-btn { background: var(--bg-hover); }
        .response-btn:hover { background: var(--professional-blue); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.3); }
        .dial-button { background: #10b981; font-size: 1.1rem; font-weight: 700; }
        .dial-button:hover { background: #059669; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.3); }
        .calls-hub-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .calls-hub-footer .action-btn {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 12px 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }
        .calls-hub-footer .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #475569;
        }
        .calls-hub-footer .action-btn:hover:not(:disabled) {
            background: var(--professional-blue);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
        .restart-btn-icon {
            background: var(--bg-hover);
            color: var(--text-primary);
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }
        .restart-btn-icon:hover {
            background: var(--professional-blue);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
        .sidebar-card {
            background: linear-gradient(135deg, var(--dark-blue) 0%, #1e293b 100%);
            border: 1px solid #334155;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .sidebar-card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
        }
        .sidebar-input-group { margin-bottom: 12px; }
        .sidebar-input-group label { display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px; }
        .sidebar-input-group input, .sidebar-input-group textarea {
            width: 100%; padding: 8px 12px; border-radius: 8px;
            background: var(--bg-hover); border: 1px solid var(--border-color);
            color: var(--text-primary); font-size: 0.9rem; transition: border-color 0.3s ease;
        }
        .sidebar-input-group textarea { min-height: 120px; resize: vertical; }

        /* Energy Health Check Styles */
        .calculator-wrapper { 
            background: linear-gradient(135deg, var(--dark-blue), var(--header-blue)); 
            border-radius: 15px; 
            padding: 24px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.1); 
            border: 1px solid var(--bg-hover); 
            transition: all 0.3s ease; 
        }
        .form-input { 
            background: var(--bg-hover); 
            border: 2px solid var(--border-color); 
            color: var(--text-primary); 
            border-radius: 12px; 
            padding: 8px; 
            font-size: 14px; 
            width: 100%; 
        }
        .calculate-button { 
            background: linear-gradient(135deg, var(--professional-blue), var(--secondary-blue)); 
            color: white; 
            opacity: 0.4; 
            cursor: not-allowed; 
            font-size: 1rem; 
            font-weight: bold; 
            border-radius: 12px; 
            padding: 12px; 
            margin-top: 16px; 
            transition: all 0.3s ease; 
        }
        .calculate-button.ready { opacity: 1; cursor: pointer; }
        .results-section { 
            background: linear-gradient(135deg, var(--dark-blue), var(--bg-card)); 
            border: 1px solid var(--bg-hover); 
            border-radius: 15px; 
            padding: 24px; 
            margin-top: 24px; 
            animation: fadeIn 0.5s ease-in-out; 
        }
        
    </style>
</head>
<body>
    <div class="header">
        <div class="header-logo">
            <img src="https://cdn.prod.website-files.com/6801ddaf27d1495f8a02fd3f/68645bd391ea20fecb011c85_2656%20Webclip%20PChoosers.png" alt="Power Choosers">
        </div>
        <div class="header-title">CRM Dashboard</div>
        
        <div class="header-search">
            <svg class="header-search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" placeholder="Search accounts, contacts, or anything..." id="global-search">
            <button class="search-clear-btn" id="search-clear-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        
        <div class="header-actions">
            <button class="notification-bell">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
                <div class="notification-badge">3</div>
            </button>
            
            <div class="profile-menu">
                <div class="profile-avatar" id="profile-avatar">
                    <span id="profile-initials">LC</span>
                </div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <nav class="sidebar-menu">
                <div class="nav-section-title">Navigation</div>
                <a href="#" class="nav-item">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    <span>Home</span>
                </a>
                <a href="#" class="nav-item">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span>Contacts</span>
                    <span class="nav-badge">12</span>
                </a>
                <a href="#" class="nav-item">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span>Accounts</span>
                    <span class="nav-badge">8</span>
                </a>

                <div class="nav-section-title">Communication</div>
                <a href="#" class="nav-item active">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                    </svg>
                    <span>Calls</span>
                </a>
                <a href="#" class="nav-item">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                    <span>Emails</span>
                    <span class="nav-badge">5</span>
                </a>
                <a href="#" class="nav-item">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"></path>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                    </svg>
                    <span>Tasks</span>
                    <span class="nav-badge">7</span>
                </a>

                <div class="nav-section-title" style="margin-top: auto;">Settings</div>
                <a href="#" class="nav-item">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    <span>Settings</span>
                </a>
                <a href="#" class="nav-item">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span>Account Details</span>
                </a>
            </nav>
        </div>

        <div class="content-area">
            <div class="main-content flex-1 flex">
                 <div class="calls-hub-layout flex-1">
                    <div class="calls-hub-main">
                        <h2 class="text-2xl font-bold mb-6 text-white text-center">Cold Calling Script</h2>
                        
                        <div class="calls-hub-main-inner">
                            <div class="script-display p-6" id="script-display">
                                Click 'Dial' to begin the call
                            </div>

                            <div class="response-buttons mt-6" id="responses-container">
                                <button class="dial-button" onclick="handleDialClick()">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                                    Dial
                                </button>
                            </div>

                            <div class="calls-hub-footer">
                                <button id="back-btn" class="action-btn" onclick="goBack()" disabled>← Back</button>
                                <button id="restart-btn" class="restart-btn-icon" onclick="restart()">
                                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path d="M21.5 13a9.5 9.5 0 1 1-9.5-9.5V3a.5.5 0 0 0-1 0v.5A9.5 9.5 0 1 1 21.5 13zM12 2v4M12 18v4M22 12h-4M6 12H2M18 18l-3-3M18 6l-3 3M6 18l3-3M6 6l3 3" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-sidebar">
                <div class="sidebar-card">
                    <h3 class="sidebar-card-title">📋 Prospect Info</h3>
                    <div class="sidebar-input-group">
                        <label for="input-phone">Phone Number:</label>
                        <input type="text" id="input-phone" placeholder="(555) 555-5555" oninput="updateScript()">
                    </div>
                    <div class="sidebar-input-group">
                        <label for="input-company-name">Company Name:</label>
                        <input type="text" id="input-company-name" placeholder="ABC Manufacturing" oninput="updateScript()">
                    </div>
                    <div class="sidebar-input-group">
                        <label for="input-name">Contact Name:</label>
                        <input type="text" id="input-name" placeholder="John Smith" oninput="updateScript()">
                    </div>
                    <div class="sidebar-input-group">
                        <label for="input-title">Contact Title:</label>
                        <input type="text" id="input-title" placeholder="Company Leader" oninput="updateScript()">
                    </div>
                    <div class="sidebar-input-group">
                        <label for="input-company-industry">Company Industry:</label>
                        <input type="text" id="input-company-industry" placeholder="businesses" oninput="updateScript()">
                    </div>
                    <div class="sidebar-input-group">
                        <label for="input-benefit">Specific Benefit:</label>
                        <input type="text" id="input-benefit" placeholder="a strategic procurement strategy" oninput="updateScript()">
                    </div>
                    <div class="sidebar-input-group">
                        <label for="input-pain">Pain Point:</label>
                        <input type="text" id="input-pain" placeholder="you're not stuck paying more" oninput="updateScript()">
                    </div>
                </div>

                <div class="sidebar-card">
                    <h3 class="sidebar-card-title">💡 Energy Health Check</h3>
                    <div class="calculator-wrapper">
                        <div class="form-sections">
                            <div class="form-section active" id="section1">
                                <div class="section-header-pill">
                                    <span class="section-icon">1</span> Current Bill
                                </div>
                                <div class="grid grid-cols-1 gap-4">
                                    <div class="input-group">
                                        <label for="currentSupplier" class="input-label text-xs">Current Supplier</label>
                                        <input type="text" class="form-input !p-2 !text-sm" id="currentSupplier" placeholder="e.g., TXU" list="supplierList" oninput="validateSection1()">
                                        <datalist id="supplierList"></datalist>
                                    </div>
                                    <div class="input-group">
                                        <label for="monthlyBill" class="input-label text-xs">Monthly Bill ($)</label>
                                        <input type="number" class="form-input !p-2 !text-sm" id="monthlyBill" placeholder="e.g., 1,450.00" step="0.01" oninput="validateSection1()">
                                    </div>
                                    <div class="input-group">
                                        <label for="currentRate" class="input-label text-xs">Current Rate ($/kWh)</label>
                                        <input type="number" class="form-input !p-2 !text-sm" id="currentRate" placeholder="e.g., 0.062" step="0.001" oninput="validateSection1()">
                                        <div id="rateFeedback" class="input-feedback text-xs"></div>
                                    </div>
                                </div>
                                <div id="usageDisplay" class="usage-display !p-3 mt-3 hidden">
                                    <div class="usage-title text-sm">📊 Client's Usage Analysis</div>
                                    <div class="usage-details text-xs" id="usageDetails"></div>
                                </div>
                            </div>
                            <div class="mt-6"></div>
                            <div class="form-section" id="section2">
                                <div class="section-header-pill">
                                    <span class="section-icon">2</span> Contract & Sell Rate
                                </div>
                                <div class="grid grid-cols-1 gap-4">
                                    <div class="input-group">
                                        <label for="contractEndDate" class="input-label text-xs">Contract End Date</label>
                                        <input type="date" class="form-input !p-2 !text-sm" id="contractEndDate" oninput="validateSection2()">
                                    </div>
                                    <div class="input-group">
                                        <label for="sellRate" class="input-label text-xs">Sell Rate ($/kWh)</label>
                                        <input type="number" class="form-input !p-2 !text-sm" id="sellRate" placeholder="e.g., 0.088" step="0.001" oninput="validateSection2()">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6"></div>
                            <div class="form-section" id="section3">
                                <div class="section-header-pill">
                                    <span class="section-icon">3</span> Get Results
                                </div>
                                <p class="text-sm text-gray-400 text-center">Ready to see the analysis!</p>
                            </div>
                        </div>
                        <button class="calculate-button w-full !p-3 !text-sm !font-bold mt-4" id="calculateBtn" onclick="runCalculation()">
                            Complete All Sections Above
                        </button>
                        <button class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors mt-2 text-sm" id="resetBtn" onclick="resetForm()">
                          Reset Form
                        </button>
                        <div id="loadingAnimation" class="loading-animation">
                            <div class="spinner"></div>
                            <div class="text-gray-400 mt-4 text-sm" id="loadingMessage">Running analysis...</div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-card">
                    <h3 class="sidebar-card-title">📝 Call Notes</h3>
                    <div class="sidebar-input-group">
                        <textarea id="call-notes" placeholder="Type your call notes here..."></textarea>
                    </div>
                    <div class="flex space-x-2">
                        <button class="flex-1 px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition-colors" onclick="saveProspectAndNotes()">Save Notes</button>
                        <button class="flex-1 px-4 py-2 bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600 transition-colors" onclick="clearNotes()">Clear</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBKg28LJZgyI3J--I8mnQXOLGN5351tfaE",
            authDomain: "power-choosers-crm.firebaseapp.com",
            projectId: "power-choosers-crm",
            storageBucket: "power-choosers-crm.firebasestorage.app",
            messagingSenderId: "792458658491",
            appId: "1:792458658491:web:a197a4a8ce7a860cfa1f9e",
            measurementId: "G-XEC3BFHJHW"
        };
        
        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;

        // --- Global Application State and Data ---
        const CRMApp = { 
            currentView: 'calls',
            accounts: [],
            contacts: [],
            activities: [],
            currentProspect: null
        };
        
        // --- Utility Functions ---
        const getEl = id => document.getElementById(id);
        const getEls = selector => document.querySelectorAll(selector);
        
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `fixed top-20 right-6 z-50 p-4 rounded-lg shadow-lg text-white transition-all duration-300 transform translate-x-full opacity-0 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
                toast.classList.add('translate-x-0', 'opacity-100');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('translate-x-0', 'opacity-100');
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- Call Script Logic (Adapted from cold-calling-hub.html) ---
        const scriptData = {
            start: {
                you: "Click 'Dial' to begin the call",
                mood: "neutral",
                responses: []
            },
            dialing: {
                you: "Dialing... Ringing...",
                mood: "neutral",
                responses: [
                    { text: "📞 Call Connected", next: "hook" },
                    { text: "� Transferred - Decision Maker Answers", next: "main_script_start" },
                    { text: "�🚫 No Answer", next: "voicemail_or_hangup" }
                ]
            },
            voicemail_or_hangup: {
                you: "No answer. What would you like to do?",
                mood: "neutral",
                responses: [
                    { text: "Leave Voicemail", next: "voicemail" },
                    { text: "Hang Up / Start New Call", next: "start" }
                ]
            },
            hook: {
                you: "Hi, is this <span class='emphasis'>[N]</span>?",
                mood: "neutral",
                responses: [
                    { text: "✅ Yes, this is [N]", next: "main_script_start" },
                    { text: "�️ Speaking", next: "main_script_start" },
                    { text: "❓ Who's calling?", next: "main_script_start" },
                    { text: "�👥 Gatekeeper / Not the right person", next: "gatekeeper_intro" }
                ]
            },
            main_script_start: {
                you: "Good mornin'/afternoon, <span class='emphasis'>[N]</span> — I'm Lewis with PowerChoosers and I'm needin' to speak with someone over electricity agreements and contracts for <span class='emphasis'>[CN]</span> would that be yourself?",
                mood: "neutral",
                responses: [
                    { text: "✅ Yes, that's me / I handle that", next: "pathA" },
                    { text: "🤝 We both handle it / Team decision", next: "pathA" },
                    { text: "👥 That would be [OP] / Not the right person", next: "gatekeeper_intro" },
                    { text: "🤔 Unsure or hesitant", next: "pathD" }
                ]
            },
            gatekeeper_intro: {
                you: "Good afternoon/morning. I'm needin' to speak with someone over electricity agreements and contracts for <span class='emphasis'>[CN]</span> do you know who would be responsible for that?",
                mood: "neutral",
                responses: [
                    { text: "❓ What's this about?", next: "gatekeeper_whats_about" },
                    { text: "🔗 I'll connect you", next: "transfer_dialing" },
                    { text: "🚫 They're not available / Take a message", next: "voicemail" }
                ]
            },
            gatekeeper_whats_about: {
                you: "My name is Lewis with PowerChoosers.com and I'm needin' to speak with someone about the future electricity agreements for <span class='emphasis'>[CN]</span>. Do you know who might be the best person for that?",
                mood: "neutral",
                responses: [
                    { text: "🔗 I'll connect you", next: "transfer_dialing" },
                    { text: "🚫 They're not available / Take a message", next: "voicemail" },
                    { text: "✅ I can help you", next: "pathA" }
                ]
            },
            transfer_dialing: {
                you: "Great, I'll hold while you connect me. Thank you!",
                mood: "positive",
                responses: [
                    { text: "✅ Connected to Decision Maker", next: "main_script_start" },
                    { text: "🚫 No answer / Went to voicemail", next: "voicemail" }
                ]
            },
            voicemail: {
                you: "Good afternoon/morning <span class='emphasis'>[N]</span>, this is Lewis with PowerChoosers. I was hoping to speak with you about an opportunity to potentially reduce your electricity costs. You can reach me at 817-409-4215. I'll also send you an email with more details. Thank you for your time, and have a great day!",
                mood: "neutral",
                responses: [
                    { text: "🔄 End Call / Start New Call", next: "start" }
                ]
            },
            pathA: {
                you: "Perfect — So <span class='emphasis'>[N]</span> I've been working closely with <span class='emphasis'>[CI]</span> across Texas with electricity agreements — and we're about to see an <span class='emphasis'>unprecedented dip in the market in the next few months</span> — Is getting the best price for your next renewal a priority for you and <span class='emphasis'>[CN]</span>? Do you know when your contract expires?",
                mood: "neutral",
                responses: [
                    { text: "😰 Struggling with high rates", next: "discovery" },
                    { text: "📅 Haven't renewed yet", next: "discovery" },
                    { text: "⏳ Contract ending soon", next: "discovery" },
                    { text: "💰 Looking for better rates", next: "discovery" },
                    { text: "🤔 Not sure about contract", next: "discovery" },
                    { text: "❌ Not interested", next: "softClose" }
                ]
            },
            discovery: {
                you: "Gotcha! So <span class='emphasis'>[N]</span>, just so I understand your situation a little better — What's your current approach to renewing your electricity agreements? Do you handle it internally or work with a consultant?",
                mood: "neutral",
                responses: [
                    { text: "💚 Prospect is engaged / ready for appointment", next: "closeForAppointment" },
                    { text: "🟡 Prospect is hesitant / needs more info", next: "handleHesitation" },
                    { text: "❌ Objection: Happy with current provider", next: "objHappy" },
                    { text: "❌ Objection: No time", next: "objNoTime" }
                ]
            },
            closeForAppointment: {
                you: "Awesome! So, <span class='emphasis'>[N]</span> — I really believe you'll be able to benefit from <span class='emphasis'>[SB]</span> that way you won't have to <span class='emphasis'>[PP]</span>. Our process is super simple! We start with an <span class='emphasis'>energy health check</span> where I look at your usage, contract terms, and then we can talk about what options might look like for <span class='emphasis'>[CN]</span> moving forward. When would be a good time for a quick 10-15 minute chat?",
                mood: "positive",
                responses: [
                    { text: "📅 Schedule Friday 11 AM", next: "callSuccess" },
                    { text: "📅 Schedule Monday 2 PM", next: "callSuccess" },
                    { text: "🤔 Still hesitant", next: "handleHesitation" }
                ]
            },
            handleHesitation: {
                you: "I get it — And I called you out of the blue, so now is probably not the best time... Let me put together a quick case study specific to <span class='emphasis'>[CI]</span> in your area. Would you be open to me sending that over?",
                mood: "understanding",
                responses: [
                    { text: "✅ Yes, send analysis", next: "callSuccess" },
                    { text: "❌ No, not interested", next: "softClose" }
                ]
            },
            objHappy: {
                you: "That's actually great to hear... Is it the customer service that you're happy with or are you just getting a rate that you can't find anywhere else?",
                mood: "neutral",
                responses: [
                    { text: "✅ Yes, worth understanding", next: "closeForAppointment" },
                    { text: "❌ No, not interested", next: "softClose" }
                ]
            },
            objNoTime: {
                you: "I completely get it — that's exactly why most businesses end up overpaying for electricity. They wait until the last minute when they're under pressure to renew. I'm happy to take just 10 minutes to show you what we're seeing in the market for businesses like yours. Would that be okay?",
                mood: "understanding",
                responses: [
                    { text: "✅ Yes, schedule 10-minute assessment", next: "callSuccess" },
                    { text: "❌ Still no time", next: "softClose" }
                ]
            },
            pathD: {
                you: "I understand this might be new information. Many of our clients felt the same way before they saw how we could help. Would you be open to a quick 10-minute conversation where I can explain how we're helping similar <span class='emphasis'>[CI]</span> in your area?",
                mood: "understanding",
                responses: [
                    { text: "✅ Yes, let's talk", next: "closeForAppointment" },
                    { text: "🔄 Let me think about it", next: "handleHesitation" },
                    { text: "❌ Not interested", next: "softClose" }
                ]
            },
            softClose: {
                you: "No problem at all — I know energy strategy isn't urgent until it becomes critical. Here's what I'll do: I'm going to add you to my quarterly market intelligence updates. That way, when the market does dip, you'll be among the first to know. Would that be okay?",
                mood: "neutral",
                responses: [
                    { text: "✅ That sounds reasonable", next: "callSuccess" },
                    { text: "❌ No thanks", next: "callEnd" }
                ]
            },
            callSuccess: {
                you: "🎉 Call Completed Successfully!\n\nRemember to track:\n• Decision maker level\n• Current contract status\n• Pain points identified\n• Interest level\n• Next action committed\n• Follow-up date and time",
                mood: "positive",
                responses: [{ text: "🔄 Start New Call", next: "start", action: "saveProspectAndNotes" }]
            },
            callEnd: {
                you: "Thanks for your time. Have a great day!",
                mood: "neutral",
                responses: [{ text: "🔄 Start New Call", next: "start" }]
            }
        };

        const appState = {
            placeholders: {
                'N': '', 'CN': '', 'CI': '', 'SB': '', 'PP': '', 'P': '', 'OP': 'the responsible party'
            },
            inputMap: {
                'input-name': 'N',
                'input-company-name': 'CN',
                'input-company-industry': 'CI',
                'input-benefit': 'SB',
                'input-pain': 'PP',
                'input-phone': 'P'
            },
            currentStep: 'start',
            history: []
        };
        
        let callActive = false;
        let callTimeout;
        const callRingingSound = new Tone.MembraneSynth().toDestination();

        const displayCurrentStep = () => {
            const step = scriptData[appState.currentStep];
            if (!step) return;
            
            const scriptDisplay = getEl('script-display');
            const responsesContainer = getEl('responses-container');
            const backBtn = getEl('back-btn');
            
            const processedText = applyPlaceholders(step.you);
            
            if (scriptDisplay) {
                scriptDisplay.innerHTML = processedText;
                scriptDisplay.className = `script-display mood-${step.mood}`;
                if (appState.currentStep === 'start') {
                    scriptDisplay.classList.add('start');
                } else {
                    scriptDisplay.classList.remove('start');
                }
            }
            
            if (responsesContainer) {
                responsesContainer.innerHTML = '';
                if (appState.currentStep === 'start') {
                    const dialButtonHtml = `<button class="dial-button" onclick="handleDialClick()">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                            Dial
                        </button>`;
                    responsesContainer.innerHTML = dialButtonHtml;
                } else if (step.responses && step.responses.length > 0) {
                    step.responses.forEach(response => {
                        const button = document.createElement('button');
                        button.className = 'response-btn';
                        button.innerHTML = applyPlaceholders(response.text);
                        button.onclick = () => selectResponse(response.next, response.action);
                        responsesContainer.appendChild(button);
                    });
                    if (step.responses.length === 1) {
                        responsesContainer.classList.add('full-width');
                    } else {
                        responsesContainer.classList.remove('full-width');
                    }
                }
            }
            
            if (backBtn) {
                backBtn.disabled = appState.history.length === 0;
            }
        };

        const applyPlaceholders = (text) => {
            let newText = text;
            for (const key in appState.placeholders) {
                const regex = new RegExp('\\[' + key + '\\]', 'g');
                let replacement = appState.placeholders[key];
                if (key === 'N' && replacement) {
                    replacement = replacement.split(' ')[0];
                }
                newText = newText.replace(regex, replacement);
            }
            return newText.replace(/--/g, '&mdash;');
        };

        const updateScript = () => {
            for (const inputId in appState.inputMap) {
                const placeholderKey = appState.inputMap[inputId];
                const inputElement = getEl(inputId);
                if (inputElement) {
                    const inputValue = inputElement.value || '';
                    appState.placeholders[placeholderKey] = inputValue;
                }
            }
            displayCurrentStep();
        };

        const handleDialClick = () => {
            const phoneNumber = getEl('input-phone').value;
            if (!phoneNumber) {
                alert('Please enter a phone number to dial.');
                return;
            }

            callActive = true;
            getEl('script-display').classList.add('ringing');
            callRingingSound.triggerAttackRelease("C4", "3s");
            
            callTimeout = setTimeout(() => {
                callActive = false;
                callRingingSound.triggerRelease();
                getEl('script-display').classList.remove('ringing');
                selectResponse('dialing');
            }, 3000);
        };
        
        const selectResponse = (nextStep, action) => {
            if (nextStep && scriptData[nextStep]) {
                appState.history.push(appState.currentStep);
                appState.currentStep = nextStep;
                displayCurrentStep();
            }
            if (action === 'saveProspectAndNotes') {
                saveProspectAndNotes();
            }
        };

        const goBack = () => {
            if (appState.history.length > 0) {
                appState.currentStep = appState.history.pop();
                displayCurrentStep();
            }
        };

        const restart = () => {
            appState.currentStep = 'start';
            appState.history = [];
            for(const inputId in appState.inputMap) {
                const input = getEl(inputId);
                if (input) input.value = '';
            }
            getEl('call-notes').value = '';
            resetHealthCheckForm(); // Reset health check form on restart
            updateScript();
        };
        
        const saveProspectAndNotes = async () => {
            const notes = getEl('call-notes').value;
            const log = {
                type: 'call_note',
                description: `Call with ${appState.placeholders.N || 'Unknown Prospect'}`,
                noteContent: notes,
                contactName: appState.placeholders.N,
                accountName: appState.placeholders.CN,
                createdAt: serverTimestamp()
            };

            try {
                await db.collection("activities").add(log);
                showToast('Call notes saved successfully!', 'success');
            } catch (error) {
                console.error("Error saving call notes:", error);
                showToast('Error saving notes.', 'error');
            }

            restart();
        };
        
        const clearNotes = () => {
            getEl('call-notes').value = '';
        };

        // --- Energy Health Check Widget Logic ---
        const supplierData = {
          "NRG": { bbbRating: "A+", popularity: 4, customerService: 3 },
          "TXU": { bbbRating: "A+", popularity: 5, customerService: 4 },
          "APG & E": { bbbRating: "Unaccredited", popularity: 2, customerService: 3 },
          "Reliant": { bbbRating: "A+", popularity: 5, customerService: 3 },
          "Hudson": { bbbRating: "Unaccredited", popularity: 2, customerService: 2 },
          "Green Mountain": { bbbRating: "Unaccredited", popularity: 3, customerService: 2 },
          "Constellation": { bbbRating: "A+", popularity: 4, customerService: 4 },
          "Tara Energy": { bbbRating: "Unaccredited", popularity: 2, customerService: 3 },
          "Cirro": { bbbRating: "A+", popularity: 3, customerService: 4 },
          "Engie": { bbbRating: "A+", popularity: 3, customerService: 1 },
          "Gexa": { bbbRating: "Unaccredited", popularity: 4, customerService: 2 },
          "Freepoint": { bbbRating: "A+", popularity: 1, customerService: 3 },
          "Shell Energy": { bbbRating: "Unaccredited", popularity: 3, customerService: 2 },
          "Ironhorse": { bbbRating: "4.0 stars", popularity: 1, customerService: 3 },
          "Ammper Power": { bbbRating: "Unaccredited", popularity: 1, customerService: 1 }
        };
        const supplierNames = Object.keys(supplierData);
        const ESTIMATED_DELIVERY_CHARGE_CENTS = 0.05;
        let section1Complete = false, section2Complete = false;
        let currentAnnualUsage = 0, currentMonthlyBill = 0, currentRate = 0, sellRate = 0, currentSupplier = '';

        const formatNumber = num => Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

        function activateSection(sectionNumber) {
            for (let i = 1; i <= 3; i++) {
                const section = getEl(`section${i}`);
                const pill = section.querySelector('.section-header-pill');
                const icon = pill.querySelector('.section-icon');
                if (i < sectionNumber) {
                    section.classList.remove('active');
                    section.classList.add('completed');
                    pill.classList.remove('active');
                    pill.classList.add('completed');
                    icon.innerHTML = '✓';
                } else if (i === sectionNumber) {
                    section.classList.add('active');
                    section.classList.remove('completed');
                    pill.classList.add('active');
                    pill.classList.remove('completed');
                    icon.innerHTML = i;
                } else {
                    section.classList.remove('active', 'completed');
                    pill.classList.remove('active', 'completed');
                    icon.innerHTML = i;
                }
            }
        }

        function updateButton() {
            const button = getEl('calculateBtn');
            const isReady = section1Complete && section2Complete;
            button.classList.toggle('ready', isReady);
            button.textContent = isReady ? 'Calculate Savings Potential' : 'Complete All Sections Above';
            button.disabled = !isReady;
        }
        
        function validateSection1() {
            const supplierInput = getEl('currentSupplier');
            const monthlyBillInput = getEl('monthlyBill');
            const currentRateInput = getEl('currentRate');
            
            const supplierValue = supplierInput.value.trim();
            currentMonthlyBill = parseFloat(monthlyBillInput.value);
            currentRate = parseFloat(currentRateInput.value);
            
            const rateFeedback = getEl('rateFeedback');
            const usageDisplay = getEl('usageDisplay');
            const usageDetails = getEl('usageDetails');

            if (rateFeedback) rateFeedback.classList.remove('show', 'feedback-danger', 'feedback-warning', 'feedback-success', 'feedback-info');
            if (usageDisplay) usageDisplay.classList.add('hidden');
            
            if (supplierValue && supplierNames.includes(supplierValue) && currentMonthlyBill > 0 && currentRate > 0) {
                currentSupplier = supplierValue;
                const effectiveCurrentRateAllIn = currentRate + ESTIMATED_DELIVERY_CHARGE_CENTS;
                if (rateFeedback) {
                    rateFeedback.classList.add('show');
                    if (effectiveCurrentRateAllIn <= 0.10) { rateFeedback.className = 'input-feedback show feedback-danger'; rateFeedback.textContent = '🚨 Very old rate - significant increase expected at renewal'; }
                    else if (effectiveCurrentRateAllIn <= 0.12) { rateFeedback.className = 'input-feedback show feedback-warning'; rateFeedback.textContent = '⚠️ Below market rate - likely increase ahead'; }
                    else if (effectiveCurrentRateAllIn <= 0.145) { rateFeedback.className = 'input-feedback show feedback-success'; rateFeedback.textContent = '✅ Current market range - competitive rate'; }
                    else { rateFeedback.className = 'input-feedback show feedback-info'; rateFeedback.textContent = '💰 Above market - savings opportunity available'; }
                }
                const monthlyUsage = (currentMonthlyBill / effectiveCurrentRateAllIn);
                currentAnnualUsage = monthlyUsage * 12;
                if (usageDisplay) {
                    usageDisplay.classList.remove('hidden');
                    let businessSize = (currentAnnualUsage < 50000) ? 'Small Business' : (currentAnnualUsage < 200000) ? 'Medium Business' : 'Large Business';
                    usageDetails.innerHTML = `<strong>Monthly Usage:</strong> ${formatNumber(monthlyUsage)} kWh<br><strong>Annual Usage:</strong> ${formatNumber(currentAnnualUsage)} kWh<br><strong>Business Size:</strong> ${businessSize}`;
                }
                section1Complete = true;
                activateSection(2);
            } else {
                section1Complete = false;
                activateSection(1);
            }
            updateButton();
        }

        function validateSection2() {
            const contractEndDateInput = getEl('contractEndDate');
            const sellRateInput = getEl('sellRate');
            const contractEndDate = contractEndDateInput.value;
            sellRate = parseFloat(sellRateInput.value);
            if (contractEndDate && sellRate > 0) {
                section2Complete = true;
                activateSection(3);
            } else {
                section2Complete = false;
                activateSection(2);
            }
            updateButton();
        }

        const runCalculation = () => {
            if (!section1Complete || !section2Complete) {
              showToast("Please complete all sections.", "error");
              return;
            }
            
            getEl('calculateBtn').style.display = 'none';
            getEl('loadingAnimation').classList.add('show');
            getEl('loadingMessage').textContent = 'Running analysis...';
            getEl('calculator-wrapper').classList.add('is-calculating');
            setTimeout(calculateResults, 1500);
        };
        
        const calculateResults = async () => {
            try {
                const effectiveSellRateAllIn = sellRate + ESTIMATED_DELIVERY_CHARGE_CENTS;
                const annualCurrentCost = currentMonthlyBill * 12;
                const annualProjectedCost = (currentAnnualUsage * effectiveSellRateAllIn);
                const annualSavingsOrIncrease = annualCurrentCost - annualProjectedCost;
                
                const newActivity = {
                    type: 'energy_health_check',
                    description: `Ran energy health check for ${appState.placeholders.CN || 'a prospect'}`,
                    noteContent: `Potential annual savings: $${formatNumber(annualSavingsOrIncrease)}.`,
                    contactName: appState.placeholders.N,
                    accountName: appState.placeholders.CN,
                    createdAt: serverTimestamp()
                };

                await db.collection("activities").add(newActivity);
                showToast("Calculation complete! Saved as activity log.", "success");

            } catch (error) {
                console.error("An error occurred during calculation:", error);
                showToast("An error occurred during calculation.", "error");
            } finally {
                getEl('loadingAnimation').classList.remove('show');
                getEl('calculateBtn').style.display = 'block';
                getEl('calculator-wrapper').classList.remove('is-calculating');
            }
        };
        
        const resetHealthCheckForm = () => {
            if(getEl('currentSupplier')) getEl('currentSupplier').value = '';
            if(getEl('monthlyBill')) getEl('monthlyBill').value = '';
            if(getEl('currentRate')) getEl('currentRate').value = '';
            if(getEl('sellRate')) getEl('sellRate').value = '';
            if(getEl('contractEndDate')) getEl('contractEndDate').value = '';
            if (getEl('usageDisplay')) getEl('usageDisplay').classList.add('hidden');
            if (getEl('rateFeedback')) getEl('rateFeedback').classList.remove('show');
            
            const results = getEl('results');
            if(results) results.remove();
            
            section1Complete = false;
            section2Complete = false;
            
            activateSection(1);
            updateButton();
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            updateScript();
            
            activateSection(1);
            updateButton(); 
            const datalist = getEl('supplierList');
            supplierNames.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier;
                datalist.appendChild(option);
            });
        });
    </script>
</body>
</html>
