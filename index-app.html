<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Choosers CRM</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: #1e293b;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Fixed Top Navigation Bar */
        .top-nav {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            padding: 8px 0;
            box-shadow: 0 8px 32px rgba(0,0,0,.08);
            border-bottom: 1px solid rgba(30,90,168,.1);
            z-index: 1000;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            height: 100%;
        }

        .nav-left-title h1 {
            font-size: 1.6rem;
            font-weight: 800;
            color: #1A438D;
            margin: 0;
        }

        .nav-icons-center {
            display: flex;
            justify-content: flex-end;
            flex-grow: 1;
            gap: 25px;
        }

        .app-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: 0 4px 16px rgba(0,0,0,.06);
            border: 1px solid rgba(30,90,168,.1);
            cursor: pointer;
            transition: all .3s ease;
            position: relative;
            text-decoration: none;
            padding: 4px;
        }

        .app-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(0,0,0,.12);
        }

        .app-button.active {
            background: linear-gradient(145deg, #1A438D 0%, #2563EB 100%);
            color: white;
        }

        .app-button.active .app-icon {
            filter: brightness(0) invert(1);
            background: rgba(255,255,255,0.15);
        }

        .app-button.active .app-label {
            color: white;
        }

        .app-button.active .app-icon-svg {
            color: white;
        }

        .app-icon {
            width: 22px;
            height: 22px;
            border-radius: 4px;
            margin: 0 0 2px 0;
            object-fit: contain;
            background: rgba(107, 114, 128, 0.1);
            padding: 3px;
            transition: all .3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .app-icon-svg {
            width: 22px;
            height: 22px;
            color: #374151;
            margin: 0 0 2px 0;
            transition: color .3s ease;
            background: rgba(107, 114, 128, 0.1);
            border-radius: 4px;
            padding: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .app-label {
            font-size: .55rem;
            font-weight: 600;
            color: #374151;
            text-align: center;
            line-height: 1.1;
            white-space: nowrap;
            margin-top: 2px;
        }

        /* Search Bar */
        .search-bar {
            position: fixed;
            top: 80px; 
            left: 0;
            right: 0;
            background: white;
            border-bottom: 2px solid #1A438D;
            box-shadow: 0 8px 32px rgba(26,67,141,.15);
            padding: 0;
            height: 0;
            overflow: hidden;
            transition: all .3s ease;
            z-index: 500;
        }
        .search-bar.active {
            height: 70px;
            padding: 15px;
        }
        .search-container {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .search-label {
            font-size: 1rem;
            font-weight: 600;
            color: #1A438D;
            min-width: 140px;
        }
        .search-input {
            flex: 2;
            padding: 10px 14px;
            font-size: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            color: #1e293b;
        }
        .search-input.city, .search-input.state, .search-input.location {
            flex: 1;
        }
        .search-input:focus {
            outline: none;
            border-color: #1A438D;
        }
        .search-actions {
            display: flex;
            gap: 8px;
        }
        .search-btn {
            background: #1A438D;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
        .search-btn.close {
            background: #6b7280;
            padding: 8px 10px;
        }

        /* Search Results Dropdown */
        .search-results {
            position: absolute;
            top: 100%;
            left: 15px;
            right: 15px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 8px 24px rgba(0,0,0,.12);
            z-index: 1000;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background-color .3s ease;
        }

        .search-result-item:hover {
            background: #f8fafc;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-name {
            font-weight: 600;
            color: #1A438D;
            margin-bottom: 4px;
        }

        .search-result-info {
            font-size: .85rem;
            color: #64748b;
        }

        .search-result-type {
            display: inline-block;
            background: #e2e8f0;
            color: #64748b;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: .75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .view-all-btn {
            display: block;
            width: 100%;
            padding: 12px 16px;
            background: #f8fafc;
            border: none;
            text-align: center;
            font-weight: 600;
            color: #1A438D;
            cursor: pointer;
            transition: background-color .3s ease;
        }

        .view-all-btn:hover {
            background: #f1f5f9;
        }

        /* Main Container */
        .main-container {
            margin-top: 80px;
            padding: 15px;
            flex-grow: 1;
            overflow: hidden;
            height: calc(100vh - 80px);
        }

        .main-container.search-active {
            margin-top: 150px;
            height: calc(100vh - 150px);
        }

        /* View Management */
        .view-container {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            height: 100%;
            overflow: hidden;
        }

        .view-container.active {
            display: block;
        }

        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .view-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #1A438D;
        }

        /* Primary Button Styling */
        .primary-btn, .action-btn {
            background: linear-gradient(135deg, #1A438D 0%, #2563EB 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            font-size: .9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all .3s ease;
            box-shadow: 0 4px 16px rgba(26,67,141,.2);
            margin-bottom: 12px;
        }

        .primary-btn:hover, .action-btn:hover {
            background: linear-gradient(135deg, #153775 0%, #1D4ED8 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(26,67,141,.3);
        }

        .secondary-btn {
            background: #e2e8f0;
            color: #64748b;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            font-size: .9rem;
            transition: all .3s ease;
        }

        .secondary-btn:hover {
            background: #cbd5e1;
            color: #475569;
        }

        .back-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: .9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all .3s ease;
        }

        .back-btn:hover {
            background: #4b5563;
        }

        /* Dashboard Layout */
        .dashboard-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            height: 100%;
            overflow: hidden;
        }

        .dashboard-main {
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            padding-right: 8px;
            margin-right: -8px;
            height: 100%;
        }

        .dashboard-main::-webkit-scrollbar {width: 8px;}
        .dashboard-main::-webkit-scrollbar-track {background: #f1f5f9; border-radius: 4px;}
        .dashboard-main::-webkit-scrollbar-thumb {background: #1A438D; border-radius: 4px;}

        .dashboard-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            padding-right: 8px;
            margin-right: -8px;
            height: 100%;
        }

        .dashboard-sidebar::-webkit-scrollbar {width: 8px;}
        .dashboard-sidebar::-webkit-scrollbar-track {background: #f1f5f9; border-radius: 4px;}
        .dashboard-sidebar::-webkit-scrollbar-thumb {background: #1A438D; border-radius: 4px;}

        /* Quick Actions Layout */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .quick-action-main {
            grid-column: 1 / 4;
            grid-row: 1;
        }

        .quick-action-item {
            grid-row: 2;
        }

        /* Chart Container */
        .chart-container {
            width: 100%;
            height: 300px;
            background: #f8fafc;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .chart-placeholder {
            text-align: center;
            color: #64748b;
        }

        /* Mini Stat Cards */
        .mini-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .mini-stat-card {
            background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #0288d1;
        }

        .mini-stat-number {
            font-size: 1.2rem;
            font-weight: 800;
            color: #0277bd;
            display: block;
        }

        .mini-stat-label {
            font-size: .7rem;
            color: #0d47a1;
            font-weight: 600;
        }

        /* Contact Management */
        .contact-management {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .contact-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 8px 12px;
            background: #f8fafc;
            border-radius: 6px;
            border-left: 3px solid #1A438D;
        }

        .contact-item-info {
            flex-grow: 1;
        }

        .contact-item-name {
            font-weight: 600;
            font-size: .85rem;
            color: #1A438D;
        }

        .contact-item-detail {
            font-size: .75rem;
            color: #64748b;
        }

        .contact-item-actions {
            display: flex;
            gap: 4px;
        }

        .mini-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: .7rem;
            cursor: pointer;
            transition: all .3s ease;
        }

        .mini-btn.edit {
            background: #e2e8f0;
            color: #64748b;
        }

        .mini-btn.delete {
            background: #fee2e2;
            color: #dc2626;
        }

        .mini-btn:hover.edit {
            background: #cbd5e1;
        }

        .mini-btn:hover.delete {
            background: #fecaca;
        }}

        /* Account Detail Layout */
        .account-detail-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            height: 100%;
            overflow: hidden;
        }

        .account-detail-main {
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            padding-right: 8px;
            margin-right: -8px;
        }

        .account-detail-main::-webkit-scrollbar {width: 8px;}
        .account-detail-main::-webkit-scrollbar-track {background: #f1f5f9; border-radius: 4px;}
        .account-detail-main::-webkit-scrollbar-thumb {background: #1A438D; border-radius: 4px;}

        .account-detail-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            padding-right: 8px;
            margin-right: -8px;
        }

        .account-detail-sidebar::-webkit-scrollbar {width: 8px;}
        .account-detail-sidebar::-webkit-scrollbar-track {background: #f1f5f9; border-radius: 4px;}
        .account-detail-sidebar::-webkit-scrollbar-thumb {background: #1A438D; border-radius: 4px;}

        /* Cards */
        .crm-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, .06);
            border: 1px solid rgba(30, 90, 168, .1);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1A438D;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #fef7ff 0%, #f3e8ff 100%);
            padding: 14px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #c084fc;
        }

        .stat-number {
            font-size: 1.6rem;
            font-weight: 800;
            color: #7c3aed;
            display: block;
        }

        .stat-label {
            font-size: .75rem;
            color: #6b21a8;
            font-weight: 600;
        }

        /* Grids */
        .accounts-grid, .contacts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            overflow-y: auto;
            padding-right: 8px;
            margin-right: -8px;
            max-height: calc(100vh - 200px);
        }

        .accounts-grid::-webkit-scrollbar, .contacts-grid::-webkit-scrollbar {width: 8px;}
        .accounts-grid::-webkit-scrollbar-track, .contacts-grid::-webkit-scrollbar-track {background: #f1f5f9; border-radius: 4px;}
        .accounts-grid::-webkit-scrollbar-thumb, .contacts-grid::-webkit-scrollbar-thumb {background: #1A438D; border-radius: 4px;}

        .account-card, .contact-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,.06);
            border: 1px solid rgba(30,90,168,.1);
            cursor: pointer;
            transition: all .3s ease;
        }

        .account-card:hover, .contact-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0,0,0,.12);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .card-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1A438D;
            margin-bottom: 4px;
        }

        .card-subtitle {
            font-size: .9rem;
            color: #64748b;
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            background: transparent;
            border: none;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all .3s ease;
            color: #6b7280;
        }

        .icon-btn:hover {
            background: rgba(107, 114, 128, .1);
            color: #374151;
        }

        /* New Add Notes Button Styling */
        .add-notes-btn {
            background: linear-gradient(135deg, #1A438D 0%, #2563EB 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: .9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all .3s ease;
            box-shadow: 0 4px 16px rgba(26,67,141,.2);
        }

        .add-notes-btn:hover {
            background: linear-gradient(135deg, #153775 0%, #1D4ED8 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(26,67,141,.3);
        }

        .add-notes-btn svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, .5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all .3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 0;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,.08);
            border: 1px solid rgba(30,90,168,.1);
            transform: scale(.9);
            transition: transform .3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 24px 0 24px;
            margin-bottom: 24px;
        }

        .modal-header h3 {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1A438D;
        }

        .close-btn {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 4px;
            border-radius: 4px;
            transition: color .3s ease;
        }

        .close-btn:hover {
            color: #374151;
        }

        /* Forms */
        form {
            padding: 0 24px 24px 24px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: .9rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: .9rem;
            color: #1e293b;
            transition: border-color .3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1A438D;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #e2e8f0;
        }

        /* Account Detail Specific */
        #account-info-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .info-field {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-left: 4px solid #F7921F;
            padding: 14px;
            border-radius: 0 8px 8px 0;
        }

        .info-field-label {
            font-size: .8rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .info-field-value {
            font-size: .9rem;
            color: #1e293b;
            font-weight: 500;
        }

        .contact-list-item {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-left: 4px solid #F7921F;
            padding: 14px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contact-info {
            display: flex;
            flex-direction: column;
        }

        .contact-name {
            font-weight: 600;
            color: #1A438D;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .contact-title {
            font-size: .85rem;
            color: #64748b;
        }

        /* Activities */
        .activity-item {
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 14px;
            margin-bottom: 14px;
        }

        .activity-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .activity-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 6px;
            font-size: .9rem;
            line-height: 1.4;
        }

        .activity-content {
            color: #64748b;
            font-size: .8rem;
            line-height: 1.4;
            margin-bottom: 6px;
        }

        .activity-date {
            color: #64748b;
            font-size: .8rem;
            line-height: 1.4;
            margin-bottom: 6px;
        }

        /* Sidebar specific styles */
        #account-note-input {
            width: 100%;
            height: 150px;
            padding: 10px;
            background: white;
            color: #1e293b;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-family: inherit;
            font-size: .85rem;
            line-height: 1.4;
            resize: vertical;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        #energy-contract-display {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            color: #9ca3af;
            font-style: italic;
            padding: 40px 20px;
            font-size: .9rem;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, .8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all .3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #1A438D;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 4000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            background: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,.12);
            border-left: 4px solid #22c55e;
            min-width: 300px;
            transform: translateX(400px);
            transition: transform .3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .toast.warning {
            border-left-color: #f59e0b;
        }

        .toast.info {
            border-left-color: #3b82f6;
        }

        .toast-message {
            font-size: .9rem;
            color: #1e293b;
            font-weight: 500;
        }

        /* CALLING HUB STYLES */
        .container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            height: 100%;
            max-width: 1400px;
            margin: 0 auto;
            overflow: hidden;
        }

        .main-content {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, .06);
            border: 1px solid rgba(30, 90, 168, .1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            overflow-y: auto;
        }

        .script-display {
            font-size: 1.1rem;
            line-height: 1.6;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 20px;
            min-height: 200px;
            border-left: 4px solid #e2e8f0;
            flex-grow: 1;
            overflow-y: auto;
        }

        .script-display.mood-neutral {
            border-left-color: #6b7280;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .script-display.mood-positive {
            border-left-color: #22c55e;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .script-display.mood-challenging {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .script-display.mood-unsure {
            border-left-color: #8b5cf6;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }

        .pause {
            color: #6b7280;
            font-style: italic;
        }

        .emphasis {
            font-weight: 600;
            color: #1A438D;
        }

        .metric {
            font-weight: 700;
            color: #dc2626;
        }

        .responses-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .response-btn {
            background: linear-gradient(135deg, #1A438D 0%, #2563EB 100%);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: .9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all .3s ease;
            text-align: left;
            box-shadow: 0 4px 16px rgba(26,67,141,.2);
        }

        .response-btn:hover {
            background: linear-gradient(135deg, #153775 0%, #1D4ED8 100%);
            transform: translateY(-2px);
        }

        .dial-button {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all .3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(34,197,94,.25);
        }

        .dial-button:hover {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(34,197,94,.35);
        }

        .dial-button svg {
            width: 20px;
            height: 20px;
        }

        .nav-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .nav-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: .9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all .3s ease;
        }

        .nav-btn:hover:not(:disabled) {
            background: #4b5563;
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            padding-right: 8px;
            margin-right: -8px;
        }

        .sidebar::-webkit-scrollbar {width: 8px;}
        .sidebar::-webkit-scrollbar-track {background: #f1f5f9; border-radius: 4px;}
        .sidebar::-webkit-scrollbar-thumb {background: #1A438D; border-radius: 4px;}

        .sidebar-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, .06);
            border: 1px solid rgba(30, 90, 168, .1);
        }

        .sidebar-title {
            font-size: 1rem;
            font-weight: 700;
            color: #1A438D;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            font-size: .8rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .input-group input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: .85rem;
            color: #1e293b;
            transition: border-color .3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #1A438D;
        }

        .input-group input.editable-locked:focus {
            background: #f8fafc;
        }

        #call-notes {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-family: inherit;
            font-size: .8rem;
            line-height: 1.4;
            resize: vertical;
            color: #1e293b;
        }

        #call-notes:focus {
            outline: none;
            border-color: #1A438D;
        }

        #copy-status {
            font-size: .8rem;
            color: #22c55e;
            opacity: 0;
            transition: opacity .3s ease;
            text-align: center;
            margin-top: 8px;
        }

        .tip-item {
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
            font-size: .8rem;
            line-height: 1.4;
            color: #4b5563;
        }

        .tip-item:last-child {
            border-bottom: none;
        }

        .tip-item strong {
            color: #1A438D;
            font-weight: 600;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .news-item {
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .news-item:last-child {
            border-bottom: none;
        }

        .news-title {
            font-size: .85rem;
            font-weight: 600;
            color: #1A438D;
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .news-summary {
            font-size: .75rem;
            color: #4b5563;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .news-talking-point {
            font-size: .75rem;
            color: #059669;
            line-height: 1.4;
            font-style: italic;
            background: rgba(5, 150, 105, 0.05);
            padding: 6px 8px;
            border-left: 2px solid #059669;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard-layout,
            .account-detail-layout,
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
                height: auto;
                overflow: visible;
            }
            
            .dashboard-sidebar,
            .account-detail-sidebar,
            .sidebar {
                flex-direction: row;
                overflow-x: auto;
                max-height: none;
                padding-bottom: 10px;
                padding-right: 0;
                margin-right: 0;
            }
            
            .dashboard-sidebar .crm-card,
            .account-detail-sidebar .crm-card,
            .sidebar .sidebar-card {
                min-width: 300px;
                flex-shrink: 0;
            }
        }

        @media (max-width: 768px) {
            .nav-container {
                gap: 12px;
                padding: 0 15px;
            }
            
            .app-button {
                width: 50px;
                height: 50px;
            }
            
            .app-icon,
            .app-icon-svg {
                width: 18px;
                height: 18px;
            }
            
            .app-label {
                font-size: .45rem;
            }
            
            .nav-icons-center {
                gap: 15px;
            }
        }
    </style>
    </head>
<body>
    <div class="top-nav">
        <div class="nav-container">
            <div class="nav-left-title">
                <h1 id="page-title">Power Choosers CRM</h1>
            </div>
            <div class="nav-icons-center">
                <button class="app-button active" id="dashboard-btn" data-view="dashboard">
                    <svg class="app-icon-svg" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                    <span class="app-label">Dashboard</span>
                </button>
                
                <button class="app-button" id="accounts-btn" data-view="accounts">
                    <svg class="app-icon-svg" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="m22 21-1.5-1.5"/>
                        <circle cx="19" cy="17" r="3"/>
                    </svg>
                    <span class="app-label">Accounts</span>
                </button>
                
                <button class="app-button" id="contacts-btn" data-view="contacts">
                    <svg class="app-icon-svg" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="m22 21-3-3"/>
                        <circle cx="19" cy="17" r="3"/>
                    </svg>
                    <span class="app-label">Contacts</span>
                </button>

                <button class="app-button" id="calls-hub-btn" data-view="calls-hub">
                    <svg class="app-icon-svg" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                    </svg>
                    <span class="app-label">Calls Hub</span>
                </button>

                <div class="app-button" id="google-button">
                    <img src="https://cdn.prod.website-files.com/6801ddaf27d1495f8a02fd3f/688851441ed944ec9f407f68_Google__G__logo.svg.png" alt="Google" class="app-icon">
                    <span class="app-label">Google</span>
                </div>
                <div class="app-button" id="maps-button">
                    <img src="https://cdn.prod.website-files.com/6801ddaf27d1495f8a02fd3f/6888d37e95a4c0686b08c267_images.jpg" alt="Google Maps" class="app-icon">
                    <span class="app-label">Maps</span>
                </div>
                <div class="app-button" id="apollo-button">
                    <img src="https://cdn.prod.website-files.com/6801ddaf27d1495f8a02fd3f/688851d2771f4c6e42a09731_images.png" alt="Apollo" class="app-icon">
                    <span class="app-label">Apollo</span>
                </div>
                <div class="app-button" id="beenverified-button">
                    <img src="https://cdn.prod.website-files.com/6801ddaf27d1495f8a02fd3f/68885144c4bbad742f397a18_unnamed.png" alt="BeenVerified" class="app-icon">
                    <span class="app-label">BeenVerified</span>
                </div>
            </div>
            <div class="nav-right-logo"></div>
        </div>
    </div>
    
    <div class="search-bar" id="search-bar">
        <div class="search-container">
            <div class="search-label" id="search-label">Search:</div>
            <input type="text" class="search-input" id="search-input" placeholder="Type to search...">
            <input type="text" class="search-input city" id="search-city" placeholder="City" style="display:none">
            <input type="text" class="search-input state" id="search-state" placeholder="State" style="display:none">
            <input type="text" class="search-input location" id="search-location" placeholder="Location (e.g. Fort Worth, TX)" style="display:none">
            <div class="search-actions">
                <button class="search-btn" onclick="performSearch()">Go</button>
                <button class="search-btn close" onclick="closeSearch()">âœ•</button>
            </div>
        </div>
        <div class="search-results" id="search-results"></div>
    </div>

    <div class="main-container" id="main-container">
        
        <div class="view-container active" id="dashboard-view">
            <div class="dashboard-layout">
                <div class="dashboard-main">
                    <div class="crm-card">
                        <h2 class="card-title">ðŸ“Š Dashboard Overview</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <span class="stat-number" id="total-accounts">0</span>
                                <span class="stat-label">Total Accounts</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number" id="total-contacts">0</span>
                                <span class="stat-label">Total Contacts</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number" id="recent-activities">0</span>
                                <span class="stat-label">Recent Activities</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-number" id="hot-leads">0</span>
                                <span class="stat-label">Hot Leads</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="crm-card">
                        <h2 class="card-title">ðŸ”¥ Recent Activities</h2>
                        <div id="recent-activities-list">
                            <p class="empty-state">No recent activities</p>
                        </div>
                    </div>

                    <div class="crm-card">
                        <h2 class="card-title">ðŸ“ˆ Texas Electricity Market Trends</h2>
                        <div class="chart-container" id="market-chart">
                            <div class="chart-placeholder">
                                <h3 style="color: #1A438D; margin-bottom: 8px;">Historical & Projected Pricing</h3>
                                <p style="font-size: .9rem; margin-bottom: 16px;">Texas ERCOT Average Rates (Â¢/kWh)</p>
                                <div style="display: flex; justify-content: space-around; margin-bottom: 20px;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: bold; color: #22c55e;">8.2Â¢</div>
                                        <div style="font-size: .8rem; color: #64748b;">2019-2021 Avg</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">13.1Â¢</div>
                                        <div style="font-size: .8rem; color: #64748b;">Current 2025</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: bold; color: #dc2626;">16.8Â¢</div>
                                        <div style="font-size: .8rem; color: #64748b;">Projected 2026</div>
                                    </div>
                                </div>
                                <div style="font-size: .8rem; color: #059669; background: rgba(5, 150, 105, 0.1); padding: 8px; border-radius: 6px;">
                                    ðŸ“Š Market Intelligence: Supply constraints expected to drive 28% price increase by 2026
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="crm-card">
                        <h2 class="card-title">âš¡ Energy Contract Pipeline</h2>
                        <div class="mini-stats-grid">
                            <div class="mini-stat-card">
                                <span class="mini-stat-number">23</span>
                                <span class="mini-stat-label">Expiring Q2 2025</span>
                            </div>
                            <div class="mini-stat-card">
                                <span class="mini-stat-number">47</span>
                                <span class="mini-stat-label">Expiring Q3 2025</span>
                            </div>
                            <div class="mini-stat-card">
                                <span class="mini-stat-number">$2.3M</span>
                                <span class="mini-stat-label">Pipeline Value</span>
                            </div>
                            <div class="mini-stat-card">
                                <span class="mini-stat-number">34%</span>
                                <span class="mini-stat-label">Close Rate</span>
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding: 10px; background: linear-gradient(135deg, #fef7ff 0%, #f3e8ff 100%); border-radius: 8px; border-left: 4px solid #8b5cf6;">
                            <div style="font-size: .85rem; font-weight: 600; color: #7c3aed; margin-bottom: 4px;">Priority Renewals This Month</div>
                            <div style="font-size: .75rem; color: #6b21a8;">â€¢ Manufacturing Corp (500kW) - Expires 8/15</div>
                            <div style="font-size: .75rem; color: #6b21a8;">â€¢ Healthcare Systems (1.2MW) - Expires 8/28</div>
                            <div style="font-size: .75rem; color: #6b21a8;">â€¢ Tech Campus (850kW) - Expires 8/31</div>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-sidebar">
                    <div class="crm-card">
                        <h2 class="card-title">âš¡ Quick Actions</h2>
                        <div class="quick-actions-grid">
                            <button class="action-btn quick-action-main" id="go-to-calls-hub-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                                </svg>
                                Go to Calls Hub
                            </button>
                            <button class="action-btn quick-action-item" id="add-account-btn">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 8v8M8 12h8"/>
                                </svg>
                                Add Account
                            </button>
                            <button class="action-btn quick-action-item" id="add-contact-btn">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M19 8v6M22 11h-6"/>
                                </svg>
                                Add Contact
                            </button>
                            <button class="action-btn quick-action-item" id="bulk-import-btn">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                                Bulk Import
                            </button>
                        </div>
                    </div>
                    
                    <div class="crm-card">
                        <h2 class="card-title">ðŸ“ž Today's Calls</h2>
                        <div id="todays-calls">
                            <p class="empty-state">No calls scheduled</p>
                        </div>
                    </div>

                    <div class="crm-card">
                        <h2 class="card-title">ðŸ“° Energy Market News</h2>
                        <div class="news-item">
                            <div class="news-title">ERCOT Demand Could Exceed Supply by 2026</div>
                            <div class="news-summary">Grid operator warns electricity demand may surpass available supply as soon as summer 2026, driven by massive data center growth and extreme weather patterns.</div>
                            <div class="news-talking-point">ðŸ’¬ "With ERCOT projecting supply shortages, how is your company preparing for potential capacity constraints?"</div>
                        </div>
                        
                        <div class="news-item">
                            <div class="news-title">Data Centers Drive 218GW Demand Surge</div>
                            <div class="news-summary">Texas electricity demand projected to reach 218GW by 2031 - more than doubling current levels. AI data centers alone account for 86GW of new demand growth.</div>
                            <div class="news-talking-point">ðŸ’¬ "Are you factoring the massive industrial load growth into your energy procurement strategy?"</div>
                        </div>
                        
                        <div class="news-item">
                            <div class="news-title">Texas Wholesale Prices Expected to Drop Short-Term</div>
                            <div class="news-summary">EIA forecasts ERCOT North Hub prices to decrease to $27-34/MWh in 2025 due to solar expansion, but forward contracts remain elevated at $50+/MWh reflecting market risk.</div>
                            <div class="news-talking-point">ðŸ’¬ "Are you taking advantage of current market conditions to lock in favorable rates?"</div>
                        </div>
                    </div>

                    <div class="crm-card">
                        <h2 class="card-title">ðŸ‘¥ Contact Management</h2>
                        <div class="contact-management" id="dashboard-contacts">
                            <p class="empty-state">No contacts to display</p>
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                            <button class="mini-btn edit" onclick="showView('contacts')">View All</button>
                            <button class="mini-btn edit" id="quick-add-contact">+ Quick Add</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="view-container" id="accounts-view">
            <div class="view-header">
                <h2>ðŸ¢ Accounts</h2>
                <button class="primary-btn" id="new-account-btn">+ New Account</button>
            </div>
            <div class="accounts-grid" id="accounts-grid">
                <p class="empty-state">No accounts found. Click "New Account" to get started.</p>
            </div>
        </div>

        <div class="view-container" id="contacts-view">
            <div class="view-header">
                <h2>ðŸ‘¤ Contacts</h2>
                <button class="primary-btn" id="new-contact-btn">+ New Contact</button>
            </div>
            <div class="contacts-grid" id="contacts-grid">
                <p class="empty-state">No contacts found. Click "New Contact" to get started.</p>
            </div>
        </div>

        <div class="view-container" id="account-detail-view">
            <div class="account-detail-layout">
                <div class="account-detail-main">
                    <div class="view-header">
                        <button class="back-btn" id="back-to-accounts">â† Back to Accounts</button>
                        <h2 id="account-detail-title">Account Details</h2>
                        <button class="primary-btn" id="edit-account-btn">Edit Account</button>
                    </div>
                    
                    <div class="crm-card">
                        <h3 class="card-title">ðŸ¢ Company Information</h3>
                        <div id="account-info-display">
                        </div>
                    </div>
                    
                    <div class="crm-card">
                        <h3 class="card-title">ðŸ‘¥ Contacts at this Account</h3>
                        <div id="account-contacts-list">
                            <p class="empty-state">No contacts for this account</p>
                        </div>
                    </div>
                    
                    <div class="crm-card">
                        <h3 class="card-title">ðŸ“ Recent Activities</h3>
                        <div id="account-activities-list">
                            <p class="empty-state">No recent activities</p>
                        </div>
                    </div>
                </div>
                
                <div class="account-detail-sidebar">
                    <div class="crm-card">
                        <h3 class="card-title">âš¡ Energy Contract Details</h3>
                        <form id="energy-contract-form">
                            <div class="input-group">
                                <label for="contract-provider">Current Provider:</label>
                                <input type="text" id="contract-provider" placeholder="Enter provider name">
                            </div>
                            <div class="input-group">
                                <label for="contract-rate">Current Rate:</label>
                                <input type="text" id="contract-rate" placeholder="e.g. 12.5Â¢/kWh">
                            </div>
                            <div class="input-group">
                                <label for="contract-expiration">Contract Expiration:</label>
                                <input type="date" id="contract-expiration">
                            </div>
                            <div class="input-group">
                                <label for="contract-type">Contract Type:</label>
                                <select id="contract-type">
                                    <option value="">Select type</option>
                                    <option value="fixed">Fixed Rate</option>
                                    <option value="variable">Variable Rate</option>
                                    <option value="indexed">Indexed Rate</option>
                                </select>
                            </div>
                            <button class="primary-btn" type="submit">Save Contract Info</button>
                        </form>
                    </div>
                    
                    <div class="crm-card">
                        <h3 class="card-title">ðŸ“ Add Note</h3>
                        <textarea id="account-note-input" placeholder="Add a note about this account..."></textarea>
                        <button class="primary-btn" id="save-account-note">Save Note</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="view-container" id="calls-hub-view">
            <div class="container">
                <div class="main-content">
                    <div id="script-display" class="script-display mood-neutral">
                        Click 'Dial' to begin the call
                    </div>
                    <div id="responses-container" class="responses-grid">
                        </div>
                    <div class="nav-buttons">
                        <button id="back-btn" class="nav-btn" onclick="goBack()" disabled>â† Back</button>
                        <button id="restart-btn" class="nav-btn" onclick="restart()">ðŸ”„ Restart</button>
                    </div>
                </div>
            
                <div class="sidebar">
                    <div class="sidebar-card">
                        <h3 class="sidebar-title">ðŸ“‹ Prospect Info</h3>
                        <div class="input-group">
                            <label for="input-company-name">Company Name:</label>
                            <input type="text" id="input-company-name" placeholder="ABC Manufacturing" oninput="updateScript()" onfocus="handleEditableFocus(this)">
                        </div>
                        <div class="input-group">
                            <label for="input-name">Contact Name:</label>
                            <input type="text" id="input-name" placeholder="John Smith" oninput="updateScript()" onfocus="handleEditableFocus(this)">
                        </div>
                        <div class="input-group">
                            <label for="input-title">Contact Title:</label>
                            <input type="text" id="input-title" placeholder="Company Leader" oninput="updateScript()" onfocus="handleEditableFocus(this)">
                        </div>
                        <div class="input-group">
                            <label for="input-company-industry">Company Industry:</label>
                            <input type="text" id="input-company-industry" placeholder="businesses" oninput="updateScript()" onfocus="handleEditableFocus(this)">
                        </div>
                        <div class="input-group">
                            <label for="input-benefit">Specific Benefit:</label>
                            <input type="text" id="input-benefit" placeholder="a strategic procurement strategy" oninput="updateScript()" onfocus="handleEditableFocus(this)">
                        </div>
                        <div class="input-group">
                            <label for="input-pain">Pain Point:</label>
                            <input type="text" id="input-pain" placeholder="you're not stuck paying more" oninput="updateScript()" onfocus="handleEditableFocus(this)">
                        </div>
                    </div>
            
                    <div class="sidebar-card">
                        <h3 class="sidebar-title">ðŸ“ Call Notes</h3>
                        <textarea id="call-notes" placeholder="Type your call notes here...
â€¢ Company:
â€¢ Contact:
â€¢ Title:
â€¢ Phone:
â€¢ Email:
â€¢ Contract expiration:
â€¢ Current provider:
â€¢ Pain points:
â€¢ Interest level:
â€¢ Next steps:
â€¢ Follow-up date: "></textarea>
                        <div style="display:flex;gap:8px;margin-bottom:16px">
                            <button onclick="saveProspectAndNotes()" class="add-notes-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 8v8M8 12h8"/>
                                </svg>
                                Add Notes
                            </button>
                            <button onclick="clearNotes()" style="flex:1;background:#da3633;color:white;border:none;padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer;font-size:.9rem">ðŸ—‘ï¸ Clear</button>
                        </div>
                    </div>
            
                    <div class="sidebar-card">
                        <h3 class="sidebar-title">ðŸ’¡ Call Strategy Tips</h3>
                        <div class="tip-item"><strong>Mirror their energy:</strong> Match their speaking pace and enthusiasm level to build rapport naturally.</div>
                        <div class="tip-item"><strong>Use their name:</strong> Say their name 2-3 times during the call to maintain personal connection.</div>
                        <div class="tip-item"><strong>Pause power:</strong> Use 2-3 second pauses after questions to let them process and respond.</div>
                        <div class="tip-item"><strong>Permission-based selling:</strong> Always ask permission before moving to the next topic or scheduling.</div>
                        <div class="tip-item"><strong>Assume the close:</strong> When scheduling, offer two specific times rather than asking "when works?"</div>
                    </div>
            
                    <div class="sidebar-card">
                        <h3 class="sidebar-title">ðŸ“Š Market Intelligence</h3>
                        <div class="stat-grid">
                            <div class="stat-card"><span class="stat-number">60%</span><span class="stat-label">Rate increase since 2021</span></div>
                            <div class="stat-card"><span class="stat-number">29%</span><span class="stat-label">TX cost advantage</span></div>
                            <div class="stat-card"><span class="stat-number">2026</span><span class="stat-label">Supply concerns begin</span></div>
                            <div class="stat-card"><span class="stat-number">85%</span><span class="stat-label">Businesses unprepared</span></div>
                        </div>
                        <div class="tip-item"><strong>Key Message:</strong> "Texas maintains a 29% cost advantage over national averages, but only if you're positioned correctly in the market."</div>
                    </div>
            
                    <div class="sidebar-card">
                        <h3 class="sidebar-title">ðŸ“° This Week's Energy News</h3>
                        
                        <div class="news-item">
                            <div class="news-title">ERCOT Demand Could Exceed Supply by 2026</div>
                            <div class="news-summary">Grid operator warns electricity demand may surpass available supply as soon as summer 2026, driven by massive data center growth and extreme weather patterns.</div>
                            <div class="news-talking-point">ðŸ’¬ "With ERCOT projecting supply shortages, how is your company preparing for potential capacity constraints?"</div>
                        </div>
                        
                        <div class="news-item">
                            <div class="news-title">Data Centers Drive 218GW Demand Surge</div>
                            <div class="news-summary">Texas electricity demand projected to reach 218GW by 2031 - more than doubling current levels. AI data centers alone account for 86GW of new demand growth.</div>
                            <div class="news-talking-point">ðŸ’¬ "Are you factoring the massive industrial load growth into your energy procurement strategy?"</div>
                        </div>
                        
                        <div class="news-item">
                            <div class="news-title">"One Big Beautiful Bill" Impacts Texas Markets</div>
                            <div class="news-summary">Federal legislation cuts clean energy subsidies while expanding fossil fuel production. Analysis shows wholesale electricity prices could rise 25% by 2030 and 74% by 2035.</div>
                            <div class="news-talking-point">ðŸ’¬ "How are recent federal policy changes affecting your long-term energy cost planning?"</div>
                        </div>
                        
                        <div class="news-item">
                            <div class="news-title">Texas Wholesale Prices Expected to Drop Short-Term</div>
                            <div class="news-summary">EIA forecasts ERCOT North Hub prices to decrease to $27-34/MWh in 2025 due to solar expansion, but forward contracts remain elevated at $50+/MWh reflecting market risk.</div>
                            <div class="news-talking-point">ðŸ’¬ "Are you taking advantage of current market conditions to lock in favorable rates?"</div>
                        </div>
                    </div>
            
                    <div class="sidebar-card">
                        <h3 class="sidebar-title">ðŸ›¡ï¸ Quick Objection Responses</h3>
                        <div class="tip-item"><strong>"We're happy with our provider"</strong><br>"That's great to hear. This isn't about changing providers - it's about optimizing your position within the current market structure."</div>
                        <div class="tip-item"><strong>"We just renewed our contract"</strong><br>"Perfect timing actually. This gives us a chance to prepare strategically for your next cycle rather than scrambling later."</div>
                        <div class="tip-item"><strong>"Send me some information"</strong><br>"I can definitely do that. What specific information would be most valuable - rate comparisons or market timing strategies?"</div>
                        <div class="tip-item"><strong>"We handle it internally"</strong><br>"Smart approach. My role isn't to replace your team - it's to provide market intelligence that helps you make better decisions."</div>
                    </div>
            
                    <div class="sidebar-card">
                        <h3 class="sidebar-title">ðŸŽ¯ Daily Goals</h3>
                        <div class="stat-grid">
                            <div class="stat-card"><span class="stat-number">50</span><span class="stat-label">Dials target</span></div>
                            <div class="stat-card"><span class="stat-number">15</span><span class="stat-label">Conversations</span></div>
                            <div class="stat-card"><span class="stat-number">5</span><span class="stat-label">Qualified leads</span></div>
                            <div class="stat-card"><span class="stat-number">2</span><span class="stat-label">Appointments</span></div>
                        </div>
                        <div class="tip-item"><strong>Success Rate:</strong> Track your conversion from dials to conversations to appointments. Aim for 30% conversation rate and 15% appointment rate.</div>
                    </div>
            
                    <div class="sidebar-card">
                        <h3 class="sidebar-title">ðŸ­ Industry Talking Points</h3>
                        <div class="tip-item"><strong>Manufacturing:</strong> "Energy costs can represent 15-30% of operating expenses. How are you managing that exposure to volatility?"</div>
                        <div class="tip-item"><strong>Healthcare:</strong> "Critical facilities need reliable power strategies. Are you prepared for supply constraints in 2026?"</div>
                        <div class="tip-item"><strong>Retail:</strong> "Multiple locations mean complex energy management. How are you optimizing across all sites?"</div>
                        <div class="tip-item"><strong>Technology:</strong> "Data centers have unique load profiles. Are you maximizing your demand response opportunities?"</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="modal-overlay" id="account-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="account-modal-title">Add New Account</h3>
                <button class="close-btn" id="close-account-modal">Ã—</button>
            </div>
            <form id="account-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="account-name">Company Name *</label>
                        <input type="text" id="account-name" required>
                    </div>
                    <div class="form-group">
                        <label for="account-industry">Industry</label>
                        <input type="text" id="account-industry">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="account-phone">Phone</label>
                        <input type="tel" id="account-phone">
                    </div>
                    <div class="form-group">
                        <label for="account-website">Website</label>
                        <input type="url" id="account-website">
                    </div>
                </div>
                <div class="form-group">
                    <label for="account-address">Address</label>
                    <textarea id="account-address" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="account-pain-points">Pain Points</label>
                        <textarea id="account-pain-points" rows="3" placeholder="What challenges does this company face?"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="account-benefits">Benefits</label>
                        <textarea id="account-benefits" rows="3" placeholder="What benefits can we provide?"></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="secondary-btn" id="cancel-account">Cancel</button>
                    <button type="submit" class="primary-btn">Save Account</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="contact-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="contact-modal-title">Add New Contact</h3>
                <button class="close-btn" id="close-contact-modal">Ã—</button>
            </div>
            <form id="contact-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="contact-first-name">First Name *</label>
                        <input type="text" id="contact-first-name" required>
                    </div>
                    <div class="form-group">
                        <label for="contact-last-name">Last Name *</label>
                        <input type="text" id="contact-last-name" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="contact-title">Job Title</label>
                        <input type="text" id="contact-title">
                    </div>
                    <div class="form-group">
                        <label for="contact-account">Account</label>
                        <select id="contact-account">
                            <option value="">Select an account...</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="contact-email">Email</label>
                        <input type="email" id="contact-email">
                    </div>
                    <div class="form-group">
                        <label for="contact-phone">Phone</label>
                        <input type="tel" id="contact-phone">
                    </div>
                </div>
                <div class="form-group">
                    <label for="contact-notes">Notes</label>
                    <textarea id="contact-notes" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="secondary-btn" id="cancel-contact">Cancel</button>
                    <button type="submit" class="primary-btn">Save Contact</button>
                </div>
            </form>
        </div>
    </div>

    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div class="toast-container" id="toast-container"></div>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBKg28LJZgyI3J--I8mnQXOLGN5351tfaE",
            authDomain: "power-choosers-crm.firebaseapp.com",
            projectId: "power-choosers-crm",
            storageBucket: "power-choosers-crm.firebasestorage.app",
            messagingSenderId: "792458658491",
            appId: "1:792458658491:web:a197a4a8ce7a860cfa1f9e",
            measurementId: "G-XEC3BFHJHW"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;
        
        const gId = id => document.getElementById(id);

        const CRMApp = {
            currentView: 'dashboard',
            currentAccount: null,
            currentContact: null,
            accounts: [],
            contacts: [],
            activities: []
        };
        
        let currentSearchType = '';
        let activeButton = null;
        let currentProspect = {}; 

        const placeholders = {
            'N': '', 
            'YN': 'Lewis', 
            'CN': '', 
            'CI': '', 
            'SB': '', 
            'PP': '', 
            'CT': '', 
            'TIA': '', 
            'TE': '', 
            'DT': '', 
            'EAC': '', 
            'TF': '', 
            'OP': 'the responsible party',
            'XX': '$XX.00/40%'
        };

        const inputMap = {
            'input-name': 'N',
            'input-title': 'CT',
            'input-company-name': 'CN',
            'input-company-industry': 'CI',
            'input-benefit': 'SB',
            'input-pain': 'PP'
        };

        // Handle editable field focus behavior
        function handleEditableFocus(input) {
            if (currentProspect.contactId) {
                // For locked fields from contacts, check if they're in the locked list
                const lockedFields = ['input-company-name', 'input-name', 'input-title'];
                if (lockedFields.includes(input.id)) {
                    return; // Don't allow editing
                }
            }
            
            // For editable fields, clear on focus
            if (input.value === input.placeholder || input.classList.contains('editable-locked')) {
                input.value = '';
                input.classList.remove('editable-locked');
            }
        }

        const scriptData = {
            start: {
                you: "Click 'Dial' to begin the call",
                mood: "neutral",
                responses: []
            },
            dialing: {
                you: "Dialing... Ringing...",
                mood: "neutral",
                responses: [
                    { text: "ðŸ“ž Call Connected", next: "hook" },
                    { text: "ðŸ“ž Transferred - Decision Maker Answers", next: "main_script_start" },
                    { text: "ðŸš« No Answer", next: "voicemail_or_hangup" }
                ]
            },
            voicemail_or_hangup: {
                you: "No answer. What would you like to do?",
                mood: "neutral",
                responses: [
                    { text: "Leave Voicemail", next: "voicemail" },
                    { text: "Hang Up / Start New Call", next: "start" }
                ]
            },
            hook: {
                you: "Hi, is this <strong>[N]</strong>?",
                mood: "neutral",
                responses: [
                    { text: "âœ… Yes, this is [N]", next: "main_script_start" },
                    { text: "ðŸ—£ï¸ Speaking", next: "main_script_start" },
                    { text: "â“ Who's calling?", next: "main_script_start" },
                    { text: "ðŸ‘¥ Gatekeeper / Not the right person", next: "gatekeeper_intro" }
                ]
            },
            main_script_start: {
                you: "Good mornin'/afternoon, <strong>[N]</strong>! This is <strong>[YN]</strong> <span class='pause'>--</span> and I'm needin' to speak with someone over electricity agreements and contracts for <strong>[CN]</strong> would that be yourself?",
                mood: "neutral",
                responses: [
                    { text: "âœ… Yes, that's me / I handle that", next: "pathA" },
                    { text: "ðŸ‘¥ That would be [OP] / Not the right person", next: "gatekeeper_intro" },
                    { text: "ðŸ¤ We both handle it / Team decision", next: "pathA" },
                    { text: "ðŸ¤” Unsure or hesitant", next: "pathD" }
                ]
            },
            gatekeeper_intro: {
                you: "Good afternoon/morning. I'm needin' to speak with someone over electricity agreements and contracts for <strong>[CN]</strong> do you know who would be responsible for that?",
                mood: "neutral",
                responses: [
                    { text: "â“ What's this about?", next: "gatekeeper_whats_about" },
                    { text: "ðŸ”— I'll connect you", next: "transfer_dialing" },
                    { text: "ðŸš« They're not available / Take a message", next: "voicemail" }
                ]
            },
            gatekeeper_whats_about: {
                you: "My name is Lewis with PowerChoosers.com and I'm needin' to speak with someone about the future electricity agreements for <strong>[CN]</strong>. Do you know who might be the best person for that?",
                mood: "neutral",
                responses: [
                    { text: "ðŸ”— I'll connect you", next: "transfer_dialing" },
                    { text: "ðŸš« They're not available / Take a message", next: "voicemail" },
                    { text: "âœ… I can help you", next: "pathA" }
                ]
            },
            voicemail: {
                you: "Good afternoon/morning <strong>[N]</strong>, this is Lewis and I was told to speak with you. You can give me a call at 817-409-4215. Also, I shot you over a short email kinda explaining why I'm reaching out to you today. The email should be coming from Lewis Patterson that's (L.E.W.I.S) Thank you so much and you have a great day.",
                mood: "neutral",
                responses: [
                    { text: "ðŸ”„ End Call / Start New Call", next: "start" }
                ]
            },
            pathA: {
                you: "Perfect <span class='pause'>--</span> So <strong>[N]</strong> I've been working closely with <strong>[CI]</strong> across Texas with electricity agreements <span class='pause'>--</span> and we're about to see an unprecedented dip in the market in the next few months <span class='pause'>--</span><br><br><strong><span class='emphasis'>Is getting the best price for your next renewal a priority for you and [CN]?</span></strong><br><br><strong><span class='emphasis'>Do you know when your contract expires?</span></strong><br><br><strong><span class='emphasis'>So since rates have gone up tremendously over the past 5 years, how are you guys handling such a sharp increase on your future renewals?</span></strong>",
                mood: "neutral",
                responses: [
                    { text: "ðŸ˜° Struggling / It's tough", next: "resStruggle" },
                    { text: "ðŸ“… Haven't renewed / Contract not up yet", next: "resNotRenewed" },
                    { text: "ðŸ”’ Locked in / Just renewed", next: "resLockedIn" },
                    { text: "ðŸ›’ Shopping around / Looking at options", next: "resShopping" },
                    { text: "ðŸ¤ Have someone handling it / Work with broker", next: "resBroker" },
                    { text: "ðŸ¤· Haven't thought about it / It is what it is", next: "resNoThought" }
                ]
            },
            pathD: {
                you: "No worries if you're not sure. I work with Texas businesses on energy contract optimization <span class='pause'>--</span> basically helping companies navigate rate volatility and strategic positioning in our deregulated market. Does energy procurement fall under your area of responsibility, or would someone else be better positioned for this conversation?",
                mood: "unsure",
                responses: [
                    { text: "âœ… Yes, that's my responsibility", next: "pathA" },
                    { text: "ðŸ‘¥ Someone else handles it", next: "gatekeeper_intro" }
                ]
            },
            resStruggle: {
                you: "Yeah, I'm hearing that from a lot of <strong>[CT]</strong>. The thing is, most companies are approaching renewals the same way they did pre-2021, but the rules have completely changed. Do you currently have a strategy in place to help mitigate these increases?",
                mood: "challenging",
                responses: [
                    { text: "ðŸŽ¯ Continue to Discovery", next: "discovery" }
                ]
            },
            resNotRenewed: {
                you: "Actually, that timing works in your favor. Most businesses wait until 60-90 days before expiration to start looking, but with the market set to increase in 2026, people are reserving their rates in advance to avoid paying more in the future. Do you currently have a plan in place to <span class='pause'>--</span> mitigate these increases?",
                mood: "positive",
                responses: [
                    { text: "ðŸŽ¯ Continue to Discovery", next: "discovery" }
                ]
            },
            resLockedIn: {
                you: "Smart move getting locked in during this volatility. How long did you guys end up going with the term? Because here's what I'm seeing <span class='pause'>--</span> even with companies who just renewed, there are often optimization opportunities within existing contracts that most people don't know about. Plus, it gives us time to develop a strategic approach for your next cycle rather than scrambling when rates spike again.",
                mood: "neutral",
                responses: [
                    { text: "ðŸŽ¯ Continue to Discovery", next: "discovery" }
                ]
            },
            resShopping: {
                you: "Perfect timing then. Here's what I'm seeing though <span class='pause'>--</span> typically people just shop for rates but the rate is only about <span class='metric'>60%</span> of your bill if you're lucky. How are you guys evaluating the options <span class='pause'>--</span> just on rate, or are you looking at other ways to lower your final dollar amount?",
                mood: "positive",
                responses: [
                    { text: "ðŸŽ¯ Continue to Discovery", next: "discovery" }
                ]
            },
            resBroker: {
                you: "That's smart <span class='pause'>--</span> having someone who understands the Texas market is crucial right now. Have they let you know about ERCOT's supply concerns for 2026? Because there's some huge changes happening right now that could impact <strong>[CN]</strong>'s costs significantly. Would it be worth understanding what that looks like, even if you're happy with your current relationship?",
                mood: "neutral",
                responses: [
                    { text: "ðŸŽ¯ Continue to Discovery", next: "discovery" }
                ]
            },
            resNoThought: {
                you: "I get it <span class='pause'>--</span> energy's not the first thing you think about when you wake up. How much are you typically spending on energy? And if your bills were to increase by <span class='emphasis'>[XX]</span>, would that impact your budget at all? If I could show you what other companies are doing to reduce their spending, would you be open to discussing this further?",
                mood: "challenging",
                responses: [
                    { text: "ðŸŽ¯ Continue to Discovery", next: "discovery" }
                ]
            },
            discovery: {
                you: "Gotcha! So <strong>[N]</strong>, Just so I understand your situation a little better. <span class='pause'>--</span> What's your current approach to renewing your electricity agreements <span class='pause'>--</span> do you handle it internally or work with a consultant?<br><br><strong><span class='emphasis'>And how that been?</span></strong><br><br><strong><span class='emphasis'>What is most concerning/important to you when it comes to energy?</span></strong><br><br><strong><span class='emphasis'>And how has that impacted you and [CN]?</span></strong><span class='pause'>--</span>I watch the markets daily and here's what I'm seeing. Rates have gone up <span class='metric'>60%</span> since 2021 <span class='pause'>--</span> Most businesses <span class='pause'>--</span> <strong>they've taken an incredible hit</strong>, but many others have been able to find <strong>other ways</strong> to pay way less than other companies in their <strong>same area</strong>. If I could show you what they're doing, would you be open to talking about this further?",
                mood: "neutral",
                responses: [
                    { text: "ðŸ’š Prospect is engaged / ready for appointment", next: "closeForAppointment" },
                    { text: "ðŸŸ¡ Prospect is hesitant / needs more info", next: "handleHesitation" },
                    { text: "âŒ Objection: Happy with current provider", next: "objHappy" },
                    { text: "âŒ Objection: No time", next: "objNoTime" }
                ]
            },
            objHappy: {
                you: "That's actually great to hear, and I'm not suggesting you should be unhappy or you need to switch your supplier today. Is it the customer service that you're happy with or are you just getting a rate that you can't find anywhere else?",
                mood: "positive",
                responses: [
                    { text: "ðŸ’° It's the rate / Great pricing", next: "objHappyRate" },
                    { text: "ðŸ¤ Customer service / Overall experience", next: "objHappyService" },
                    { text: "ðŸ”„ Both rate and service", next: "objHappyBoth" }
                ]
            },
            objHappyRate: {
                you: "That's awesome you locked in a great price, however, the rules of Texas Energy have completely changed over the past few years. Even satisfied clients I work with are <span class='pause'>--</span>shocked to find out they that their supplier's new rate is about <span class='metric'>15-25%</span> more than what they were paying before. Would it be worth re-evaluating where you're at now, just to make sure <strong>[CN]</strong> isn't left paying more than they should?",
                mood: "positive",
                responses: [
                    { text: "âœ… Yes, worth understanding", next: "closeForAppointment" },
                    { text: "âŒ No, not interested", next: "softClose" }
                ]
            },
            objHappyService: {
                you: "That's great - good service is hard to find. What I'm seeing though is that satisfaction with service and getting the best price are two separate conversations. The Texas energy market rules have changed significantly over the past few years. Even satisfied clients I work with discover they can can save <span class='metric'>15-25%</span> without sacrificing great customer service. Would it be worth looking into some options just to see if there is something more affordable for <strong>[CN]</strong>?",
                mood: "positive",
                responses: [
                    { text: "âœ… Yes, worth understanding", next: "closeForAppointment" },
                    { text: "âŒ No, not interested", next: "softClose" }
                ]
            },
            objHappyBoth: {
                you: "Perfect - that's exactly what you want. I have exclusive partnerships with the suppliers, so I can make them work 10 times harder for your business. If i can show you how to get better pricing and support for your energy, would that be helpful for you and <strong>[CN]</strong>?",
                mood: "positive",
                responses: [
                    { text: "âœ… Yes, worth understanding", next: "closeForAppointment" },
                    { text: "âŒ No, not interested", next: "softClose" }
                ]
            },
            objNoTime: {
                you: "I completely get it <span class='pause'>--</span> that's exactly why most businesses end up overpaying. Energy is a complicated market that requires ongoing attention that most internal teams <span class='pause'>--</span> simply don't have time for. Here's what I'd suggest <span class='pause'>--</span> give me <span class='emphasis'>10 minutes</span> to review your current setup <span class='pause'>--</span> against where we are today. And that should be able tell you exactly where you stand and what you should be expecting for the future. Would that be helpful for you?",
                mood: "challenging",
                responses: [
                    { text: "âœ… Yes, schedule 10-minute assessment", next: "scheduleAppointment" },
                    { text: "âŒ Still no time", next: "softClose" }
                ]
            },
            handleHesitation: {
                you: "I get it <span class='pause'>--</span> And called you out the blue so now is probably not the best time. How about this <span class='pause'>--</span> let me put together a quick case study specific to <span class='emphasis'>[TIA]</span>s in your area. Takes me about 10 minutes to prepare, it'll give you a snapshot into the market and it'll show you what other companies are doing to stay afloat in today's market.<br><br><strong><span class='emphasis'>Would that be useful for your future planning?</span></strong>",
                mood: "unsure",
                responses: [
                    { text: "âœ… Yes, send analysis", next: "getEmail" },
                    { text: "âŒ No, not interested", next: "softClose" }
                ]
            },
            closeForAppointment: {
                you: "Awesome! So, <strong>[N]</strong><span class='pause'>--</span> I really believe you'll be able to benefit from <span class='emphasis'>[SB]</span> that way you won't have to <span class='emphasis'>[PP]</span>. Our process is super simple! We start with an <span class='emphasis'>energy health check</span> where I look at your usage, contract terms, and then we can talk about what options might look like for <strong>[CN]</strong> moving forward. It should take <span class='emphasis'>10-15 minutes</span> of your time. Would you prefer to connect this <span class='emphasis'>Friday morning around 11 AM</span>, or would <span class='emphasis'>Monday afternoon around 2 PM</span> work better for your schedule?",
                mood: "positive",
                responses: [
                    { text: "ðŸ“… Schedule Friday 11 AM", next: "appointmentConfirmed" },
                    { text: "ðŸ“… Schedule Monday 2 PM", next: "appointmentConfirmed" },
                    { text: "ðŸ¤” Still hesitant", next: "getEmail" }
                ]
            },
            scheduleAppointment: {
                you: "Perfect! Let's get that <span class='emphasis'>10-minute market assessment</span> scheduled. I'll walk through your current situation, show you common supplier traps, and outline 2-3 strategic options based on your specific situation. Would <span class='emphasis'>Friday morning</span> or <span class='emphasis'>Monday afternoon</span> work better?",
                mood: "positive",
                responses: [
                    { text: "ðŸ“… Friday morning works", next: "appointmentConfirmed" },
                    { text: "ðŸ“… Monday afternoon works", next: "appointmentConfirmed" }
                ]
            },
            appointmentConfirmed: {
                you: "Perfect! I'll send you a calendar invite for <span class='emphasis'>[DT]</span>, and I'll put together some information specific to <span class='emphasis'>[TIA]</span> to give you better context for our meeting. Do you have a copy of your bill?",
                mood: "positive",
                responses: [
                    { text: "âœ… Yes, I have a copy", next: "billYes" },
                    { text: "âŒ No, I don't have one readily available", next: "billNo" }
                ]
            },
            billYes: {
                you: "Perfect! I'm going to also send you a standard invoice request. Could you reply back with a recent copy?",
                mood: "positive",
                responses: [
                    { text: "âœ… Yes, I can send that", next: "confirmEmail" },
                    { text: "âŒ I'd prefer not to share that", next: "billOptional" }
                ]
            },
            billNo: {
                you: "No problem. How do you typically receive your bills <span class='pause'>--</span> physical copy or through email?",
                mood: "positive",
                responses: [
                    { text: "ðŸ“§ Through email", next: "billEmailAdvice" },
                    { text: "ðŸ“„ Physical copy", next: "billPhysicalAdvice" }
                ]
            },
            billEmailAdvice: {
                you: "Perfect! Be sure to have a copy ready for us to go over at <span class='emphasis'>[DT]</span>. You should be able to find it in your email from your provider. Looking forward to our conversation!",
                mood: "positive",
                responses: [
                    { text: "âœ… Sounds great - end call", next: "callSuccess" }
                ]
            },
            billPhysicalAdvice: {
                you: "Perfect! Be sure to have a copy ready for us to go over at <span class='emphasis'>[DT]</span>. If you can find your most recent physical bill, that would be ideal for our review. Looking forward to our conversation!",
                mood: "positive",
                responses: [
                    { text: "âœ… Sounds great - end call", next: "callSuccess" }
                ]
            },
            confirmEmail: {
                you: "Excellent! So I have your email as <span class='emphasis'>[TE]</span> <span class='pause'>--</span> is that correct? I'll send both the calendar invite and the invoice request to that address. You should receive them within the next few minutes. Looking forward to our conversation at <span class='emphasis'>[DT]</span>!",
                mood: "positive",
                responses: [
                    { text: "âœ… Email confirmed - end call", next: "callSuccess" },
                    { text: "âŒ Different email address", next: "getCorrectEmail" }
                ]
            },
            getCorrectEmail: {
                you: "No problem! What's the best email address for you?",
                mood: "positive",
                responses: [
                    { text: "ðŸ“§ Provide correct email", next: "emailConfirmed" }
                ]
            },
            emailConfirmed: {
                you: "Perfect! I'll send the calendar invite and invoice request to <span class='emphasis'>[EAC]</span>. You should receive them within the next few minutes. Looking forward to our conversation at <span class='emphasis'>[DT]</span>!",
                mood: "positive",
                responses: [
                    { text: "âœ… All set - end call", next: "callSuccess" }
                ]
            },
            billOptional: {
                you: "No worries at all! Having a bill helps with the analysis, but we can still have a productive conversation without it. I'll send you the calendar invite for <span class='emphasis'>[DT]</span> and some industry-specific information. Looking forward to our conversation!",
                mood: "positive",
                responses: [
                    { text: "âœ… Sounds good - end call", next: "callSuccess" }
                ]
            },
            getEmail: {
                you: "Great! I'll put together a quick case study specific to <span class='emphasis'>[TIA]</span>. It takes me about 10 minutes to prepare, and it'll give you a baseline understanding of where your company stands competitively. I can email that over by tomorrow, and if you see value in diving deeper, we can schedule a brief follow-up. What's a good email for you?",
                mood: "unsure",
                responses: [
                    { text: "âœ… Yes, send analysis", next: "emailFollowUp" },
                    { text: "âŒ Don't want to provide email", next: "softClose" }
                ]
            },
            emailFollowUp: {
                you: "Perfect! I've got <span class='emphasis'>[EAC]</span>. I'll get that market analysis over to you by <span class='emphasis'>[TF]</span>, and it'll give you a good baseline for understanding your competitive position. If you have any immediate questions before then, feel free to reach out. Otherwise, I'll follow up once you've had a chance to review the information. Sound good?",
                mood: "positive",
                responses: [
                    { text: "âœ… Sounds good - end call", next: "callSuccess" }
                ]
            },
            softClose: {
                you: "No problem at all <span class='pause'>--</span> I know energy strategy isn't urgent until it becomes critical. Here's what I'll do: I'm going to add you to my <span class='emphasis'>quarterly market intelligence updates</span>. These go out to CFOs and facilities managers across Texas and include trend analysis, regulatory updates, and strategic insights. <span class='emphasis'>No sales content, just market intelligence</span> that helps you stay informed. If market conditions create opportunities that make sense for <span class='emphasis'>[CN]</span>, I'll reach out. Sound reasonable?",
                mood: "neutral",
                responses: [
                    { text: "âœ… That sounds reasonable", next: "callSuccess" },
                    { text: "âŒ No thanks", next: "callEnd" }
                ]
            },
            callSuccess: {
                you: "ðŸŽ‰ <strong>Call Completed Successfully!</strong><br><br>Remember to track:<br>â€¢ Decision maker level<br>â€¢ Current contract status and timeline<br>â€¢ Pain points identified<br>â€¢ Interest level (Hot/Warm/Cold/Future)<br>â€¢ Next action committed<br>â€¢ Best callback timing<br><br><span class='emphasis'>Great job keeping the energy high and positioning as a strategic advisor!</span>",
                mood: "positive",
                responses: [
                    { text: "ðŸ”„ Start New Call", next: "start", action: "saveProspectAndNotes" }
                ]
            },
            callEnd: {
                you: "Thanks for your time. Have a great day!",
                mood: "neutral",
                responses: [
                    { text: "ðŸ”„ Start New Call", next: "start" }
                ]
            },
            transfer_dialing: {
                you: "Being transferred... Ringing...",
                mood: "neutral",
                responses: [
                    { text: "ðŸ“ž Decision Maker Answers", next: "main_script_start" },
                    { text: "ðŸš« No Answer", next: "voicemail_or_hangup" }
                ]
            }
        };

        let currentStep = 'start';
        let history = [];
        let scriptDisplay, responsesContainer, backBtn;

        function populateFromGlobalProspect() {
            const inputName = gId('input-name');
            if (inputName) {
                inputName.value = currentProspect.name || '';
                placeholders['N'] = currentProspect.name || '';
            }
            const inputTitle = gId('input-title');
            if (inputTitle) {
                inputTitle.value = currentProspect.title || '';
                placeholders['CT'] = currentProspect.title || '';
            }
            const inputCompanyName = gId('input-company-name');
            if (inputCompanyName) {
                inputCompanyName.value = currentProspect.company || '';
                placeholders['CN'] = currentProspect.company || '';
            }
            const inputCompanyIndustry = gId('input-company-industry');
            if (inputCompanyIndustry) {
                inputCompanyIndustry.value = currentProspect.industry || '';
                placeholders['CI'] = currentProspect.industry || '';
                placeholders['TIA'] = currentProspect.industry || '';
            }
            const inputBenefit = gId('input-benefit');
            if (inputBenefit) {
                inputBenefit.value = currentProspect.benefits || '';
                placeholders['SB'] = currentProspect.benefits || '';
            }
            const inputPain = gId('input-pain');
            if (inputPain) {
                inputPain.value = currentProspect.painPoints || '';
                placeholders['PP'] = currentProspect.painPoints || '';
            }
            
            // Handle field locking for contact-derived data
            const lockedFields = ['input-company-name', 'input-name', 'input-title'];
            if (currentProspect.contactId) {
                lockedFields.forEach(fieldId => {
                    const input = gId(fieldId);
                    if (input) {
                        input.disabled = true;
                        input.style.backgroundColor = '#f8fafc';
                        input.style.cursor = 'not-allowed';
                    }
                });
            } else {
                lockedFields.forEach(fieldId => {
                    const input = gId(fieldId);
                    if (input) {
                        input.disabled = false;
                        input.style.backgroundColor = '';
                        input.style.cursor = '';
                    }
                });
            }
        }

        async function saveProspectAndNotes() {
            const notesContent = gId('call-notes').value.trim();
            const prospectData = {
                name: gId('input-name').value.trim(),
                title: gId('input-title').value.trim(),
                company: gId('input-company-name').value.trim(),
                industry: gId('input-company-industry').value.trim(),
                benefits: gId('input-benefit').value.trim(),
                painPoints: gId('input-pain').value.trim()
            };

            showLoading(true);

            try {
                let accountId = currentProspect.accountId;
                let contactId = currentProspect.contactId;
                let accountName = prospectData.company;
                let contactName = prospectData.name;
                let isNewAccount = false;
                let isNewContact = false;

                if (accountId) {
                    const accountRef = db.collection('accounts').doc(accountId);
                    await accountRef.update({
                        name: prospectData.company,
                        industry: prospectData.industry,
                        painPoints: prospectData.painPoints,
                        benefits: prospectData.benefits,
                        updatedAt: serverTimestamp()
                    });
                } else if (prospectData.company) {
                    const newAccountRef = await db.collection('accounts').add({
                        name: prospectData.company,
                        industry: prospectData.industry,
                        painPoints: prospectData.painPoints,
                        benefits: prospectData.benefits,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                    accountId = newAccountRef.id;
                    isNewAccount = true;
                }

                if (contactId) {
                    const contactRef = db.collection('contacts').doc(contactId);
                    await contactRef.update({
                        firstName: prospectData.name.split(' ')[0] || '',
                        lastName: prospectData.name.split(' ')[1] || '',
                        title: prospectData.title,
                        accountId: accountId,
                        accountName: accountName,
                        notes: notesContent,
                        updatedAt: serverTimestamp()
                    });
                } else if (prospectData.name) {
                    const newContactRef = await db.collection('contacts').add({
                        firstName: prospectData.name.split(' ')[0] || '',
                        lastName: prospectData.name.split(' ')[1] || '',
                        title: prospectData.title,
                        accountId: accountId,
                        accountName: accountName,
                        notes: notesContent,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                    contactId = newContactRef.id;
                    isNewContact = true;
                }
                
                if (notesContent) {
                    await logActivity({
                        type: 'call_note',
                        description: `Call note for ${contactName || accountName || 'prospect'}`,
                        noteContent: notesContent,
                        accountId: accountId,
                        accountName: accountName,
                        contactId: contactId,
                        contactName: contactName
                    });
                }

                showToast(`Call notes and prospect data saved!${isNewAccount ? ' New account created.' : ''}${isNewContact ? ' New contact created.' : ''}`);
                
                // Reload data to refresh the UI
                await loadInitialData();
                restart();

            } catch (error) {
                console.error('Error saving prospect and notes:', error);
                showToast('Error saving data. See console for details.', 'error');
            } finally {
                showLoading(false);
            }
        }

        function applyPlaceholders(text) {
            let newText = text;
            for (const key in placeholders) {
                const regex = new RegExp('\\[' + key + '\\]', 'g');
                newText = newText.replace(regex, placeholders[key]);
            }
            return newText;
        }

        function updateScript() {
            for (const inputId in inputMap) {
                const placeholderKey = inputMap[inputId];
                const inputElement = gId(inputId);
                if (inputElement) {
                    const inputValue = inputElement.value || inputElement.placeholder;
                    placeholders[placeholderKey] = inputValue;
                }
            }
            placeholders['TIA'] = placeholders['CI'];
            displayCurrentStep();
        }

        function displayCurrentStep() {
            const step = scriptData[currentStep];
            if (!step) return;
            
            scriptDisplay = gId('script-display');
            responsesContainer = gId('responses-container');
            backBtn = gId('back-btn');
            
            const processedText = applyPlaceholders(step.you);
            
            if (scriptDisplay) {
                scriptDisplay.innerHTML = processedText;
                scriptDisplay.className = `script-display mood-${step.mood}`;
            }
            
            if (responsesContainer) {
                responsesContainer.innerHTML = '';
                if (currentStep === 'start') {
                    const dialButtonHtml = `
                        <button class="dial-button" onclick="handleDialClick()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02L6.62 10.79z"/>
                            </svg>
                            Dial
                        </button>
                    `;
                    responsesContainer.innerHTML = dialButtonHtml;
                } else if (step.responses && step.responses.length > 0) {
                    step.responses.forEach(response => {
                        const button = document.createElement('button');
                        button.className = 'response-btn';
                        button.innerHTML = applyPlaceholders(response.text);
                        button.onclick = () => selectResponse(response.next, response.action);
                        responsesContainer.appendChild(button);
                    });
                }
            }
            
            if (backBtn) {
                backBtn.disabled = history.length === 0;
            }
        }

        function handleDialClick() {
            if (currentProspect.phone) {
                showToast(`Dialing ${currentProspect.phone}...`, 'info');
            } else {
                showToast('No phone number available for this prospect. Manual dialing is required.', 'info');
            }
            selectResponse('dialing');
        }

        function selectResponse(nextStep, action) {
            if (nextStep && scriptData[nextStep]) {
                history.push(currentStep);
                currentStep = nextStep;
                displayCurrentStep();
            }

            if (action === 'saveProspectAndNotes') {
                saveProspectAndNotes();
            }
        }

        function goBack() {
            if (history.length > 0) {
                currentStep = history.pop();
                displayCurrentStep();
            }
        }

        function restart() {
            currentStep = 'start';
            history = [];
            
            const callNotesElement = gId('call-notes');
            if (callNotesElement) {
                callNotesElement.value = '';
            }
            
            // Only reset prospect data if not from a contact
            if (!currentProspect.contactId) {
                currentProspect = {
                    name: '',
                    title: '',
                    company: '',
                    industry: '',
                    phone: '',
                    email: '',
                    accountId: '',
                    contactId: '',
                    painPoints: '',
                    benefits: ''
                };
                
                const inputs = ['input-name', 'input-title', 'input-company-name', 'input-company-industry', 'input-benefit', 'input-pain'];
                inputs.forEach(inputId => {
                    const input = gId(inputId);
                    if (input) {
                        input.value = '';
                        input.disabled = false;
                        input.style.backgroundColor = '';
                        input.style.cursor = '';
                    }
                });
            }
            
            displayCurrentStep();
        }
        
        function clearNotes() {
            const notesTextarea = gId('call-notes');
            if (!notesTextarea) return;

            if (window.confirm('Are you sure you want to clear all notes?')) {
                notesTextarea.value = '';
                showToast('Notes cleared.', 'warning');
            }
        }

        function setupSearchFunctionality() {
            const googleBtn = gId('google-button');
            if (googleBtn) {
                googleBtn.addEventListener('click', (e) => openSearch('google', e));
            }
            const mapsBtn = gId('maps-button');
            if (mapsBtn) {
                mapsBtn.addEventListener('click', (e) => openSearch('maps', e));
            }
            const apolloBtn = gId('apollo-button');
            if (apolloBtn) {
                apolloBtn.addEventListener('click', (e) => openSearch('apollo', e));
            }
            const beenverifiedBtn = gId('beenverified-button');
            if (beenverifiedBtn) {
                beenverifiedBtn.addEventListener('click', (e) => openSearch('beenverified', e));
            }
            
            // Add search functionality for accounts and contacts
            const accountsBtn = gId('accounts-btn');
            if (accountsBtn) {
                accountsBtn.addEventListener('click', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        openSearch('accounts', e);
                        e.preventDefault();
                        return false;
                    }
                });
            }
            
            const contactsBtn = gId('contacts-btn');
            if (contactsBtn) {
                contactsBtn.addEventListener('click', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        openSearch('contacts', e);
                        e.preventDefault();
                        return false;
                    }
                });
            }

            ['search-input', 'search-city', 'search-state', 'search-location'].forEach(id => {
                const input = gId(id);
                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') performSearch();
                    });
                    
                    if (id === 'search-input') {
                        input.addEventListener('input', function(e) {
                            if (currentSearchType === 'accounts' || currentSearchType === 'contacts') {
                                performInternalSearch(e.target.value);
                            }
                        });
                    }
                }
            });
        }

        function openSearch(type, event) {
            const button = event.target.closest('.app-button');
            const searchBar = gId('search-bar');
            const mainContainer = gId('main-container');

            if (currentSearchType === type && activeButton === button) {
                closeSearch();
                return;
            }
            
            if (activeButton) activeButton.classList.remove('active');
            currentSearchType = type;
            activeButton = button;
            button.classList.add('active');
            
            const label = gId('search-label');
            const input = gId('search-input');
            const cityInput = gId('search-city');
            const stateInput = gId('search-state');
            const locationInput = gId('search-location');
            const resultsDiv = gId('search-results');
            
            if (!label || !input) return;
            
            if (cityInput) cityInput.style.display = 'none';
            if (stateInput) stateInput.style.display = 'none';
            if (locationInput) locationInput.style.display = 'none';
            if (resultsDiv) resultsDiv.classList.remove('active');
            
            if (type === 'google') {
                label.textContent = 'Search Google:';
                input.placeholder = 'Type your search query...';
            } else if (type === 'maps') {
                label.textContent = 'Search Maps:';
                input.placeholder = 'Search places, addresses, businesses...';
            } else if (type === 'beenverified') {
                label.textContent = 'Search BeenVerified:';
                input.placeholder = 'Enter full name (e.g. John Smith)...';
                if (cityInput) cityInput.style.display = 'block';
                if (stateInput) stateInput.style.display = 'block';
            } else if (type === 'apollo') {
                label.textContent = 'Search Apollo:';
                input.placeholder = 'Enter name (e.g. Lewis Patterson)...';
                if (locationInput) locationInput.style.display = 'block';
            } else if (type === 'accounts') {
                label.textContent = 'Search Accounts:';
                input.placeholder = 'Type to search accounts...';
                if (resultsDiv) resultsDiv.classList.add('active');
            } else if (type === 'contacts') {
                label.textContent = 'Search Contacts:';
                input.placeholder = 'Type to search contacts...';
                if (resultsDiv) resultsDiv.classList.add('active');
            }
            
            if (searchBar) searchBar.classList.add('active');
            if (mainContainer) {
                mainContainer.classList.add('search-active');
            }
            setTimeout(() => input.focus(), 300);
            input.value = '';
            if (cityInput) cityInput.value = '';
            if (stateInput) stateInput.value = '';
            if (locationInput) locationInput.value = '';
        }

        function performInternalSearch(query) {
            const resultsDiv = gId('search-results');
            if (!resultsDiv) return;
            
            if (query.length < 2) {
                resultsDiv.innerHTML = '';
                return;
            }
            
            let results = [];
            const searchQuery = query.toLowerCase();
            
            if (currentSearchType === 'accounts') {
                results = CRMApp.accounts
                    .filter(account => 
                        account.name?.toLowerCase().includes(searchQuery) ||
                        account.industry?.toLowerCase().includes(searchQuery)
                    )
                    .slice(0, 5)
                    .map(account => ({
                        id: account.id,
                        name: account.name,
                        info: account.industry || 'No Industry',
                        type: 'Account',
                        action: () => showAccountDetail(account.id)
                    }));
            } else if (currentSearchType === 'contacts') {
                results = CRMApp.contacts
                    .filter(contact => 
                        `${contact.firstName} ${contact.lastName}`.toLowerCase().includes(searchQuery) ||
                        contact.title?.toLowerCase().includes(searchQuery) ||
                        contact.accountName?.toLowerCase().includes(searchQuery)
                    )
                    .slice(0, 5)
                    .map(contact => ({
                        id: contact.id,
                        name: `${contact.firstName} ${contact.lastName}`,
                        info: `${contact.title || 'No Title'} at ${contact.accountName || 'No Account'}`,
                        type: 'Contact',
                        action: () => {
                            if (contact.accountId) {
                                showAccountDetail(contact.accountId);
                            } else {
                                showToast('This contact is not linked to an account.', 'warning');
                            }
                        }
                    }));
            }
            
            let html = '';
            
            results.forEach(result => {
                html += `
                    <div class="search-result-item" onclick="handleSearchResultClick('${result.id}', '${currentSearchType}')">
                        <div class="search-result-name">${result.name}</div>
                        <div class="search-result-info">${result.info} <span class="search-result-type">${result.type}</span></div>
                    </div>
                `;
            });
            
            if (results.length > 0) {
                html += `
                    <button class="view-all-btn" onclick="handleViewAll('${currentSearchType}')">
                        View All ${currentSearchType === 'accounts' ? 'Accounts' : 'Contacts'}
                    </button>
                `;
            } else {
                html = `<div class="search-result-item">No ${currentSearchType} found</div>`;
            }
            
            resultsDiv.innerHTML = html;
        }

        function handleSearchResultClick(id, type) {
            if (type === 'accounts') {
                showAccountDetail(id);
            } else if (type === 'contacts') {
                const contact = CRMApp.contacts.find(c => c.id === id);
                if (contact && contact.accountId) {
                    showAccountDetail(contact.accountId);
                } else {
                    showToast('This contact is not linked to an account.', 'warning');
                }
            }
            closeSearch();
        }

        function handleViewAll(type) {
            closeSearch();
            showView(type);
        }

        function closeSearch() {
            const searchBar = gId('search-bar');
            const mainContainer = gId('main-container');
            const resultsDiv = gId('search-results');
            
            if (searchBar) {
                searchBar.classList.remove('active');
            }
            if (mainContainer) {
                mainContainer.classList.remove('search-active');
            }
            if (resultsDiv) {
                resultsDiv.classList.remove('active');
                resultsDiv.innerHTML = '';
            }
            if (activeButton) {
                activeButton.classList.remove('active');
                activeButton = null;
            }
            currentSearchType = '';
        }

        function performSearch() {
            const query = gId('search-input').value.trim();
            if (!query) return;
            
            if (currentSearchType === 'accounts' || currentSearchType === 'contacts') {
                // Internal search is handled by performInternalSearch
                return;
            }
            
            let searchUrl = '';
            
            if (currentSearchType === 'google') {
                searchUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
            } else if (currentSearchType === 'maps') {
                searchUrl = `https://www.google.com/maps/search/${encodeURIComponent(query)}`;
            } else if (currentSearchType === 'beenverified') {
                const city = gId('search-city').value.trim();
                const state = gId('search-state').value.trim().toUpperCase();
                const nameParts = query.split(' ');
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';
                searchUrl = `https://www.beenverified.com/rf/search/v2?age=0&city=${encodeURIComponent(city)}&fullname=${encodeURIComponent(query)}&fname=${encodeURIComponent(firstName)}&ln=${encodeURIComponent(lastName)}&mn=&state=${encodeURIComponent(state)}&title=&company=&industry=&level=&companySizeMin=1&companySizeMax=9&birthMonth=&birthYear=&deathMonth=&deathYear=&address=&isDeceased=false&location=&country=&advancedSearch=true&eventType=none&eventMonth=&eventYear=&source=personSearch,familySearch,obituarySearch,deathIndexSearch,contactSearch`;
            } else if (currentSearchType === 'apollo') {
                const location = gId('search-location').value.trim();
                let apolloUrl = `https://app.apollo.io/#/people?page=1&qKeywords=${encodeURIComponent(query + ' ')}`;
                if (location) apolloUrl += `&personLocations[]=${encodeURIComponent(location)}`;
                searchUrl = apolloUrl;
            }
            
            if (searchUrl) {
                window.open(searchUrl, '_blank');
                closeSearch();
            }
        }
        
        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                if (show) {
                    overlay.classList.add('active');
                } else {
                    overlay.classList.remove('active');
                }
            }
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            toast.innerHTML = `<div class="toast-message">${message}</div>`;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown date';
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } catch (e) {
                return 'Invalid date';
            }
        }
        
        function formatDateOnly(timestamp) {
            if (!timestamp) return 'Unknown date';
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleDateString();
            } catch (e) {
                return 'Invalid date';
            }
        }
        
        // Firebase wrapper for compatibility
        window.FirebaseDB = {
            db: db,
            doc: (db, collection, id) => db.collection(collection).doc(id),
            setDoc: (docRef, data) => docRef.set(data),
            getDoc: (docRef) => docRef.get(),
            getDocs: (query) => query.get(),
            collection: (db, path) => db.collection(path),
            query: (collection, ...constraints) => {
                let query = collection;
                constraints.forEach(constraint => {
                    if (constraint && constraint.type === 'orderBy') {
                        query = query.orderBy(constraint.field, constraint.direction);
                    } else if (constraint && constraint.type === 'limit') {
                        query = query.limit(constraint.limit);
                    } else if (constraint && constraint.type === 'where') {
                        query = query.where(constraint.field, constraint.op, constraint.value);
                    }
                });
                return query;
            },
            orderBy: (field, direction = 'asc') => ({ type: 'orderBy', field, direction }),
            limit: (limit) => ({ type: 'limit', limit }),
            serverTimestamp: firebase.firestore.FieldValue.serverTimestamp,
            updateDoc: (docRef, data) => docRef.update(data),
            deleteDoc: (docRef) => docRef.delete(),
            arrayUnion: firebase.firestore.FieldValue.arrayUnion,
            Timestamp: firebase.firestore.Timestamp,
            where: (field, op, value) => ({ type: 'where', field, op, value }),
            addDoc: (collectionRef, data) => collectionRef.add(data)
        };
        
        window.generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        function initializeApp() {
            setupNavigation();
            setupModals();
            setupEventListeners();
            setupSearchFunctionality();
            loadInitialData();
            showView('dashboard');
        }

        function setupNavigation() {
            const navButtons = document.querySelectorAll('.app-button[data-view]');
            navButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = button.getAttribute('data-view');
                    if (view === 'calls-hub') {
                        openCallsHubWithData();
                    } else {
                        showView(view);
                    }
                });
            });

            gId('go-to-calls-hub-btn').addEventListener('click', (e) => {
                e.preventDefault();
                openCallsHubWithData();
            });
        }

        function showView(viewName) {
            document.querySelectorAll('.view-container').forEach(view => {
                view.classList.remove('active');
            });
            const targetView = document.getElementById(viewName + '-view');
            if (targetView) {
                targetView.classList.add('active');
                CRMApp.currentView = viewName;
                updateActiveNavButton(gId(viewName + '-btn'));
                updatePageTitle(viewName);
                loadViewData(viewName);
            }
        }
        
        function updateActiveNavButton(activeButton) {
            document.querySelectorAll('.app-button[data-view]').forEach(btn => {
                btn.classList.remove('active');
            });
            if (activeButton) activeButton.classList.add('active');
        }

        function updatePageTitle(viewName) {
            const titles = {
                'dashboard': 'Power Choosers CRM Dashboard',
                'accounts': 'Power Choosers CRM Accounts',
                'contacts': 'Power Choosers CRM Contacts', 
                'account-detail': 'Power Choosers CRM Account Details',
                'calls-hub': 'Power Choosers Cold Calling Hub'
            };
            const titleElement = document.getElementById('page-title');
            if (titleElement) {
                titleElement.textContent = titles[viewName] || 'Power Choosers CRM';
            }
        }

        function loadViewData(viewName) {
            switch(viewName) {
                case 'dashboard':
                    renderDashboard();
                    renderRecentActivities();
                    break;
                case 'accounts':
                    renderAccounts();
                    break;
                case 'contacts':
                    renderContacts();
                    break;
                case 'account-detail':
                    if (CRMApp.currentAccount) {
                        renderAccountDetail();
                    }
                    break;
                case 'calls-hub':
                    initializeCallsHub();
                    break;
            }
        }

        function initializeCallsHub() {
            if (!currentProspect.name && !currentProspect.company) {
                currentProspect = {
                    name: '',
                    title: '',
                    company: '',
                    industry: '',
                    phone: '',
                    email: '',
                    accountId: '',
                    contactId: '',
                    painPoints: '',
                    benefits: ''
                };
            }
            populateFromGlobalProspect();
            displayCurrentStep();
        }
        
        async function loadInitialData() {
            showLoading(true);
            try {
                const [accountsSnapshot, contactsSnapshot, activitiesSnapshot] = await Promise.all([
                    db.collection('accounts').get(),
                    db.collection('contacts').get(),
                    db.collection('activities').orderBy('createdAt', 'desc').limit(20).get()
                ]);
                
                CRMApp.accounts = accountsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                CRMApp.contacts = contactsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                CRMApp.activities = activitiesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderDashboard();
                renderAccounts();
                renderContacts();
                updateContactAccountDropdown();
                renderRecentActivities();
                
            } catch (error) {
                console.error('Error loading initial data:', error);
                showToast('Error loading data.', 'error');
            } finally {
                showLoading(false);
            }
        }

        function renderDashboard() {
            if (gId('total-accounts')) gId('total-accounts').textContent = CRMApp.accounts.length;
            if (gId('total-contacts')) gId('total-contacts').textContent = CRMApp.contacts.length;
            if (gId('recent-activities')) gId('recent-activities').textContent = CRMApp.activities.length;
            if (gId('hot-leads')) gId('hot-leads').textContent = '0';
            
            renderDashboardContacts();
        }

        function renderRecentActivities() {
            const list = gId('recent-activities-list');
            if (!list) return;
            list.innerHTML = '';
            
            // Limit to 4 most recent activities
            const recentActivities = CRMApp.activities.slice(0, 4);
            
            if (recentActivities.length === 0) {
                list.innerHTML = '<p class="empty-state">No recent activities</p>';
                return;
            }
            
            recentActivities.forEach(activity => {
                const item = document.createElement('div');
                item.className = 'activity-item';
                item.innerHTML = `
                    <div class="activity-title">${activity.description}</div>
                    <div class="activity-content">${activity.noteContent ? activity.noteContent.substring(0, 100) + '...' : ''}</div>
                    <div class="activity-date">Time: ${formatDate(activity.createdAt)}</div>
                `;
                list.appendChild(item);
            });
        }

        function renderDashboardContacts() {
            const container = gId('dashboard-contacts');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Show 5 most recent contacts
            const recentContacts = CRMApp.contacts.slice(0, 5);
            
            if (recentContacts.length === 0) {
                container.innerHTML = '<p class="empty-state">No contacts to display</p>';
                return;
            }
            
            recentContacts.forEach(contact => {
                const item = document.createElement('div');
                item.className = 'contact-item';
                item.innerHTML = `
                    <div class="contact-item-info">
                        <div class="contact-item-name">${contact.firstName} ${contact.lastName}</div>
                        <div class="contact-item-detail">${contact.title || 'No Title'} â€¢ ${contact.accountName || 'No Account'}</div>
                    </div>
                    <div class="contact-item-actions">
                        <button class="mini-btn edit" onclick="openContactModal(CRMApp.contacts.find(c => c.id === '${contact.id}'))">Edit</button>
                        <button class="mini-btn delete" onclick="deleteContact('${contact.id}')">Delete</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        async function deleteContact(contactId) {
            if (!confirm('Are you sure you want to delete this contact?')) return;
            
            showLoading(true);
            try {
                const contact = CRMApp.contacts.find(c => c.id === contactId);
                await db.collection('contacts').doc(contactId).delete();
                
                await logActivity({
                    type: 'contact_deleted',
                    description: `Deleted contact: ${contact.firstName} ${contact.lastName}`,
                    contactId: contactId,
                    contactName: `${contact.firstName} ${contact.lastName}`
                });
                
                showToast('Contact deleted successfully!');
                await loadInitialData();
            } catch (error) {
                console.error('Error deleting contact:', error);
                showToast('Error deleting contact.', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteAccount(accountId) {
            if (!confirm('Are you sure you want to delete this account? This will also delete all associated contacts.')) return;
            
            showLoading(true);
            try {
                const account = CRMApp.accounts.find(a => a.id === accountId);
                const associatedContacts = CRMApp.contacts.filter(c => c.accountId === accountId);
                
                // Delete associated contacts first
                for (const contact of associatedContacts) {
                    await db.collection('contacts').doc(contact.id).delete();
                }
                
                // Delete account
                await db.collection('accounts').doc(accountId).delete();
                
                await logActivity({
                    type: 'account_deleted',
                    description: `Deleted account: ${account.name} and ${associatedContacts.length} associated contacts`,
                    accountId: accountId,
                    accountName: account.name
                });
                
                showToast('Account and associated contacts deleted successfully!');
                await loadInitialData();
            } catch (error) {
                console.error('Error deleting account:', error);
                showToast('Error deleting account.', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        function renderAccounts() {
            const grid = gId('accounts-grid');
            if (!grid) return;
            grid.innerHTML = '';
            if (CRMApp.accounts.length === 0) {
                grid.innerHTML = '<p class="empty-state">No accounts found. Click "New Account" to get started.</p>';
                return;
            }
            CRMApp.accounts.forEach(account => {
                const card = document.createElement('div');
                card.className = 'account-card';
                card.innerHTML = `
                    <div class="card-header">
                        <div>
                            <div class="card-name">${account.name}</div>
                            <div class="card-subtitle">${account.industry || 'No Industry'}</div>
                        </div>
                        <div class="card-actions">
                            <button class="icon-btn edit-account" data-id="${account.id}" title="Edit Account">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                    <path d="m15 5 4 4"/>
                                </svg>
                            </button>
                            <button class="icon-btn delete-account" data-id="${account.id}" title="Delete Account" style="color: #dc2626;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3,6 5,6 21,6"/>
                                    <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
                                    <line x1="10" y1="11" x2="10" y2="17"/>
                                    <line x1="14" y1="11" x2="14" y2="17"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <p class="card-subtitle">${account.phone || 'No Phone'}</p>
                `;
                card.querySelector('.card-name').addEventListener('click', () => showAccountDetail(account.id));
                card.querySelector('.edit-account').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openAccountModal(account);
                });
                card.querySelector('.delete-account').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteAccount(account.id);
                });
                grid.appendChild(card);
            });
        }

        function renderContacts() {
            const grid = gId('contacts-grid');
            if (!grid) return;
            grid.innerHTML = '';
            if (CRMApp.contacts.length === 0) {
                grid.innerHTML = '<p class="empty-state">No contacts found. Click "New Contact" to get started.</p>';
                return;
            }
            CRMApp.contacts.forEach(contact => {
                const card = document.createElement('div');
                card.className = 'contact-card';
                card.innerHTML = `
                    <div class="card-header">
                        <div>
                            <div class="card-name">${contact.firstName} ${contact.lastName}</div>
                            <div class="card-subtitle">${contact.title || 'No Title'}</div>
                            <div class="card-subtitle">${contact.accountName || 'No Account'}</div>
                        </div>
                        <div class="card-actions">
                            <button class="icon-btn call-prospect" data-id="${contact.id}" title="Call Prospect">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                                </svg>
                            </button>
                            <button class="icon-btn edit-contact" data-id="${contact.id}" title="Edit Contact">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                    <path d="m15 5 4 4"/>
                                </svg>
                            </button>
                            <button class="icon-btn delete-contact" data-id="${contact.id}" title="Delete Contact" style="color: #dc2626;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3,6 5,6 21,6"/>
                                    <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
                                    <line x1="10" y1="11" x2="10" y2="17"/>
                                    <line x1="14" y1="11" x2="14" y2="17"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <p class="card-subtitle">${contact.email || 'No Email'}</p>
                    <p class="card-subtitle">${contact.phone || 'No Phone'}</p>
                `;
                card.querySelector('.card-name').addEventListener('click', () => {
                    if (contact.accountId) {
                        showAccountDetail(contact.accountId);
                    } else {
                        showToast('This contact is not linked to an account.', 'warning');
                    }
                });
                card.querySelector('.edit-contact').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openContactModal(contact);
                });
                card.querySelector('.call-prospect').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openCallsHubWithData(contact.id);
                });
                card.querySelector('.delete-contact').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteContact(contact.id);
                });
                grid.appendChild(card);
            });
        }
        
        function showAccountDetail(accountId) {
            CRMApp.currentAccount = CRMApp.accounts.find(a => a.id === accountId);
            if (!CRMApp.currentAccount) {
                showToast('Account not found.', 'error');
                return;
            }
            showView('account-detail');
        }

        function renderAccountDetail() {
            if (!CRMApp.currentAccount) return;
            const account = CRMApp.currentAccount;
            gId('account-detail-title').textContent = account.name;
            renderAccountInfo(account);
            renderAccountContacts(account.id);
            renderAccountActivities(account.id);
        }

        function renderAccountInfo(account) {
            const display = gId('account-info-display');
            if (!display) return;
            display.innerHTML = '';
            
            const fields = [
                { label: 'Industry', value: account.industry },
                { label: 'Phone', value: account.phone },
                { label: 'Website', value: account.website },
                { label: 'Address', value: account.address },
                { label: 'Pain Points', value: account.painPoints },
                { label: 'Benefits', value: account.benefits },
                { label: 'Created At', value: formatDate(account.createdAt) },
                { label: 'Last Updated', value: formatDate(account.updatedAt) }
            ];
            
            fields.forEach(field => {
                const fieldHtml = `
                    <div class="info-field">
                        <div class="info-field-label">${field.label}</div>
                        <div class="info-field-value">${field.value || 'N/A'}</div>
                    </div>
                `;
                display.innerHTML += fieldHtml;
            });
            
            gId('contract-provider').value = account.contractProvider || '';
            gId('contract-rate').value = account.contractRate || '';
            gId('contract-expiration').value = account.contractExpiration || '';
            gId('contract-type').value = account.contractType || '';
        }

        function renderAccountContacts(accountId) {
            const list = gId('account-contacts-list');
            if (!list) return;
            list.innerHTML = '';
            const accountContacts = CRMApp.contacts.filter(c => c.accountId === accountId);
            if (accountContacts.length === 0) {
                list.innerHTML = '<p class="empty-state">No contacts for this account</p>';
                return;
            }
            accountContacts.forEach(contact => {
                const item = document.createElement('div');
                item.className = 'contact-list-item';
                item.innerHTML = `
                    <div class="contact-info">
                        <div class="contact-name">${contact.firstName} ${contact.lastName}</div>
                        <div class="contact-title">${contact.title || 'No Title'}</div>
                    </div>
                    <div class="card-actions">
                        <button class="icon-btn call-prospect" data-id="${contact.id}" title="Call Prospect">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                            </svg>
                        </button>
                        <button class="icon-btn edit-contact" data-id="${contact.id}" title="Edit Contact">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                <path d="m15 5 4 4"/>
                            </svg>
                        </button>
                    </div>
                `;
                item.querySelector('.call-prospect').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openCallsHubWithData(contact.id);
                });
                item.querySelector('.edit-contact').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openContactModal(contact);
                });
                list.appendChild(item);
            });
        }
        
        function renderAccountActivities(accountId) {
            const list = gId('account-activities-list');
            if (!list) return;
            list.innerHTML = '';
            const accountActivities = CRMApp.activities.filter(a => a.accountId === accountId);
            if (accountActivities.length === 0) {
                list.innerHTML = '<p class="empty-state">No recent activities</p>';
                return;
            }
            accountActivities.forEach(activity => {
                const item = document.createElement('div');
                item.className = 'activity-item';
                item.innerHTML = `
                    <div class="activity-title">${activity.description}</div>
                    <div class="activity-content">${activity.noteContent || ''}</div>
                    <div class="activity-date">Time: ${formatDate(activity.createdAt)}</div>
                `;
                list.appendChild(item);
            });
        }
        
        function setupModals() {
            const accountModal = gId('account-modal');
            const contactModal = gId('contact-modal');
            
            gId('new-account-btn').addEventListener('click', () => openAccountModal());
            gId('add-account-btn').addEventListener('click', () => openAccountModal());
            gId('new-contact-btn').addEventListener('click', () => openContactModal());
            gId('add-contact-btn').addEventListener('click', () => openContactModal());
            gId('edit-account-btn').addEventListener('click', () => openAccountModal(CRMApp.currentAccount));
            gId('close-account-modal').addEventListener('click', () => closeAccountModal());
            gId('cancel-account').addEventListener('click', () => closeAccountModal());
            gId('close-contact-modal').addEventListener('click', () => closeContactModal());
            gId('cancel-contact').addEventListener('click', () => closeContactModal());
            
            accountModal.addEventListener('click', (e) => {
                if (e.target.id === 'account-modal') closeAccountModal();
            });
            contactModal.addEventListener('click', (e) => {
                if (e.target.id === 'contact-modal') closeContactModal();
            });
        }
        
        function openAccountModal(account = null) {
            const modal = gId('account-modal');
            const form = gId('account-form');
            form.reset();
            
            if (account) {
                gId('account-modal-title').textContent = 'Edit Account';
                gId('account-name').value = account.name || '';
                gId('account-industry').value = account.industry || '';
                gId('account-phone').value = account.phone || '';
                gId('account-website').value = account.website || '';
                gId('account-address').value = account.address || '';
                gId('account-pain-points').value = account.painPoints || '';
                gId('account-benefits').value = account.benefits || '';
                CRMApp.currentAccount = account;
            } else {
                gId('account-modal-title').textContent = 'Add New Account';
                CRMApp.currentAccount = null;
            }
            modal.classList.add('active');
        }
        
        function closeAccountModal() {
            gId('account-modal').classList.remove('active');
        }
        
        function openContactModal(contact = null) {
            const modal = gId('contact-modal');
            const form = gId('contact-form');
            form.reset();
            updateContactAccountDropdown();
            
            if (contact) {
                gId('contact-modal-title').textContent = 'Edit Contact';
                gId('contact-first-name').value = contact.firstName || '';
                gId('contact-last-name').value = contact.lastName || '';
                gId('contact-title').value = contact.title || '';
                gId('contact-email').value = contact.email || '';
                gId('contact-phone').value = contact.phone || '';
                gId('contact-notes').value = contact.notes || '';
                gId('contact-account').value = contact.accountId || '';
                CRMApp.currentContact = contact;
            } else {
                gId('contact-modal-title').textContent = 'Add New Contact';
                CRMApp.currentContact = null;
            }
            modal.classList.add('active');
        }
        
        function closeContactModal() {
            gId('contact-modal').classList.remove('active');
        }
        
        function updateContactAccountDropdown() {
            const select = gId('contact-account');
            if (!select) return;
            select.innerHTML = '<option value="">Select an account...</option>';
            CRMApp.accounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account.id;
                option.textContent = account.name;
                select.appendChild(option);
            });
        }
        
        function setupEventListeners() {
            gId('account-form').addEventListener('submit', handleAccountSubmit);
            gId('contact-form').addEventListener('submit', handleContactSubmit);
            gId('back-to-accounts').addEventListener('click', () => showView('accounts'));
            gId('energy-contract-form').addEventListener('submit', handleEnergyContractSubmit);
            gId('save-account-note').addEventListener('click', handleSaveAccountNote);
            gId('bulk-import-btn').addEventListener('click', handleBulkImport);
            gId('quick-add-contact').addEventListener('click', () => openContactModal());
        }

        function handleBulkImport() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.xlsx,.xls';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                showToast('Bulk import functionality would be implemented here. File selected: ' + file.name, 'info');
                // In a real implementation, you would parse the CSV/Excel file and import the data
            };
            input.click();
        }

        async function handleAccountSubmit(e) {
            e.preventDefault();
            showLoading(true);
            const accountId = CRMApp.currentAccount ? CRMApp.currentAccount.id : null;
            const accountData = {
                name: gId('account-name').value,
                industry: gId('account-industry').value,
                phone: gId('account-phone').value,
                website: gId('account-website').value,
                address: gId('account-address').value,
                painPoints: gId('account-pain-points').value,
                benefits: gId('account-benefits').value,
                updatedAt: serverTimestamp()
            };
            
            try {
                if (accountId) {
                    await db.collection('accounts').doc(accountId).update(accountData);
                    showToast('Account updated successfully!');
                    logActivity({
                        type: 'account_updated',
                        description: `Updated account: ${accountData.name}`,
                        accountId: accountId,
                        accountName: accountData.name
                    });
                } else {
                    const newDoc = await db.collection('accounts').add({
                        ...accountData,
                        createdAt: serverTimestamp()
                    });
                    showToast('Account created successfully!');
                    logActivity({
                        type: 'account_created',
                        description: `Created new account: ${accountData.name}`,
                        accountId: newDoc.id,
                        accountName: accountData.name
                    });
                }
                await loadInitialData();
            } catch (error) {
                console.error('Error saving account:', error);
                showToast('Error saving account. See console for details.', 'error');
            } finally {
                closeAccountModal();
                showLoading(false);
            }
        }

        async function handleContactSubmit(e) {
            e.preventDefault();
            showLoading(true);
            const contactId = CRMApp.currentContact ? CRMApp.currentContact.id : null;
            const accountId = gId('contact-account').value;
            const accountName = accountId ? CRMApp.accounts.find(a => a.id === accountId)?.name : 'Unassigned';
            
            const contactData = {
                firstName: gId('contact-first-name').value,
                lastName: gId('contact-last-name').value,
                title: gId('contact-title').value,
                accountId: accountId,
                accountName: accountName,
                email: gId('contact-email').value,
                phone: gId('contact-phone').value,
                notes: gId('contact-notes').value,
                updatedAt: serverTimestamp()
            };
            
            try {
                if (contactId) {
                    await db.collection('contacts').doc(contactId).update(contactData);
                    showToast('Contact updated successfully!');
                    logActivity({
                        type: 'contact_updated',
                        description: `Updated contact: ${contactData.firstName} ${contactData.lastName}`,
                        contactId: contactId,
                        contactName: `${contactData.firstName} ${contactData.lastName}`,
                        accountId: accountId,
                        accountName: accountName
                    });
                } else {
                    const newDoc = await db.collection('contacts').add({
                        ...contactData,
                        createdAt: serverTimestamp()
                    });
                    showToast('Contact created successfully!');
                    logActivity({
                        type: 'contact_created',
                        description: `Created new contact: ${contactData.firstName} ${contactData.lastName}`,
                        contactId: newDoc.id,
                        contactName: `${contactData.firstName} ${contactData.lastName}`,
                        accountId: accountId,
                        accountName: accountName
                    });
                }
                await loadInitialData();
            } catch (error) {
                console.error('Error saving contact:', error);
                showToast('Error saving contact. See console for details.', 'error');
            } finally {
                closeContactModal();
                showLoading(false);
            }
        }
        
        async function handleEnergyContractSubmit(e) {
            e.preventDefault();
            if (!CRMApp.currentAccount) return;
            
            showLoading(true);
            
            const contractData = {
                contractProvider: gId('contract-provider').value,
                contractRate: gId('contract-rate').value,
                contractExpiration: gId('contract-expiration').value,
                contractType: gId('contract-type').value,
                updatedAt: serverTimestamp()
            };
            
            try {
                await db.collection('accounts').doc(CRMApp.currentAccount.id).update(contractData);
                showToast('Energy contract updated successfully!');
                logActivity({
                    type: 'contract_updated',
                    description: `Updated contract for: ${CRMApp.currentAccount.name}`,
                    accountId: CRMApp.currentAccount.id,
                    accountName: CRMApp.currentAccount.name
                });
            } catch (error) {
                console.error('Error saving contract info:', error);
                showToast('Error saving contract info. See console for details.', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function handleSaveAccountNote() {
            if (!CRMApp.currentAccount) return;
            
            const noteContent = gId('account-note-input').value;
            if (!noteContent.trim()) {
                showToast('Note cannot be empty.', 'warning');
                return;
            }
            
            showLoading(true);
            
            try {
                await logActivity({
                    type: 'account_note',
                    description: `Added a note to ${CRMApp.currentAccount.name}`,
                    noteContent: noteContent,
                    accountId: CRMApp.currentAccount.id,
                    accountName: CRMApp.currentAccount.name
                });
                
                showToast('Note saved successfully!');
                gId('account-note-input').value = '';
                await loadInitialData();
            } catch (error) {
                console.error('Error saving note:', error);
                showToast('Error saving note. See console for details.', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function logActivity(activityData) {
            try {
                await db.collection('activities').add({
                    ...activityData,
                    createdAt: serverTimestamp()
                });
            } catch (error) {
                console.error('Error logging activity:', error);
                showToast('Error logging activity. See console for details.', 'error');
            }
        }

        async function openCallsHubWithData(contactId = null) {
            showLoading(true);
            currentProspect = {};
            currentStep = 'start';
            history = [];

            if (contactId) {
                try {
                    const contactDoc = await db.collection('contacts').doc(contactId).get();
                    if (contactDoc.exists) {
                        const contact = contactDoc.data();
                        currentProspect.contactId = contactId;
                        currentProspect.name = `${contact.firstName} ${contact.lastName}`;
                        currentProspect.title = contact.title;
                        currentProspect.phone = contact.phone;
                        currentProspect.email = contact.email;
                        currentProspect.accountId = contact.accountId;
                        
                        if (contact.accountId) {
                            const accountDoc = await db.collection('accounts').doc(contact.accountId).get();
                            if (accountDoc.exists) {
                                const account = accountDoc.data();
                                currentProspect.company = account.name;
                                currentProspect.industry = account.industry;
                                currentProspect.painPoints = account.painPoints;
                                currentProspect.benefits = account.benefits;
                            }
                        }
                        
                        gId('call-notes').value = contact.notes || '';

                    } else {
                        showToast('Contact not found.', 'error');
                    }
                } catch (error) {
                    console.error('Error fetching data for calls hub:', error);
                    showToast('Error fetching contact data.', 'error');
                }
            } else {
                gId('call-notes').value = '';
            }

            showLoading(false);
            showView('calls-hub');
            displayCurrentStep();
        }
    </script>
    </body>
</html>