<!DOCTYPE html>
<html>
<head>
    <title>Twilio Token Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; }
        button { padding: 10px 15px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Twilio Integration Test</h1>
    
    <button onclick="testToken()">Test Token Endpoint</button>
    <button onclick="testSDKLoad()">Test SDK Loading</button>
    <button onclick="testBrowserCall()">Test Browser Call</button>
    
    <div id="results"></div>

    <script src="https://sdk.twilio.com/js/voice/releases/2.11.0/twilio.min.js"></script>
    <script>
        const API_BASE = 'https://power-choosers-crm.vercel.app';
        const results = document.getElementById('results');
        
        function addResult(type, title, content) {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${title}</strong><br>${content}`;
            results.appendChild(div);
        }
        
        async function testToken() {
            try {
                const response = await fetch(`${API_BASE}/api/twilio/token?identity=test-agent`);
                const data = await response.json();
                
                if (response.ok && data.token) {
                    addResult('success', 'Token Test Passed', `Token received: ${data.token.substring(0, 50)}...`);
                    return data.token;
                } else {
                    addResult('error', 'Token Test Failed', `Error: ${JSON.stringify(data)}`);
                    return null;
                }
            } catch (error) {
                addResult('error', 'Token Test Error', error.message);
                return null;
            }
        }
        
        function testSDKLoad() {
            if (typeof Twilio !== 'undefined' && Twilio.Device) {
                addResult('success', 'SDK Test Passed', `Twilio SDK loaded successfully. Version: ${Twilio.version || 'unknown'}`);
                return true;
            } else {
                addResult('error', 'SDK Test Failed', 'Twilio SDK not available');
                return false;
            }
        }
        
        async function testBrowserCall() {
            if (!testSDKLoad()) return;
            
            const token = await testToken();
            if (!token) return;
            
            try {
                const device = new Twilio.Device(token, {
                    codecPreferences: ['opus', 'pcmu'],
                    fakeLocalDTMF: true,
                    enableRingingState: true
                });
                
                device.on('registered', () => {
                    addResult('success', 'Device Registration', 'Twilio device registered successfully');
                });
                
                device.on('error', (error) => {
                    addResult('error', 'Device Error', error.message);
                });
                
                await device.register();
                
                addResult('success', 'Browser Call Test', 'Device ready for calls');
                
            } catch (error) {
                addResult('error', 'Browser Call Test Failed', error.message);
            }
        }
        
        // Auto-run tests
        window.onload = function() {
            setTimeout(testSDKLoad, 500);
            setTimeout(testToken, 1000);
        };
    </script>
</body>
</html>
