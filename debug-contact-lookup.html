<!DOCTYPE html>
<html>
<head>
    <title>Debug Contact Lookup</title>
</head>
<body>
    <h1>Contact Lookup Debug</h1>
    <p>Open browser console (F12) and run the test function</p>
    
    <script>
        // Test function to debug contact lookup
        window.debugContactLookup = async function(phoneNumber) {
            console.log('=== CONTACT LOOKUP DEBUG ===');
            console.log('Testing phone number:', phoneNumber);
            
            // Test phone number normalization
            function normalizePhoneForComparison(phone) {
                if (!phone) return '';
                return phone.replace(/\D/g, '');
            }
            
            function phoneNumbersMatch(phone1, phone2) {
                const clean1 = normalizePhoneForComparison(phone1);
                const clean2 = normalizePhoneForComparison(phone2);
                if (!clean1 || !clean2) return false;
                
                const normalize = (num) => {
                    if (num.length === 11 && num.startsWith('1')) {
                        return num.slice(1);
                    }
                    return num;
                };
                
                return normalize(clean1) === normalize(clean2);
            }
            
            console.log('Normalized phone:', normalizePhoneForComparison(phoneNumber));
            
            // Test Firebase connection
            if (!window.firebaseDB) {
                console.error('‚ùå Firebase DB not available');
                return;
            }
            
            console.log('‚úÖ Firebase DB available');
            
            try {
                // Load contacts
                console.log('Loading contacts...');
                const contactsSnapshot = await window.firebaseDB.collection('contacts').get();
                const contacts = contactsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    name: `${doc.data().firstName || ''} ${doc.data().lastName || ''}`.trim() || 'Unknown Contact'
                }));
                
                console.log(`Found ${contacts.length} contacts:`, contacts);
                
                // Test phone matching
                console.log('\n=== PHONE MATCHING TEST ===');
                for (const contact of contacts) {
                    if (contact.phone) {
                        const matches = phoneNumbersMatch(contact.phone, phoneNumber);
                        console.log(`Contact: ${contact.name}`);
                        console.log(`  Phone: ${contact.phone}`);
                        console.log(`  Normalized: ${normalizePhoneForComparison(contact.phone)}`);
                        console.log(`  Matches: ${matches}`);
                        console.log('---');
                        
                        if (matches) {
                            console.log('üéØ MATCH FOUND:', contact);
                            return contact;
                        }
                    }
                }
                
                // Load accounts
                console.log('Loading accounts...');
                const accountsSnapshot = await window.firebaseDB.collection('accounts').get();
                const accounts = accountsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    name: doc.data().accountName || 'Unknown Account'
                }));
                
                console.log(`Found ${accounts.length} accounts:`, accounts);
                
                // Test account phone matching
                console.log('\n=== ACCOUNT MATCHING TEST ===');
                for (const account of accounts) {
                    if (account.phone) {
                        const matches = phoneNumbersMatch(account.phone, phoneNumber);
                        console.log(`Account: ${account.name}`);
                        console.log(`  Phone: ${account.phone}`);
                        console.log(`  Normalized: ${normalizePhoneForComparison(account.phone)}`);
                        console.log(`  Matches: ${matches}`);
                        console.log('---');
                        
                        if (matches) {
                            console.log('üéØ ACCOUNT MATCH FOUND:', account);
                            return account;
                        }
                    }
                }
                
                console.log('‚ùå No matches found');
                
            } catch (error) {
                console.error('‚ùå Error during lookup:', error);
            }
        };
        
        // Test function for call data
        window.debugCallData = async function() {
            console.log('=== CALL DATA DEBUG ===');
            
            try {
                const base = window.API_BASE_URL ? window.API_BASE_URL.replace(/\/$/, '') : '';
                if (!base) {
                    console.error('‚ùå No API_BASE_URL configured');
                    return;
                }
                
                console.log('API Base URL:', base);
                
                const response = await fetch(`${base}/api/calls`, { method: 'GET' });
                const data = await response.json();
                
                console.log('Calls API Response:', data);
                
                if (data.calls && data.calls.length > 0) {
                    console.log('Recent call data:');
                    data.calls.slice(0, 3).forEach((call, i) => {
                        console.log(`Call ${i + 1}:`, {
                            id: call.id,
                            to: call.to,
                            contactName: call.contactName,
                            contactId: call.contactId,
                            contactType: call.contactType,
                            contactCompany: call.contactCompany
                        });
                    });
                }
                
            } catch (error) {
                console.error('‚ùå Error fetching call data:', error);
            }
        };
        
        console.log('üîß Debug functions loaded!');
        console.log('Run: debugContactLookup("+19728342317") to test contact lookup');
        console.log('Run: debugCallData() to check call data');
    </script>
</body>
</html>
