<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Choosers CRM Dashboard</title>
    <!-- Link to your main CRM stylesheet -->
    <link rel="stylesheet" href="crm-styles.css">
    <!-- Tailwind CSS CDN (if not already part of crm-styles.css or main index.html) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for sound effects in Cold Calling Hub -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <!-- Favicon and Apple Touch Icon -->
    <link rel="icon" href="https://cdn.prod.website-files.com/6801ddaf27d1495f8a02fd3f/68645bd391ea20fecb011c85_2656%20Webclip%20PChoosers.png" type="image/png">
    <link rel="apple-touch-icon" href="https://cdn.prod.website-files.com/6801ddaf27d1495f8a02fd3f/68645bd391ea20fecb011c85_2656%20Webclip%20PChoosers.png">
</head>
<body>
    <div class="app-wrapper">
        <header class="app-header">
            <div class="header-left">
                <div class="app-logo">
                    <img src="https://cdn.prod.website-files.com/6801ddaf27d1495f8a02fd3f/68645bd391ea20fecb011c85_2656%20Webclip%20PChoosers.png" alt="Power Choosers Logo">
                </div>
                <h1 class="app-title">CRM Dashboard</h1>
            </div>
            <div class="header-center">
                <div class="search-bar">
                    <input type="text" id="global-search" placeholder="Search accounts, contacts, or anything...">
                    <button class="search-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="header-right">
                <!-- Call Scripts button will open the new call scripts view -->
                <button class="icon-button" id="call-scripts-btn" title="Call Scripts">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <line x1="10" y1="9" x2="8" y2="9"></line>
                    </svg>
                </button>
                
                <button class="icon-button" id="notification-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    <span class="notification-badge" id="notification-badge">0</span>
                </button>
                
                <div class="user-profile">
                    <div class="profile-avatar" id="profile-avatar">LC</div>
                </div>
            </div>
        </header>

        <main class="app-main">
            <aside class="app-sidebar">
                <nav class="sidebar-nav">
                    <div class="nav-section">
                        <a href="#" class="nav-item active" data-view="dashboard-view">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                            <span>Dashboard</span>
                        </a>
                        <a href="#" class="nav-item" data-view="contacts-view">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            <span>Contacts</span>
                            <span class="nav-badge" id="contacts-badge">0</span>
                        </a>
                        <a href="#" class="nav-item" data-view="accounts-view">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 21h18"></path>
                                <path d="M5 21V7l8-4v18"></path>
                                <path d="M19 21V11l-6-4"></path>
                                <path d="M9 9v1"></path>
                                <path d="M9 12v1"></path>
                                <path d="M9 15v1"></path>
                            </svg>
                            <span>Accounts</span>
                            <span class="nav-badge" id="accounts-badge">0</span>
                        </a>
                    </div>

                    <div class="nav-section">
                        <a href="#" class="nav-item" data-view="calls-view">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                            </svg>
                            <span>Calls</span>
                        </a>
                        <a href="#" class="nav-item" data-view="emails-view">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                <polyline points="22,6 12,13 2,6"></polyline>
                            </svg>
                            <span>Emails</span>
                            <span class="nav-badge" id="emails-badge">0</span>
                        </a>
                        <a href="#" class="nav-item" data-view="tasks-view">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9 11l3 3L22 4"></path>
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                            </svg>
                            <span>Tasks</span>
                            <span class="nav-badge" id="tasks-badge">0</span>
                        </a>
                    </div>
                    
                    <div class="nav-section">
                        <a href="#" class="nav-item" data-view="account-details-view">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            <span>Account Details</span>
                        </a>
                        <a href="#" class="nav-item" data-view="settings-view">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1 0-2.83 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                            </svg>
                            <span>Settings</span>
                        </a>
                    </div>
                </nav>
            </aside>

            <div class="app-content-container">
                <!-- Wrapper for main content area to control flex basis -->
                <div id="main-content-wrapper" class="main-content-wrapper">
                    <!-- Default Dashboard View -->
                    <div id="dashboard-view" class="page-view">
                        <section class="stat-cards-grid">
                            <div class="stat-card">
                                <h2 class="stat-value" id="total-accounts-value">0</h2>
                                <p class="stat-label">Total Accounts</p>
                            </div>
                            <div class="stat-card">
                                <h2 class="stat-value" id="total-contacts-value">0</h2>
                                <p class="stat-label">Total Contacts</p>
                            </div>
                            <div class="stat-card">
                                <h2 class="stat-value" id="recent-activities-value">0</h2>
                                <p class="stat-label">Recent Activities</p>
                            </div>
                            <div class="stat-card">
                                <h2 class="stat-value" id="hot-leads-value">0</h2>
                                <p class="stat-label">Hot Leads</p>
                            </div>
                        </section>

                        <section class="dashboard-card">
                            <h3 class="card-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="20" x2="18" y2="10"></line>
                                    <line x1="12" y1="20" x2="12" y2="4"></line>
                                    <line x1="6" y1="20" x2="6" y2="14"></line>
                                </svg>
                                Texas Electricity Market Trends
                            </h3>
                            <div class="market-pricing-grid">
                                <div class="pricing-card">
                                    <p class="pricing-label">Historical Avg</p>
                                    <p class="pricing-value">8.2¬¢</p>
                                </div>
                                <div class="pricing-card">
                                    <p class="pricing-label">Current Avg</p>
                                    <p class="pricing-value">13.1¬¢</p>
                                </div>
                                <div class="pricing-card">
                                    <p class="pricing-label">Projected 2026</p>
                                    <p class="pricing-value">16.8¬¢</p>
                                </div>
                            </div>
                            <div class="market-insights">
                                <p>üìä Market Intelligence: Supply constraints expected to drive 28% price increase by 2026</p>
                            </div>
                        </section>

                        <section class="dashboard-card">
                                                        <h3 class="card-title card-title-flex">
                                <span class="card-title-inner-flex">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z"></path>
                                        <path d="M12 6v6l4 2"></path>
                                    </svg>
                                    Recent Activities
                                </span>
                                <div class="activity-navigation">
                                    <button class="nav-btn" id="activity-prev-btn" title="Previous Activity">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="15 18 9 12 15 6"></polyline>
                                        </svg>
                                    </button>
                                    <button class="nav-btn" id="activity-next-btn" title="Next Activity">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="9 18 15 12 9 6"></polyline>
                                        </svg>
                                    </button>
                                </div>
                            </h3>
                            <div class="activity-list-container">
                                <div class="activity-list-wrapper" id="activity-list-wrapper"></div>
                            </div>
                        </section>
                    </div>

                    <!-- Other CRM Views (Contacts, Accounts, etc.) -->
                    <div id="contacts-view" class="page-view"></div>
                    <div id="accounts-view" class="page-view"></div>
                    <div id="calls-view" class="page-view"></div>
                    <div id="emails-view" class="page-view"></div>
                    <div id="tasks-view" class="page-view"></div>
                    <div id="account-details-view" class="page-view"></div>
                    <div id="settings-view" class="page-view"></div>
                    
                    <!-- Cold Calling Script View (main content part) -->
                    <div id="call-scripts-view" class="page-view call-scripts-layout-main">
                        <h2 class="text-2xl font-bold mb-6 text-white text-center">Cold Calling Script</h2>
                        <div class="calls-hub-main-inner">
                            <div class="script-display p-6" id="script-display">
                                Click 'Dial' to begin the call
                            </div>
                            <div class="response-buttons mt-6" id="responses-container">
                                <button class="dial-button" onclick="handleDialClick()">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                                    Dial
                                </button>
                            </div>
                            <div class="calls-hub-footer">
                                <button id="back-btn" class="action-btn" onclick="goBack()" disabled>‚Üê Back</button>
                                <button id="restart-btn" class="restart-btn-icon" onclick="restart()">
                                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path d="M21.5 13a9.5 9.5 0 1 1-9.5-9.5V3a.5.5 0 0 0-1 0v.5A9.5 9.5 0 1 1 21.5 13zM12 2v4M12 18v4M22 12h-4M6 12H2M18 18l-3-3M18 6l-3 3M6 18l3-3M6 6l3 3" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Widget Panel -->
                <aside id="widget-panel" class="widget-panel">
                    <!-- Default CRM Widgets Container (initially visible) -->
                    <div id="crm-widgets-container" class="crm-widgets-container">
                        <section class="widget-card">
                            <h3 class="card-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                                </svg>
                                Quick Actions
                            </h3>
                            <div class="quick-actions-grid">
                                <a href="#" class="action-button" onclick="addAccount()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M3 21h18"></path>
                                        <path d="M5 21V7l8-4v18"></path>
                                        <path d="M19 21V11l-6-4"></path>
                                        <path d="M9 9v1"></path>
                                        <path d="M9 12v1"></path>
                                        <path d="M9 15v1"></path>
                                    </svg>
                                    Add Account
                                </a>
                                <a href="#" class="action-button" onclick="addContact()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="8.5" cy="7" r="4"></circle>
                                        <line x1="20" y1="8" x2="20" y2="14"></line>
                                        <line x1="23" y1="11" x2="17" y2="11"></line>
                                    </svg>
                                    Add Contact
                                </a>
                                <a href="#" class="action-button" onclick="bulkImport()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                    Bulk Import
                                </a>
                            </div>
                        </section>

                        <section class="widget-card">
                            <h3 class="card-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <line x1="10" y1="9" x2="8" y2="9"></line>
                                </svg>
                                Today's Tasks
                            </h3>
                            <ul class="tasks-list" id="tasks-list"></ul>
                        </section>

                        <section class="widget-card">
                            <h3 class="card-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2z"></path>
                                    <path d="M14 2v6h6"></path>
                                    <path d="M6 12h8"></path>
                                    <path d="M6 16h8"></path>
                                </svg>
                                Energy News
                            </h3>
                            <div class="news-feed" id="news-feed"></div>
                        </section>
                    </div>

                    <!-- Cold Calling Widgets Container (initially hidden) -->
                    <div id="cold-calling-widgets-container" class="calls-hub-sidebar">
                        <!-- Prospect Information Widget -->
                        <div class="sidebar-card">
                            <h3 class="sidebar-card-title">üìã Prospect Info</h3>
                            <div class="sidebar-input-group">
                                <label for="input-phone">Phone Number:</label>
                                <input type="text" id="input-phone" placeholder="(555) 555-5555" oninput="updateScript()">
                            </div>
                            <div class="sidebar-input-group">
                                <label for="input-company-name">Company Name:</label>
                                <input type="text" id="input-company-name" placeholder="ABC Manufacturing" oninput="updateScript()">
                            </div>
                            <div class="sidebar-input-group">
                                <label for="input-name">Contact Name:</label>
                                <input type="text" id="input-name" placeholder="John Smith" oninput="updateScript()">
                            </div>
                            <div class="sidebar-input-group">
                                <label for="input-title">Contact Title:</label>
                                <input type="text" id="input-title" placeholder="Company Leader" oninput="updateScript()">
                            </div>
                            <div class="sidebar-input-group">
                                <label for="input-company-industry">Company Industry:</label>
                                <input type="text" id="input-company-industry" placeholder="businesses" oninput="updateScript()">
                            </div>
                            <div class="sidebar-input-group">
                                <label for="input-benefit">Specific Benefit:</label>
                                <input type="text" id="input-benefit" placeholder="a strategic procurement strategy" oninput="updateScript()">
                            </div>
                            <div class="sidebar-input-group">
                                <label for="input-pain">Pain Point:</label>
                                <input type="text" id="input-pain" placeholder="you're not stuck paying more" oninput="updateScript()">
                            </div>
                        </div>

                        <!-- Energy Health Check Widget -->
                        <div class="sidebar-card !p-4" style="height: max-content;">
                            <h3 class="sidebar-card-title">üìâ Energy Health Check</h3>
                            <div class="calculator-wrapper !p-6" id="calculator-wrapper">
                                <div class="form-sections">
                                    <div class="form-section active" id="section1">
                                        <div class="section-header">
                                            <span class="section-header-pill">
                                                <span class="section-icon">1</span> Current Bill
                                            </span>
                                        </div>
                                        <div class="grid grid-cols-1 gap-4">
                                            <div class="input-group">
                                                <label for="currentSupplier" class="input-label text-xs">Current Supplier</label>
                                                <input type="text" class="form-input !p-2 !text-sm" id="currentSupplier" placeholder="e.g., TXU" list="supplierList" oninput="validateSection1()">
                                                <datalist id="supplierList"></datalist>
                                            </div>
                                            <div class="input-group">
                                                <label for="monthlyBill" class="input-label text-xs">Monthly Bill ($)</label>
                                                <input type="number" class="form-input !p-2 !text-sm" id="monthlyBill" placeholder="e.g., 1,450.00" step="0.01" oninput="validateSection1()">
                                            </div>
                                            <div class="input-group">
                                                <label for="currentRate" class="input-label text-xs">Current Rate ($/kWh)</label>
                                                <input type="number" class="form-input !p-2 !text-sm" id="currentRate" placeholder="e.g., 0.062" step="0.001" oninput="validateSection1()">
                                                <div id="rateFeedback" class="input-feedback text-xs"></div>
                                            </div>
                                        </div>
                                        <div id="usageDisplay" class="usage-display !p-3 mt-3 hidden">
                                            <div class="usage-title text-sm">üìä Client's Usage Analysis</div>
                                            <div class="usage-details text-xs" id="usageDetails"></div>
                                        </div>
                                    </div>
                                    <div class="mt-6"></div> <!-- Padding between steps -->
                                    <div class="form-section" id="section2">
                                        <div class="section-header">
                                            <span class="section-header-pill">
                                                <span class="section-icon">2</span> Contract & Sell Rate
                                            </span>
                                        </div>
                                        <div class="grid grid-cols-1 gap-4">
                                            <div class="input-group">
                                                <label for="contractEndDate" class="input-label text-xs">Contract End Date</label>
                                                <input type="text" class="form-input !p-2 !text-sm" id="contractEndDate" placeholder="YYYY-MM-DD" onfocus="openDatePicker()">
                                            </div>
                                            <div class="input-group">
                                                <label for="sellRate" class="input-label text-xs">Sell Rate ($/kWh)</label>
                                                <input type="number" class="form-input !p-2 !text-sm" id="sellRate" placeholder="e.g., 0.088" step="0.001" oninput="validateSection2()">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-6"></div> <!-- Padding between steps -->
                                    <div class="form-section" id="section3">
                                        <div class="section-header">
                                            <span class="section-header-pill">
                                                <span class="section-icon">3</span> Get Results
                                            </span>
                                        </div>
                                        <p class="text-sm text-gray-400 text-center">Ready to see the analysis!</p>
                                    </div>
                                </div>
                                <button class="calculate-button w-full !p-3 !text-sm !font-bold mt-4" id="calculateBtn" onclick="runCalculation()">
                                    Complete All Sections Above
                                </button>
                                <button class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors mt-2 text-sm" id="resetBtn" onclick="resetForm()">
                                  Reset Form
                                </button>
                                <div id="loadingAnimation" class="loading-animation">
                                    <div class="spinner"></div>
                                    <div class="text-gray-400 mt-4 text-sm" id="loadingMessage">Running analysis...</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Call Notes Widget -->
                        <div class="sidebar-card">
                            <h3 class="sidebar-card-title">üìù Call Notes</h3>
                            <div class="sidebar-input-group">
                                <textarea id="call-notes" placeholder="Type your call notes here..."></textarea>
                            </div>
                            <div class="sidebar-actions">
                                <button class="add-notes-btn" onclick="saveProspectAndNotes()">Save Notes</button>
                                <button class="clear-btn" onclick="clearNotes()">Clear</button>
                            </div>
                        </div>

                        <!-- Call Strategy Tips Widget -->
                        <div class="sidebar-card">
                            <h3 class="sidebar-card-title">üí° Call Strategy Tips</h3>
                            <ul class="text-sm text-gray-300 space-y-3">
                                <li class="list-item">
                                    <strong class="text-white">Mirror their energy:</strong> Match their speaking pace and enthusiasm.
                                </li>
                                <li class="list-item">
                                    <strong class="text-white">Use their name:</strong> Say their name 2-3 times during the call to maintain a personal connection.
                                </li>
                                <li class="list-item">
                                    <strong class="text-white">Pause power:</strong> Use 2-3 second pauses after questions to let them process and respond.
                                </li>
                                <li class="list-item">
                                    <strong class="text-white">Assume the close:</strong> When scheduling, offer two specific times rather than an open-ended "when works?".
                                </li>
                            </ul>
                        </div>
                        
                        <!-- Objection Responses Widget -->
                        <div class="sidebar-card">
                            <h3 class="sidebar-card-title">üõ°Ô∏è Quick Objection Responses</h3>
                            <div class="text-sm space-y-4">
                                <div class="p-3 bg-gray-900 rounded-lg border border-gray-700">
                                    <p class="font-semibold text-white">"We're happy with our provider."</p>
                                    <p class="text-gray-400 mt-1">"That's great to hear. This isn't about changing providers; it's about optimizing your position within the current market structure."</p>
                                </div>
                                <div class="p-3 bg-gray-900 rounded-lg border border-gray-700">
                                    <p class="font-semibold text-white">"We just renewed our contract."</p>
                                    <p class="text-gray-400 mt-1">"Perfect timing, actually. This gives us a chance to prepare strategically for your next cycle rather than scrambling later."</p>
                                </div>
                                <div class="p-3 bg-gray-900 rounded-lg border border-gray-700">
                                    <p class="font-semibold text-white">"Send me some information."</p>
                                    <p class="text-gray-400 mt-1">"I can definitely do that. What specific information would be most valuable to you - a rate comparison or market timing strategies?"</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </main>

        <div id="add-account-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Add New Account</h3>
                    <p class="modal-subtitle">Enter the company details below.</p>
                </div>
                <form id="add-account-form">
                    <div class="form-group">
                        <label for="account-name" class="form-label">Company Name *</label>
                        <input type="text" id="account-name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="account-industry" class="form-label">Industry</label>
                        <input type="text" id="account-industry" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="account-phone" class="form-label">Phone</label>
                        <input type="tel" id="account-phone" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="account-website" class="form-label">Website</label>
                        <input type="url" id="account-website" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="account-address" class="form-label">Address</label>
                        <input type="text" id="account-address" class="form-input">
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('add-account-modal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Account</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="add-contact-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Add New Contact</h3>
                    <p class="modal-subtitle">Enter the contact details below.</p>
                </div>
                <form id="add-contact-form">
                    <div class="form-group">
                        <label for="contact-first-name" class="form-label">First Name *</label>
                        <input type="text" id="contact-first-name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="contact-last-name" class="form-label">Last Name</label>
                        <input type="text" id="contact-last-name" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="contact-email" class="form-label">Email</label>
                        <input type="email" id="contact-email" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="contact-phone" class="form-label">Phone</label>
                        <input type="tel" id="contact-phone" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="contact-title" class="form-label">Job Title</label>
                        <input type="text" id="contact-title" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="contact-account" class="form-label">Account</label>
                        <select id="contact-account" class="form-input">
                            <option value="">Select an account</option>
                        </select>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('add-contact-modal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Contact</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="bulk-import-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Bulk Import from CSV</h3>
                    <p class="modal-subtitle">Upload a CSV file to import contacts or accounts.</p>
                </div>
                <form id="bulk-import-form">
                    <div class="form-group">
                        <label for="import-type" class="form-label">Import Type *</label>
                        <select id="import-type" class="form-input" required>
                            <option value="contacts">Contacts</option>
                            <option value="accounts">Accounts</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="csv-file" class="form-label">Select CSV File *</label>
                        <input type="file" id="csv-file" class="form-input" accept=".csv" required>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('bulk-import-modal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Import</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="notification-dropdown" id="notification-dropdown">
            <div class="notification-header">
                <h3 class="notification-title">Notifications</h3>
                <span class="notification-count" id="notification-count">0</span>
            </div>
            <ul class="notification-list" id="notification-list"></ul>
        </div>
    </div>

    <div id="taskModal" class="modal" onclick="closeModal(event)">
      <div class="modal-content">
        <div class="modal-card-container">
          <div class="modal-card" id="dateCard">
            <h3 class="text-lg font-semibold text-white mb-4">Select Contract End Date</h3>
            <div class="calendar-header">
                <button onclick="prevMonth()" class="text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M15 19l-7-7 7-7"/></svg>
                </button>
                <div class="flex-grow flex justify-center items-center">
                    <div id="monthYearDisplay">
                        <span id="monthYearSpan" class="text-white font-semibold cursor-pointer" onclick="toggleMonthYearPicker()"></span>
                    </div>
                    <div id="monthYearPicker" class="flex justify-center items-center hidden">
                        <select id="monthSelector" class="form-input w-2/5 mr-2" onchange="selectMonthYear()"></select>
                        <select id="yearSelector" class="form-input w-2/5 ml-2" onchange="selectMonthYear()"></select>
                    </div>
                </div>
                <button onclick="nextMonth()" class="text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M9 5l7 7-7 7"/></svg>
                </button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
            <button onclick="closeModal(event)" class="mt-6 w-full px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors" id="cancel-btn">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <!-- Firebase App (required for Firestore) -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <!-- Firebase Firestore (required for database operations) -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    
    <!-- Your Firebase configuration file -->
    <script src="firebase-config.js"></script>
    <!-- Your main CRM application logic -->
    <script src="crm-app.js"></script>

    <!-- Cold Calling Hub Specific JavaScript (now embedded directly) -->
    <script>
        // This script block contains the logic for the Cold Calling Hub,
        // which was previously in call-scripts-content.html.
        // It's now embedded here and initialized by CRMApp.

        function initializeColdCallingHub() {
            // JavaScript for the cold calling script logic
            const CRMApp = window.CRMApp; // Make CRMApp globally accessible within this script

            // State Machine for the call script flow.
            const scriptData = {
                start: {
                    you: "Click 'Dial' to begin the call",
                    mood: "neutral",
                    responses: []
                },
                dialing: {
                    you: "Dialing... Ringing...",
                    mood: "neutral",
                    responses: [
                        { text: "üìû Call Connected", next: "hook" },
                        { text: "üìû Transferred - Decision Maker Answers", next: "main_script_start" },
                        { text: "üö´ No Answer", next: "voicemail_or_hangup" }
                    ]
                },
                voicemail_or_hangup: {
                    you: "No answer. What would you like to do?",
                    mood: "neutral",
                    responses: [
                        { text: "Leave Voicemail", next: "voicemail", disposition: "Left Voicemail" },
                        { text: "Hang Up / Start New Call", next: "start", disposition: "No Answer / Hang Up" }
                    ]
                },
                hook: {
                    you: "Hi, is this <span class='emphasis'>[N]</span>?",
                    mood: "neutral",
                    responses: [
                        { text: "‚úÖ Yes, this is [N]", next: "main_script_start", disposition: "Connected" },
                        { text: "üó£Ô∏è Speaking", next: "main_script_start", disposition: "Connected" },
                        { text: "‚ùì Who's calling?", next: "main_script_start", disposition: "Connected" },
                        { text: "üë• Gatekeeper / Not the right person", next: "gatekeeper_intro", disposition: "Gatekeeper" }
                    ]
                },
                main_script_start: {
                    you: "Good mornin'/afternoon, <span class='emphasis'>[N]</span>. <span class='pause'>--</span> I'm Lewis with PowerChoosers and I'm needin' to speak with someone over electricity agreements and contracts for <span class='emphasis'>[CN]</span>. <span class='highlight-yellow'>Would that be yourself?</span>",
                    mood: "neutral",
                    responses: [
                        { text: "‚úÖ Yes, that's me / I handle that", next: "pathA", disposition: "Decision Maker - Engaged" },
                        { text: "üë• That would be [OP] / Not the right person", next: "gatekeeper_intro", disposition: "Gatekeeper" },
                        { text: "ü§ù We both handle it / Team decision", next: "pathA", disposition: "Decision Maker - Engaged" },
                        { text: "ü§î Unsure or hesitant", next: "pathD", disposition: "Decision Maker - Hesitant" }
                    ]
                },
                gatekeeper_intro: {
                    you: "Good afternoon/morning. I'm needin' to speak with someone over electricity agreements and contracts for <span class='emphasis'>[CN]</span>. <span class='highlight-yellow'>Do you know who would be responsible for that?</span>",
                    mood: "neutral",
                    responses: [
                        { text: "‚ùì What's this about?", next: "gatekeeper_whats_about", disposition: "Gatekeeper - Asking" },
                        { text: "üîó I'll connect you", next: "transfer_dialing", disposition: "Gatekeeper - Transferring" },
                        { text: "üö´ They're not available / Take a message", next: "voicemail", disposition: "Gatekeeper - Take Message" }
                    ]
                },
                gatekeeper_whats_about: {
                    you: "My name is Lewis with PowerChoosers.com and I'm needin' to speak with someone about the future electricity agreements for <span class='emphasis'>[CN]</span>. <span class='highlight-yellow'>Do you know who might be the best person for that?</span>",
                    mood: "neutral",
                    responses: [
                        { text: "üîó I'll connect you", next: "transfer_dialing", disposition: "Gatekeeper - Transferring" },
                        { text: "üö´ They're not available / Take a message", next: "voicemail", disposition: "Gatekeeper - Take Message" },
                        { text: "‚úÖ I can help you", next: "pathA", disposition: "Gatekeeper - Connected" }
                    ]
                },
                voicemail: {
                    you: "Good afternoon/morning <span class='emphasis'>[N]</span>, this is <span class='emphasis'>Lewis</span> and I was told to speak with you. You can give me a call at <span class='emphasis'>817-409-4215</span>. Also, I shot you over a short email kinda explaining why I'm reaching out to you today. The email should be coming from <span class='emphasis'>Lewis Patterson</span> that's <span class='emphasis'>(L.E.W.I.S)</span>. Thank you so much and you have a great day.",
                    mood: "neutral",
                    responses: [
                        { text: "üîÑ End Call / Start New Call", next: "start", action: "saveProspectAndNotes" }
                    ]
                },
                pathA: {
                    you: "Perfect. <span class='pause'>--</span> So, <span class='emphasis'>[N]</span>, I've been working closely with <span class='emphasis'>[CI]</span> across Texas with electricity agreements, and we're about to see an <span class='emphasis'>unprecedented dip in the market in the next few months</span>. <span class='pause'>--</span> <span class='highlight-yellow'>Is getting the best price for your next renewal a priority for you and [CN]?</span> <span class='highlight-yellow'>Do you know when your contract expires?</span>",
                    mood: "neutral",
                    responses: [
                        { text: "üò∞ Struggling / It's tough", next: "discovery", disposition: "Discovery - Struggle" },
                        { text: "üìÖ Haven't renewed / Contract not up yet", next: "discovery", disposition: "Discovery - Not Renewed" },
                        { text: "üîí Locked in / Just renewed", next: "discovery", disposition: "Discovery - Locked In" },
                        { text: "üõí Shopping around / Looking at options", next: "discovery", disposition: "Discovery - Shopping" },
                        { text: "ü§ù Have someone handling it / Work with broker", next: "discovery", disposition: "Discovery - Has Broker" },
                        { text: "ü§∑ Haven't thought about it / It is what it is", next: "discovery", disposition: "Discovery - No Plan" }
                    ]
                },
                discovery: {
                    you: "Gotcha! So, <span class='emphasis'>[N]</span>, just so I understand your situation a little better. <span class='pause'>--</span> <span class='highlight-yellow'>What's your current approach to renewing your electricity agreements? Do you handle it internally or work with a consultant?</span>",
                    mood: "neutral",
                    responses: [
                        { text: "üíö Prospect is engaged / ready for appointment", next: "closeForAppointment", disposition: "Interested - Ready for Appointment" },
                        { text: "üü° Prospect is hesitant / needs more info", next: "handleHesitation", disposition: "Hesitant - Needs More Info" },
                        { text: "‚ùå Objection: Happy with current provider", next: "objHappy", disposition: "Objection - Happy with Provider" },
                        { text: "‚ùå Objection: No time", next: "objNoTime", disposition: "Objection - No Time" }
                    ]
                },
                closeForAppointment: {
                    you: "Awesome! So, <span class='emphasis'>[N]</span>. <span class='pause'>--</span> I really believe you'll be able to benefit from <span class='emphasis'>[SB]</span> that way you won't have to <span class='emphasis'>[PP]</span>. Our process is super simple! We start with an <span class='emphasis'>energy health check</span> where I look at your usage, contract terms, and then we can talk about what options might look like for <span class='emphasis'>[CN]</span> moving forward.",
                    mood: "positive",
                    responses: [
                        { text: "üìÖ Schedule Friday 11 AM", next: "callSuccess", disposition: "Appointment Set - Fri 11 AM" },
                        { text: "üìÖ Schedule Monday 2 PM", next: "callSuccess", disposition: "Appointment Set - Mon 2 PM" },
                        { text: "ü§î Still hesitant", next: "handleHesitation", disposition: "Hesitant - Still Unsure" }
                    ]
                },
                handleHesitation: {
                    you: "I get it <span class='pause'>--</span> and called you out of the blue, so now is probably not the best time. How about this <span class='pause'>--</span> let me put together a quick case study specific to <span class='emphasis'>[TIA]</span>s in your area.",
                    mood: "unsure",
                    responses: [
                        { text: "‚úÖ Yes, send analysis", next: "callSuccess", disposition: "Sent Analysis" },
                        { text: "‚ùå No, not interested", next: "softClose", disposition: "Not Interested" }
                    ]
                },
                objHappy: {
                    you: "That's actually great to hear, and I'm not suggesting you should be unhappy or you need to switch your supplier today. <span class='highlight-yellow'>Is it the customer service that you're happy with or are you just getting a rate that you can't find anywhere else?</span>",
                    mood: "positive",
                    responses: [
                        { text: "‚úÖ Yes, worth understanding", next: "closeForAppointment", disposition: "Open to discussion" },
                        { text: "‚ùå No, not interested", next: "softClose", disposition: "Not Interested" }
                    ]
                },
                objNoTime: {
                    you: "I completely get it <span class='pause'>--</span> that's exactly why most businesses end up overpaying. Energy is a complicated market that requires ongoing attention that most internal teams <span class='pause'>--</span> simply don't have time for.",
                    mood: "challenging",
                    responses: [
                        { text: "‚úÖ Yes, schedule 10-minute assessment", next: "callSuccess", disposition: "Appointment Set - Short Call" },
                        { text: "‚ùå Still no time", next: "softClose", disposition: "No Time - Declined" }
                    ]
                },
                softClose: {
                    you: "No problem at all <span class='pause'>--</span> I know energy strategy isn't urgent until it becomes critical. Here's what I'll do: I'm going to add you to my quarterly market intelligence updates.",
                    mood: "neutral",
                    responses: [
                        { text: "‚úÖ That sounds reasonable", next: "callSuccess", disposition: "Opt-in to updates" },
                        { text: "‚ùå No thanks", next: "callEnd", disposition: "Opt-out / Cold" }
                    ]
                },
                callSuccess: {
                    you: "üéâ <span class='emphasis'>Call Completed Successfully!</span><br><br>Remember to track:<br>‚Ä¢ Decision maker level<br>‚Ä¢ Current contract status<br>‚Ä¢ Pain points identified<br>‚Ä¢ Interest level<br>‚Ä¢ Next action committed",
                    mood: "positive",
                    responses: [{ text: "üîÑ Start New Call", next: "start", action: "saveProspectAndNotes" }]
                },
                callEnd: {
                    you: "Thanks for your time. Have a great day!",
                    mood: "neutral",
                    responses: [{ text: "üîÑ Start New Call", next: "start", action: "saveProspectAndNotes" }]
                },
                // New state for gatekeeper transfer
                transfer_dialing: {
                    you: "Connecting... Ringing...",
                    mood: "neutral",
                    responses: [
                        { text: "üìû Call Connected", next: "hook", disposition: "Transferred - Connected" },
                        { text: "üö´ Not Connected", next: "voicemail", disposition: "Transferred - Not Connected" }
                    ]
                }
            };

            // Global state for the application
            const appState = {
                placeholders: {
                    'N': '', 'YN': 'Lewis', 'CN': '', 'CI': '', 'SB': '', 'PP': '', 'CT': '', 'TIA': '',
                    'TE': '', 'DT': '', 'EAC': '', 'TF': '', 'OP': 'the responsible party', 'XX': '$XX.00/40%', 'P': ''
                },
                inputMap: {
                    'input-name': 'N',
                    'input-title': 'CT',
                    'input-company-name': 'CN',
                    'input-company-industry': 'CI',
                    'input-benefit': 'SB',
                    'input-pain': 'PP',
                    'input-phone': 'P'
                },
                currentStep: 'start',
                history: []
            };
            
            let callActive = false;
            let callTimeout;
            let currentDisposition = "";
            const callRingingSound = new Tone.MembraneSynth().toDestination();
            
            // Helper function to get an element by ID
            const getEl = id => document.getElementById(id);

            /**
             * Updates the script display with the current text, replacing placeholders.
             * Renders response buttons for the current step.
             */
            const displayCurrentStep = () => {
                const step = scriptData[appState.currentStep];
                if (!step) return;
                
                const scriptDisplay = getEl('script-display');
                const responsesContainer = getEl('responses-container');
                const backBtn = getEl('back-btn');
                
                const processedText = applyPlaceholders(step.you);
                
                if (scriptDisplay) {
                    scriptDisplay.innerHTML = processedText;
                    scriptDisplay.className = `script-display mood-${step.mood}`;
                    // Special case for 'start' screen to center the text
                    if (appState.currentStep === 'start') {
                        scriptDisplay.classList.add('start');
                    } else {
                        scriptDisplay.classList.remove('start');
                    }
                }
                
                if (responsesContainer) {
                    responsesContainer.innerHTML = '';
                    if (appState.currentStep === 'start') {
                        // Render the main "Dial" button for the start screen
                        const dialButtonHtml = `
                            <button class="dial-button" onclick="handleDialClick()">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                                Dial
                            </button>
                        `;
                        responsesContainer.innerHTML = dialButtonHtml;
                    } else if (step.responses && step.responses.length > 0) {
                        // Render response buttons for the current step
                        step.responses.forEach(response => {
                            const button = document.createElement('button');
                            button.className = 'response-btn';
                            button.innerHTML = applyPlaceholders(response.text);
                            button.onclick = () => {
                                if (response.disposition) {
                                    currentDisposition = response.disposition;
                                }
                                selectResponse(response.next, response.action);
                            };
                            responsesContainer.appendChild(button);
                        });
                        
                        // Adjust grid layout for a single button or more
                        if (step.responses.length === 1) {
                            responsesContainer.classList.add('full-width');
                        } else {
                            responsesContainer.classList.remove('full-width');
                        }
                    }
                }
                
                if (backBtn) {
                    backBtn.disabled = appState.history.length === 0;
                }
            };

            /**
             * Replaces placeholders in the script text with values from the state.
             * @param {string} text - The text string containing placeholders.
             * @returns {string} The text with placeholders replaced.
             */
            const applyPlaceholders = (text) => {
                let newText = text;
                for (const key in appState.placeholders) {
                    const regex = new RegExp('\\[' + key + '\\]', 'g');
                    let replacement = appState.placeholders[key];
                    
                    // Special case: Only use the first name for the [N] placeholder
                    if (key === 'N' && replacement) {
                        replacement = replacement.split(' ')[0];
                    }
                    
                    newText = newText.replace(regex, replacement);
                }
                return newText;
            };

            /**
             * Updates the global placeholders from the input fields and refreshes the script.
             */
            const updateScript = () => {
                for (const inputId in appState.inputMap) {
                    const placeholderKey = appState.inputMap[inputId];
                    const inputElement = getEl(inputId);
                    if (inputElement) {
                        const inputValue = inputElement.value || '';
                        appState.placeholders[placeholderKey] = inputValue;
                    }
                }
                // Alias for Company Industry
                appState.placeholders['TIA'] = appState.placeholders['CI'];
                displayCurrentStep();
            };

            /**
             * Handles the click event for the "Dial" button.
             * Simulates a call and transitions to the 'dialing' state.
             */
            const handleDialClick = () => {
                const phoneNumber = getEl('input-phone').value;
                if (!phoneNumber) {
                    CRMApp.showToast('Please enter a phone number to dial.', 'error');
                    return;
                }

                // Start the simulated ringing
                callActive = true;
                getEl('script-display').classList.add('ringing');
                
                // Tone.js sound effect for ringing
                callRingingSound.triggerAttackRelease("C4", "3s");
                
                // After 3 seconds, simulate a connection
                callTimeout = setTimeout(() => {
                    callActive = false;
                    callRingingSound.triggerRelease();
                    getEl('script-display').classList.remove('ringing');
                    selectResponse('dialing');
                }, 3000);
            };
            
            /**
             * Adds a digit from the dialpad to the phone number input field.
             * @param {string} digit - The digit or character to add.
             */
            const dialpadInput = (digit) => {
                const phoneInput = getEl('input-phone');
                if (phoneInput) {
                    phoneInput.value += digit;
                    updateScript();
                }
            };

            /**
             * Handles a user selecting a response button.
             * Pushes the current step to history and navigates to the next step.
             * @param {string} nextStep - The key for the next step in `scriptData`.
             * @param {string} action - An optional action to perform, e.g., 'save'.
             */
            const selectResponse = (nextStep, action) => {
                if (nextStep && scriptData[nextStep]) {
                    appState.history.push(appState.currentStep);
                    appState.currentStep = nextStep;
                    displayCurrentStep();
                }
                if (action === 'saveProspectAndNotes') {
                    saveProspectAndNotes();
                }
            };

            /**
             * Navigates back to the previous step in the call history.
             */
            const goBack = () => {
                if (appState.history.length > 0) {
                    appState.currentStep = appState.history.pop();
                    displayCurrentStep();
                }
            };

            /**
             * Resets the entire call script and state to the initial values.
             */
            const restart = () => {
                appState.currentStep = 'start';
                appState.history = [];
                currentDisposition = "";
                
                // Clear all input fields
                for(const inputId in appState.inputMap) {
                    const input = getEl(inputId);
                    if (input) input.value = '';
                }
                // Clear the call notes
                getEl('call-notes').value = '';

                updateScript();
            };

            /**
             * Saves the prospect info and call notes to the CRM via CRMApp.
             */
            const saveProspectAndNotes = () => {
                const notes = getEl('call-notes').value;
                const disposition = currentDisposition || "Call Ended - No Disposition";
                const companyName = getEl('input-company-name').value;
                const contactName = getEl('input-name').value;
                const phoneNumber = getEl('input-phone').value;
                const contactTitle = getEl('input-title').value;

                const log = {
                    disposition: disposition,
                    notes: notes,
                    prospect: {
                        name: contactName,
                        company: companyName,
                        phone: phoneNumber,
                        title: contactTitle
                    },
                    timestamp: new Date().toISOString()
                };

                CRMApp.saveCallLog(log, disposition); // Call the CRMApp function
                
                // Reset for the next call
                restart();
            };
            
            /**
             * Clears the call notes textarea.
             */
            const clearNotes = () => {
                getEl('call-notes').value = '';
            };

            // Energy Health Check widget code
            const supplierData = {
              "NRG": { bbbRating: "A+", popularity: 4, customerService: 3 },
              "TXU": { bbbRating: "A+", popularity: 5, customerService: 4 },
              "APG & E": { bbbRating: "Unaccredited", popularity: 2, customerService: 3 },
              "Reliant": { bbbRating: "A+", popularity: 5, customerService: 3 },
              "Hudson": { bbbRating: "Unaccredited", popularity: 2, customerService: 2 },
              "Green Mountain": { bbbRating: "Unaccredited", popularity: 3, customerService: 2 },
              "Constellation": { bbbRating: "A+", popularity: 4, customerService: 4 },
              "Tara Energy": { bbbRating: "Unaccredited", popularity: 2, customerService: 3 },
              "Cirro": { bbbRating: "A+", popularity: 3, customerService: 4 },
              "Engie": { bbbRating: "A+", popularity: 3, customerService: 1 },
              "Gexa": { bbbRating: "Unaccredited", popularity: 4, customerService: 2 },
              "Freepoint": { bbbRating: "A+", popularity: 1, customerService: 3 },
              "Shell Energy": { bbbRating: "Unaccredited", popularity: 3, customerService: 2 },
              "Ironhorse": { bbbRating: "4.0 stars", popularity: 1, customerService: 3 }, // Note: Ironhorse has a Powertochoose.org rating, not a standard BBB rating.
              "Ammper Power": { bbbRating: "Unaccredited", popularity: 1, customerService: 1 }
            };
            const supplierNames = Object.keys(supplierData);

            const ESTIMATED_DELIVERY_CHARGE_CENTS = 0.05;
            let section1Complete = false, section2Complete = false;
            let currentAnnualUsage = 0, currentMonthlyBill = 0, currentRate = 0, sellRate = 0, currentSupplier = '';
            let currentDate = new Date(), selectedDate = null;
            const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
            
            const formatNumber = num => Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            const updateProgress = () => {
                const progress = getEl('progressFill');
                if (!progress) return; // Add check to prevent error
                
                let percentage = 0;
                if (section1Complete) percentage += 50;
                if (section2Complete) percentage += 50;
                progress.style.width = percentage + '%';
            };
            
            function validateSection1() {
                const supplierInput = getEl('currentSupplier');
                const monthlyBillInput = getEl('monthlyBill');
                const currentRateInput = getEl('currentRate');
                
                const supplierValue = supplierInput.value.trim();
                currentMonthlyBill = parseFloat(monthlyBillInput.value);
                currentRate = parseFloat(currentRateInput.value);
                
                const rateFeedback = getEl('rateFeedback');
                const usageDisplay = getEl('usageDisplay');
                const usageDetails = getEl('usageDetails');

                rateFeedback.classList.remove('show', 'feedback-danger', 'feedback-warning', 'feedback-success', 'feedback-info');
                usageDisplay.classList.add('hidden');
                
                // Check if all fields are filled with valid data
                if (supplierValue && supplierNames.includes(supplierValue) && currentMonthlyBill > 0 && currentRate > 0) {
                    currentSupplier = supplierValue;
                    const effectiveCurrentRateAllIn = currentRate + ESTIMATED_DELIVERY_CHARGE_CENTS;
                    rateFeedback.classList.add('show');
                    if (effectiveCurrentRateAllIn <= 0.10) { rateFeedback.className = 'input-feedback show feedback-danger'; rateFeedback.textContent = 'üö® Very old rate - significant increase expected at renewal'; }
                    else if (effectiveCurrentRateAllIn <= 0.12) { rateFeedback.className = 'input-feedback show feedback-warning'; rateFeedback.textContent = '‚ö†Ô∏è Below market rate - likely increase ahead'; }
                    else if (effectiveCurrentRateAllIn <= 0.145) { rateFeedback.className = 'input-feedback show feedback-success'; rateFeedback.textContent = '‚úÖ Current market range - competitive rate'; }
                    else { rateFeedback.className = 'input-feedback show feedback-info'; rateFeedback.textContent = 'üí∞ Above market - savings opportunity available'; }
                    
                    const monthlyUsage = (currentMonthlyBill / effectiveCurrentRateAllIn);
                    currentAnnualUsage = monthlyUsage * 12;
                    usageDisplay.classList.remove('hidden');
                    let businessSize = (currentAnnualUsage < 50000) ? 'Small Business' : (currentAnnualUsage < 200000) ? 'Medium Business' : 'Large Business';
                    usageDetails.innerHTML = `<strong>Monthly Usage:</strong> ${formatNumber(monthlyUsage)} kWh<br><strong>Annual Usage:</strong> ${formatNumber(currentAnnualUsage)} kWh<br><strong>Business Size:</strong> ${businessSize}`;
                    
                    section1Complete = true;
                    getEl('section1').classList.add('completed');
                    getEl('section1').querySelector('.section-header-pill').classList.add('completed');
                    getEl('section1').querySelector('.section-icon').innerHTML = '‚úì';
                    activateSection(2);
                } else {
                    section1Complete = false;
                    getEl('section1').classList.remove('completed');
                    getEl('section1').querySelector('.section-header-pill').classList.remove('completed');
                    getEl('section1').querySelector('.section-icon').innerHTML = '1';
                    
                    // Also reset the next section if this one is not complete
                    getEl('section2').classList.remove('active', 'completed');
                    getEl('section2').querySelector('.section-header-pill').classList.remove('active', 'completed');
                    getEl('section2').querySelector('.section-icon').innerHTML = '2';
                    getEl('section3').classList.remove('active', 'completed');
                    getEl('section3').querySelector('.section-header-pill').classList.remove('active', 'completed');
                    getEl('section3').querySelector('.section-icon').innerHTML = '3';
                    section2Complete = false;
                }
                updateProgress();
                updateButton();
            }

            function validateSection2() {
                const contractEndDateInput = getEl('contractEndDate');
                const sellRateInput = getEl('sellRate');
                const contractEndDate = contractEndDateInput.value;
                sellRate = parseFloat(sellRateInput.value);
                
                // Check if all fields are filled with valid data
                if (contractEndDate && sellRate > 0) {
                    section2Complete = true;
                    getEl('section2').classList.add('completed');
                    getEl('section2').querySelector('.section-header-pill').classList.add('completed');
                    getEl('section2').querySelector('.section-icon').innerHTML = '‚úì';
                    activateSection(3);
                } else {
                    section2Complete = false;
                    getEl('section2').classList.remove('completed');
                    getEl('section2').querySelector('.section-header-pill').classList.remove('completed');
                    getEl('section2').querySelector('.section-header-pill').classList.add('active');
                    getEl('section2').querySelector('.section-icon').innerHTML = '2';

                    // Reset the next section if this one is not complete
                    getEl('section3').classList.remove('active', 'completed');
                    getEl('section3').querySelector('.section-header-pill').classList.remove('active', 'completed');
                    getEl('section3').querySelector('.section-icon').innerHTML = '3';
                }
                updateProgress();
                updateButton();
            }

            function activateSection(sectionNumber) {
                for (let i = 1; i <= 3; i++) {
                    const section = getEl(`section${i}`);
                    const pill = section.querySelector('.section-header-pill');
                    const icon = pill.querySelector('.section-icon');
                    if (i < sectionNumber) {
                        section.classList.remove('active');
                        section.classList.add('completed');
                        pill.classList.remove('active');
                        pill.classList.add('completed');
                        icon.innerHTML = '‚úì';
                    } else if (i === sectionNumber) {
                        section.classList.add('active');
                        section.classList.remove('completed');
                        pill.classList.add('active');
                        pill.classList.remove('completed');
                        icon.innerHTML = i;
                    } else {
                        section.classList.remove('active', 'completed');
                        pill.classList.remove('active', 'completed');
                        icon.innerHTML = i;
                    }
                }
            }

            const updateButton = () => {
                const button = getEl('calculateBtn');
                const isReady = section1Complete && section2Complete;
                button.classList.toggle('ready', isReady);
                button.textContent = isReady ? 'Calculate Savings Potential' : 'Complete All Sections Above';
            };

            const runCalculation = () => {
                if (!section1Complete || !section2Complete || !isFinite(currentMonthlyBill) || !isFinite(currentRate) || !isFinite(sellRate) || !supplierNames.includes(currentSupplier)) {
                  console.warn("Attempted to calculate results before all sections were complete or with invalid data.");
                  CRMApp.showToast("Please complete all sections with valid data to run the health check.", "warning");
                  return;
                }
                
                getEl('calculateBtn').style.display = 'none';
                getEl('loadingAnimation').classList.add('show');
                getEl('loadingMessage').textContent = 'Running analysis...';
                getEl('calculator-wrapper').classList.add('is-calculating');
                setTimeout(calculateResults, 1500);
            };

            function calculateResults() {
                try {
                    const contractEndDateStr = getEl('contractEndDate').value;
                    const effectiveSellRateAllIn = sellRate + ESTIMATED_DELIVERY_CHARGE_CENTS;
                    const annualCurrentCost = currentMonthlyBill * 12;
                    const annualProjectedCost = (currentAnnualUsage * effectiveSellRateAllIn);
                    const annualSavingsOrIncrease = annualCurrentCost - annualProjectedCost;
                    const monthlySavingsOrIncrease = annualSavingsOrIncrease / 12;
                    const percentageChange = ((annualSavingsOrIncrease / annualCurrentCost) * 100).toFixed(2);
                    
                    const currentSupplierData = supplierData[currentSupplier] || { bbbRating: 'N/A', popularity: 1, customerService: 1 };
                    
                    // Calculate Energy Health Score
                    // Score is a weighted combination of savings potential and supplier quality
                    // Savings factor: (percentageChange + 100) / 2 (normalizes to 0-100)
                    // Supplier factor: (popularity + customerService) / 10 * 100 (normalizes to 0-100, based on max score of 5 for each)
                    const savingsFactor = Math.min(Math.max((percentageChange + 100), 0), 200) / 2;
                    const supplierFactor = ((currentSupplierData.popularity || 1) + (currentSupplierData.customerService || 1)) / 10 * 100;
                    const energyHealthScore = Math.round((savingsFactor * 0.7) + (supplierFactor * 0.3));

                    let actionableTips = '';
                    const today = new Date();
                    const contractEndDate = new Date(contractEndDateStr);
                    const monthsUntilExpiration = (contractEndDate.getFullYear() - today.getFullYear()) * 12 + (contractEndDate.getMonth() - today.getMonth());
                    
                    const formatTips = (title, tips) => `<h4 class="text-green-500 text-sm font-bold mb-2">${title}</h4><ul class="list-disc list-inside space-y-1 text-gray-400 text-xs">${tips.map(t => `<li><strong>${t.bold}:</strong> ${t.text}</li>`).join('')}</ul>`;
                    
                    // New logic based on user's rules
                    const isSummer = today.getMonth() >= 5 && today.getMonth() <= 7; // June, July, August
                    const tolerancePercentage = 0.5;

                    if (monthsUntilExpiration > 36) { // > 3 years
                        if (percentageChange > 40) {
                            actionableTips = formatTips('Consider Cancelling for Major Savings:', [{ bold: 'Significant Savings', text: 'With savings over 40%, it may be worth cancelling your current agreement. Review the terms for any penalties.' }]);
                        } else {
                            actionableTips = formatTips('No Action Needed:', [{ bold: 'Stable Contract', text: 'Your contract expires far in the future. Monitor the market, but no immediate action is necessary.' }]);
                        }
                    } else if (monthsUntilExpiration >= 6 && monthsUntilExpiration <= 12) { // 6 months to 1 year
                        if (isSummer && percentageChange > 15) {
                            actionableTips = formatTips('Optimal Renewal Time (Summer Savings):', [{ bold: 'Summer Opportunity', text: 'This is a high-rate season, but your potential savings of over 15% make it an ideal time to renew and lock in a good rate.' }]);
                        } else if (!isSummer && annualSavingsOrIncrease > 0) {
                            actionableTips = formatTips('Optimal Renewal Time:', [{ bold: 'Proactive Renewal', text: 'Your contract is approaching its renewal window. Secure a new plan now to lock in savings and avoid market fluctuations.' }]);
                        } else {
                             actionableTips = formatTips('Monitor Market Closely:', [{ bold: 'Strategic Planning', text: 'Your contract is nearing its end. Keep an eye on market trends to find the best rate before your renewal date.' }]);
                        }
                    } else { // All other cases
                        let idealMonths = monthsUntilExpiration + 6;
                        let renewalYear = new Date(contractEndDateStr);
                        renewalYear.setMonth(renewalYear.getMonth() - 6);
                        
                        if (percentageChange < -30 && monthsUntilExpiration < 12) {
                             actionableTips = formatTips('High-Risk Renewal Alert:', [{ bold: 'Act Now for Best Rates', text: `You are facing a potential rate increase of over 30%. Consider reserving a new price in advance to lock in a more favorable rate before your contract ends.` }]);
                        } else if (percentageChange < -30 && monthsUntilExpiration >= 12) {
                            actionableTips = formatTips('High-Risk Renewal Alert:', [{ bold: 'Plan Ahead for Best Rates', text: `You are facing a potential rate increase of over 30%. We recommend starting the process around ${monthNames[renewalYear.getMonth()]} of ${renewalYear.getFullYear()} to reserve a price in advance.` }]);
                        }
                        else {
                            actionableTips = formatTips('General Advice:', [{ bold: 'Strategic Planning is Key', text: `Based on your contract end date, it's important to have a plan in place. Start monitoring rates to be ready when the time comes to renew.` }]);
                        }
                    }

                    const resultsSection = document.createElement('div');
                    resultsSection.id = 'results';
                    resultsSection.className = 'results-section show p-6 mt-6 rounded-xl border';

                    let resultAmountClass = '', resultLabelText = '', mainResultClass = '';
                    if (annualSavingsOrIncrease > (annualCurrentCost * (tolerancePercentage / 100))) {
                        resultAmountClass = 'text-green-500'; mainResultClass = 'savings'; resultLabelText = 'Potential Annual Client Savings';
                    } else if (annualSavingsOrIncrease < -(annualCurrentCost * (tolerancePercentage / 100))) {
                        resultAmountClass = 'text-red-500'; mainResultClass = 'increase'; resultLabelText = 'Projected Annual Increase Risk';
                    } else {
                        resultAmountClass = 'text-white'; mainResultClass = 'neutral'; resultLabelText = 'No Significant Change Projected';
                    }
                    
                    resultsSection.innerHTML = `
                        <div class="main-result ${mainResultClass} p-4 rounded-xl border-2 mb-4">
                            <div class="text-3xl font-bold ${resultAmountClass}">$${formatNumber(Math.abs(annualSavingsOrIncrease))}</div>
                            <div class="text-sm font-semibold text-white mt-1">${resultLabelText}</div>
                        </div>
                        <div class="details-grid grid grid-cols-2 gap-4 text-center text-sm mb-4">
                            <div class="detail-item p-3 rounded-lg bg-gray-700">
                                <div class="text-white font-bold">${energyHealthScore}%</div>
                                <div class="text-gray-400 text-xs">Energy Health Score</div>
                            </div>
                            <div class="detail-item p-3 rounded-lg bg-gray-700">
                                <div class="text-white font-bold">${currentSupplierData.bbbRating}</div>
                                <div class="text-gray-400 text-xs">Supplier BBB Rating</div>
                            </div>
                            <div class="detail-item p-3 rounded-lg bg-gray-700 col-span-2">
                               <div class="text-white font-bold">$${formatNumber(Math.abs(monthlySavingsOrIncrease))}</div>
                               <div class="text-gray-400 text-xs">${resultLabelText.replace('Annual', 'Monthly')}</div>
                            </div>
                        </div>
                        <div class="analysis-box p-4 rounded-xl border-l-4 border-blue-500 bg-gray-700">
                            <div class="analysis-title flex items-center text-blue-500 text-sm font-semibold mb-2">
                                <span class="mr-2">üí°</span> Recommended Next Steps
                            </div>
                            <div class="analysis-text text-xs text-gray-400">${actionableTips}</div>
                        </div>`;
                    
                    const existingResults = getEl('results');
                    if (existingResults) existingResults.remove();
                    getEl('calculator-wrapper').appendChild(resultsSection);
                    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

                    // Call CRMApp to update account details
                    const companyName = getEl('input-company-name').value;
                    const updatedAccountData = {
                        currentSupplier: currentSupplier,
                        monthlyBill: currentMonthlyBill,
                        currentRate: currentRate,
                        contractEndDate: contractEndDateStr,
                        sellRate: sellRate,
                        annualSavingsOrIncrease: annualSavingsOrIncrease,
                        energyHealthScore: energyHealthScore
                    };
                    CRMApp.updateAccountDetailsFromHealthCheck(companyName, updatedAccountData);

                } catch (error) {
                    console.error("An error occurred during calculation:", error);
                    CRMApp.showToast("An error occurred during calculation. Please check inputs.", "error");
                } finally {
                    // Ensure the loading state is always reset
                    getEl('loadingAnimation').classList.remove('show');
                    getEl('calculateBtn').style.display = 'block';
                    getEl('calculator-wrapper').classList.remove('is-calculating');
                }
            }

            const openDatePicker = () => {
                const modal = getEl('taskModal');
                if(modal) {
                    modal.classList.add('open');
                    renderCalendar();
                }
            };

            const closeModal = (event) => {
                const modal = getEl('taskModal');
                // Only close the modal if the click is on the background or a cancel button
                if (event.target === modal || event.target.id === 'cancel-btn') {
                    modal.classList.remove('open');
                }
            };

            const resetForm = () => {
                // Reset all form inputs and state
                getEl('currentSupplier').value = '';
                getEl('monthlyBill').value = '';
                getEl('currentRate').value = '';
                getEl('sellRate').value = '';
                getEl('contractEndDate').value = '';
                getEl('usageDisplay').classList.add('hidden');
                getEl('rateFeedback').classList.remove('show');
                const results = getEl('results');
                if(results) results.remove();
                
                // Reset state variables
                section1Complete = false;
                section2Complete = false;

                // Reset UI to initial state
                activateSection(1);
                updateButton();
            };

            const renderCalendar = () => {
                const [monthYearSpan, calendarGrid] = [getEl('monthYearSpan'), getEl('calendarGrid')];
                const [year, month] = [currentDate.getFullYear(), currentDate.getMonth()];
                
                const monthYearPicker = getEl('monthYearPicker');
                const display = getEl('monthYearDisplay');
                
                display.classList.remove('hidden');
                monthYearPicker.classList.add('hidden');

                calendarGrid.innerHTML = '';
                monthYearSpan.textContent = `${monthNames[month]} ${year}`;
                
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                daysOfWeek.forEach(day => { const dayHeader = document.createElement('div'); dayHeader.className = 'calendar-day'; dayHeader.textContent = day; calendarGrid.appendChild(dayHeader); });
                for (let i = 0; i < firstDay; i++) calendarGrid.innerHTML += '<div></div>';
                for (let i = 1; i <= daysInMonth; i++) {
                    const dateElement = document.createElement('div');
                    dateElement.className = 'calendar-date';
                    dateElement.textContent = i;
                    const fullDate = new Date(year, month, i);
                    if (fullDate.toDateString() === new Date().toDateString()) dateElement.classList.add('today');
                    dateElement.onclick = () => {
                        document.querySelectorAll('.calendar-date').forEach(d => d.classList.remove('selected'));
                        dateElement.classList.add('selected');
                        selectedDate = fullDate;
                        getEl('contractEndDate').value = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                        // Directly close the modal and run the validation
                        getEl('taskModal').classList.remove('open');
                        validateSection2();
                    };
                    calendarGrid.appendChild(dateElement);
                }
            };

            const toggleMonthYearPicker = () => {
                const picker = getEl('monthYearPicker');
                const calendarGrid = getEl('calendarGrid');
                const monthYearSpan = getEl('monthYearSpan');

                const isPickerVisible = picker.classList.contains('hidden');

                if (isPickerVisible) {
                    picker.classList.remove('hidden');
                    calendarGrid.classList.add('hidden');
                    monthYearSpan.classList.add('hidden');

                    // Populate selectors with current date
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    const monthSelector = getEl('monthSelector');
                    const yearSelector = getEl('yearSelector');
                    monthSelector.innerHTML = monthNames.map((name, index) => `<option value="${index}" ${index === month ? 'selected' : ''}>${name}</option>`).join('');
                    
                    const currentYear = new Date().getFullYear();
                    yearSelector.innerHTML = '';
                    for (let y = currentYear - 5; y <= currentYear + 10; y++) {
                        yearSelector.innerHTML += `<option value="${y}" ${y === year ? 'selected' : ''}>${y}</option>`;
                    }

                } else {
                    picker.classList.add('hidden');
                    calendarGrid.classList.remove('hidden');
                    monthYearSpan.classList.remove('hidden');
                }
            };

            const selectMonthYear = () => {
                const month = getEl('monthSelector').value;
                const year = getEl('yearSelector').value;
                currentDate.setMonth(month);
                currentDate.setFullYear(year);
                renderCalendar();
                toggleMonthYearPicker();
            }

            // Expose functions to the global scope so CRMApp can call them
            window.handleDialClick = handleDialClick;
            window.selectResponse = selectResponse;
            window.goBack = goBack;
            window.restart = restart;
            window.saveProspectAndNotes = saveProspectAndNotes;
            window.clearNotes = clearNotes;
            window.dialpadInput = dialpadInput;
            window.updateScript = updateScript; // Expose for CRMApp to call
            window.validateSection1 = validateSection1; // Expose for CRMApp to call
            window.validateSection2 = validateSection2; // Expose for CRMApp to call
            window.runCalculation = runCalculation; // Expose for CRMApp to call
            window.resetForm = resetForm; // Expose for CRMApp to call
            window.openDatePicker = openDatePicker; // Expose for CRMApp to call
            window.closeModal = closeModal; // Expose for CRMApp to call
            window.activateSection = activateSection; // Expose for CRMApp to call
            window.updateButton = updateButton; // Expose for CRMApp to call

            // Energy Health Check Widget initialization
            activateSection(1);
            updateButton(); 
            // Automatically set the datalist for suppliers
            const datalist = getEl('supplierList');
            supplierNames.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier;
                datalist.appendChild(option);
            });
        }
    </script>
</body>
</html>
